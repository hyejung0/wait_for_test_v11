---
title: "Landmark Analysis - find out patterns of missing"
subtitle: "version 1"
author: "Hyejung Lee <hyejung.lee@utah.edu>"
date: "`r format(Sys.time(), '%a %b %d, %Y %X')`"
always_allow_html: true
output:
  bookdown::github_document2:
    toc: true
    toc_depth: 4
    html_preview: true
  # bookdown::html_document2:
  #   # keep_md: true
  #   self-contained: true
  #   embed-resources: true
  #   code-fold: true
  #   toc: true
  #   toc_depth: 4
  #   theme: united
  #   toc_float: true
  #   number-sections: true
  # word_document:
  #   toc: true
  #   toc_depth: 3
  #   number_sections: true
# bibliography: references.bib
# csl: nature.csl
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{r include=FALSE}
knitr::opts_chunk$set(
  echo=FALSE,
  cache      = TRUE,
  cache.lazy = FALSE,   # turn *off* the lazy‚Äêload DB
  cache.path = "missing_pattern_cache/", # where to put your .rds files
  fig.path   = "missing_pattern_files/"
)

# knitr::knit_hooks$set(chunk = function(x, options) x) #for knitting word_document only

# remotes::install_github('yihui/knitr')
# library(knitr)
library(VIM)
library(ggplot2)
library(grid)
library(gridExtra)
library(survival)
library(survminer)
library(officer)
library(officedown)
library(flextable)
library(data.table)
library(parallel)
library(kableExtra)
library(knitr)
library(lubridate)
library(tictoc)
library(gt)
library(gtsummary)
library(tidyverse)
library(DiagrammeR)
library(DiagrammeRsvg)
library(rsvg)






ncores<-strtoi(Sys.getenv("SLURM_NTASKS")) #Pick up -ntasks or --n from the environment
setDTthreads(threads = ncores)

```

```{r pattern-missing-data}
#| echo: false
#| eval: false


#generate data set for identifying patterns of missing
#don't run it in the "knit" because I've already run and 
#saved items as RDS file.

#Read in the data 
ptData_missing<-readRDS("../ptData_time0_diag_v2.rds")
ptData_missing[,advDiag_to_death_weeks:=as.numeric(interval(AdvancedDiagnosisDate,DateOfDeath),"weeks")]
ptData_missing[,advDiag_to_valid_PDL1_week:=as.numeric(interval(AdvancedDiagnosisDate,earliest_valid_ResultDate__on_after_time0_PDL1),"weeks")]
ptData_missing[,advDiag_to_valid_gene_week:=as.numeric(interval(AdvancedDiagnosisDate,earliest_valid_ResultDate__on_after_time0_NoPDL1),"weeks")]
ptData_missing[,advDiag_to_valid_test_week:=pmin(advDiag_to_valid_PDL1_week,advDiag_to_valid_gene_week,na.rm = T)]
ptData_missing[,advDiag_to_1L_week:=as.numeric(interval(AdvancedDiagnosisDate,StartDate),"weeks")]





#Time 0 is 5th week
ptData_missing[,time0:=NULL]
ptData_missing[,time0:=as.IDate(as.Date(AdvancedDiagnosisDate)+weeks(4))]
ptData_missing[,.(AdvancedDiagnosisDate,time0)]

#Now treatment assignment.
ptData_missing[,cohort:="wait"]
ptData_missing[advDiag_to_1L_week<advDiag_to_valid_test_week,cohort:="no_wait"]
ptData_missing[,cohort:=factor(cohort,levels=c("wait","no_wait"), labels=c("wait","no_wait"))]


#generate yearly count of advanced diagnosis date
ptData_missing[,AdvancedDiagnosis_year:=year(AdvancedDiagnosisDate)]
ptData_missing[,AdvancedDiagnosis_year_factor:=factor(AdvancedDiagnosis_year,levels = sort(unique(AdvancedDiagnosis_year), decreasing = F), labels = sort(unique(AdvancedDiagnosis_year), decreasing = F))]

# ptData1[,min(AdvancedDiagnosis_year)] #2011
ptData_missing[,AdvancedDiagnosis_year_rescale:=AdvancedDiagnosis_year-min(AdvancedDiagnosis_year)] #make first one 0.





#Choose the variables that Wally had previously identified for me


lab<-readRDS("../../labs/raw_lab.rds")
vars<-readRDS("../../labs/baseline_covariates.rds")
lab_vars<-unique(vars$variables)

#Exclude carbon dioxide as it changes too frequently.
lab_vars<-lab_vars[lab_vars!="Carbon dioxide"]




lab_values_out<-
lapply(lab_vars,function(this_vars){

  #there can be several different baselines we want to use,
  #choose only one here.
  #set the character string that corresponds to the column name.
  this.baseline<-"AdvancedDiagnosisDate"


  #save the rows we want to use
  this_Test<-vars[variables==this_vars,unique(Test)]

  #Save the subdat
  temp<-lab[Test %in% this_Test,]

  #remove all invalid dataset
  temp<-temp[!is.na(TestResultCleaned) & TestUnitsCleaned!="",]


  #subset the data to what we need.
  these.cols<-c("PatientID",this.baseline)
  temp<-merge.data.table(ptData_missing[,..these.cols],
                         temp[,.(PatientID,TestDate,TestUnitsCleaned,TestResultCleaned)],
                         by="PatientID",
                         all.x=TRUE,
                         allow.cartesian=TRUE)

  setnames(temp, this.baseline,"time0")
  ### Entry Criteria - start ###
  #For baseline value, time windows are:
  #(-12 weeks,4 weeks]
  #(-12 weeks,1 week]
  #We will keep 7 days in a week. 
  #But we will also week 30 days a month. 
  #12*7 = 84 days 

  #generate two
  baseline_dat<-copy(temp)
  baseline_dat[,min_date:=as.IDate(as.Date(time0)- days(84))]

  #two different cut off for the baseline
  #Up to 4 weeks after
  #Up to 1 week after
  #Baseline up to 1 week after:
  bdat1<-copy(baseline_dat)
  bdat1[,max_date:=as.IDate(as.Date(time0)+ days(7)- days(1))]

  #Baseline up to 4 weeks after:
  bdat4<-copy(baseline_dat)
  bdat4[,max_date:=as.IDate(as.Date(time0)+ days(28)- days(1))]

  #Save them as a list
  baseline_dat_list<-list(
    "week1"=bdat1,
    "week4"=bdat4
  )

  baseline_dat_list<-
    lapply(baseline_dat_list,function(baseline_dat){
      #Extract only those that are within this time frame
      baseline_dat<-baseline_dat[min_date<=TestDate & max_date>=TestDate,]
      baseline_dat<-baseline_dat[,days_to_time0:=time0-TestDate]
      baseline_dat
    })

baseline_dat_list
})
names(lab_values_out)<-lab_vars

#ECOG
baselineECOG<-readRDS("../../../Data/BaselineECOG.rds")
baselineECOG<-baselineECOG[PatientID %in% ptData_missing$PatientID,]
baselineECOG[ECOGValue=="Unknown",ECOGValue:=NA]
baselineECOG[,ECOGValue:=as.integer(ECOGValue)]
setnames(baselineECOG,"ECOGValue","EcogValue")
setnames(baselineECOG,"ECOGDate","Date")
baselineECOG[,Date:=as.IDate(Date)]


ECOG<-readRDS("../../../Data/ECOG.rds")
ECOG<-ECOG[PatientID %in% ptData_missing$PatientID,]
setnames(ECOG,"EcogDate","Date")
ECOG<-unique(ECOG[,.(PatientID,Date,EcogValue)])
ECOG[,N:=.N,by=.(PatientID,Date)]
ECOG[N>1,] #We will take average
ECOG2<-ECOG[,mean(as.numeric(EcogValue),na.rm=T),by=.(PatientID,Date)]
ECOG2
setnames(ECOG2,"V1","EcogValue")

#get them merged
both_ECOG<-
  merge(unique(baselineECOG[,.(PatientID,Date,EcogValue)]),
        ECOG2[,.(PatientID,Date,EcogValue)],
        by=c("PatientID","Date"),
        all=T)
both_ECOG[,EcogValue.x:=as.numeric(EcogValue.x)]
both_ECOG[is.na(EcogValue.x),EcogValue.x:=EcogValue.y]
both_ECOG[,EcogValue.y:=NULL]
setnames(both_ECOG,"EcogValue.x","EcogValue")
rm(list=c("baselineECOG","ECOG"))
both_ECOG
#Average if more than 1 observed
# both_ECOG<-both_ECOG[,mean(EcogValue, na.rm=T),by=.(PatientID,Date)]

temp<-merge.data.table(ptData_missing[,.(PatientID,AdvancedDiagnosisDate)],
                         both_ECOG,
                         by="PatientID",
                         all.x=TRUE,
                         allow.cartesian=TRUE)


#For baseline value, time windows are:
#(-4 months,4 weeks]
#(-4 months,1 week]
#Keeping 7 days a week, 30 days a month,
#So let's stick to 30*4 = 120 days. 

#generate two
ECOG_tmp<-copy(temp)
ECOG_tmp[,min_date:=as.IDate(as.Date(AdvancedDiagnosisDate) - days(120))]
# ECOG_tmp[,min_date:=as.IDate(as.Date(AdvancedDiagnosisDate)%m-% months(4))]

#two different cut off for the baseline
#Up to 4 weeks after: 28 days 
#Up to 1 week after: 7 days
#Baseline up to 1 week after:
bdat1<-copy(ECOG_tmp)
bdat1[,max_date:=as.IDate(as.Date(AdvancedDiagnosisDate)+ days(7)- days(1))]

#Baseline up to 4 weeks after:
bdat4<-copy(ECOG_tmp)
bdat4[,max_date:=as.IDate(as.Date(AdvancedDiagnosisDate)+ days(28)- days(1))]

#Save them as a list
baseline_dat_list<-list(
  "week1"=bdat1,
  "week4"=bdat4
)

  baseline_dat_list<-
    lapply(baseline_dat_list,function(baseline_dat){
      #Extract only those that are within this time frame
      baseline_dat<-baseline_dat[min_date<=Date & max_date>=Date,]
      baseline_dat<-baseline_dat[,days_to_time0:=AdvancedDiagnosisDate-Date]
      baseline_dat
    })
ECOG<-copy(baseline_dat_list)



#Weight change


#Get baseline weight
vital<-readRDS("../../../Data/Vitals.rds")
vital<-vital[PatientID %in% ptData_missing$PatientID,]

#How many people have weight?
count_weight<-vital[,sum(Test=="body weight"),by=PatientID]
count_weight[,sum(V1==0)]
#224 people have 0 weight. very small number of people. Good.
weight<-vital[Test=="body weight",]

#Want to use kg
#Is there any missing?
weight[is.na(TestResult) & !is.na(TestResultCleaned),.N]
weight[!is.na(TestResult) & is.na(TestResultCleaned),.N]
weight[!is.na(TestResult) & is.na(TestResultCleaned),]
weight[!is.na(TestResult) & is.na(TestResultCleaned),.(TestResult,TestUnits,TestResultCleaned,TestUnitsCleaned)]
#All of TestResult are missing units.
#Just use TestResultCleaned.


#remove all invalid dataset
temp<-weight[!is.na(TestResultCleaned) & TestUnitsCleaned!="",]
temp<-temp[,mean(TestResultCleaned,na.rm=T),by=.(PatientID,TestDate)] #average out if we have more than one observed.
setnames(temp,"V1","TestResultCleaned")
#subset the data to what we need.
temp<-merge.data.table(ptData_missing[,.(PatientID,AdvancedDiagnosisDate)],
                       temp[,.(PatientID,TestDate,TestResultCleaned)],
                       by="PatientID",
                       all.x=TRUE,
                       allow.cartesian=TRUE)

#1 year prior to 1 week or 4 weeks after.
#1 year prior is 30 days * 12 months = 360 days
weight_tmp<-copy(temp)
weight_tmp[,min_date:=as.IDate(as.Date(AdvancedDiagnosisDate) - days(360))]

#two different cut off for the baseline
#Up to 4 weeks after
#Up to 1 week after
#Baseline up to 1 week after:
bdat1<-copy(weight_tmp)
bdat1[,max_date:=as.IDate(as.Date(AdvancedDiagnosisDate)+ days(7)- days(1))]

#Baseline up to 4 weeks after:
bdat4<-copy(weight_tmp)
bdat4[,max_date:=as.IDate(as.Date(AdvancedDiagnosisDate)+ days(28)- days(1))]

#Save them as a list
baseline_dat_list<-list(
    "week1"=bdat1,
    "week4"=bdat4
  )

baseline_dat_list<-
    lapply(baseline_dat_list,function(baseline_dat){
      #Extract only those that are within this time frame
      baseline_dat<-baseline_dat[min_date<=TestDate & max_date>=TestDate,]
      baseline_dat<-baseline_dat[,days_to_time0:=AdvancedDiagnosisDate-TestDate]
      baseline_dat
    })
Weight<-copy(baseline_dat_list)
#Average out if more than one is observed.


rm(baseline_dat_list)
rm(weight_tmp)
rm(ECOG_tmp)

saveRDS(Weight, "Weight_pattern_missing.rds")
saveRDS(lab_values_out, "lab_values_out_pattern_missing.rds")
saveRDS(ECOG, "ECOG_pattern_missing.rds")

Weight<-readRDS("Weight_pattern_missing.rds")
lab_values_out<-readRDS("lab_values_out_pattern_missing.rds")
ECOG<-readRDS("ECOG_pattern_missing.rds")

#For each variable, store 12 weeks observation be fore advanced diagnosis date
#and 1 week or 4 weeks after.
all_obs<-ptData_missing[,.(PatientID,AdvancedDiagnosisDate)]
all_obs[,week_12:=as.IDate(as.Date(AdvancedDiagnosisDate)-days(84))]
all_obs[,month_4:=as.IDate(as.Date(AdvancedDiagnosisDate)-days(120))]
all_obs[,year_1:=as.IDate(as.Date(AdvancedDiagnosisDate)- days(360))]
all_obs[,week_plus_1:=as.IDate(as.Date(AdvancedDiagnosisDate)+days(7)- days(1))]
all_obs[,week_plus_4:=as.IDate(as.Date(AdvancedDiagnosisDate)+days(28)- days(1))]


#For primary inclusion criteria, we should expand up to 1 week after


#Weights
all_obs_primary_weight<-all_obs[ , .(
  Date = seq(year_1, week_plus_1, by = "days"),
  AdvancedDiagnosisDate     = AdvancedDiagnosisDate          # propagate time0 into each new row
),
by = PatientID
]
all_obs_primary_weight<-
  merge(all_obs_primary_weight,
        Weight$week1[,.(PatientID,TestDate,TestResultCleaned)],
        by.x=c("PatientID","Date"),
        by.y=c("PatientID","TestDate"),
        all.x=T
        )
setnames(all_obs_primary_weight,"TestResultCleaned","weight")


all_obs_secondary_weight<-all_obs[ , .(
  Date = seq(year_1, week_plus_4, by = "days"),
  AdvancedDiagnosisDate     = AdvancedDiagnosisDate          # propagate time0 into each new row
),
by = PatientID
]
all_obs_secondary_weight<-
  merge(all_obs_secondary_weight,
        Weight$week4[,.(PatientID,TestDate,TestResultCleaned)],
        by.x=c("PatientID","Date"),
        by.y=c("PatientID","TestDate"),
        all.x=T
        )
setnames(all_obs_secondary_weight,"TestResultCleaned","weight")

#combine the weights together
weight_missing<-list(
  "week_1" =copy(all_obs_primary_weight),
  "week_4" =copy(all_obs_secondary_weight)
)

rm(list=c("all_obs_primary_weight","all_obs_secondary_weight"))

saveRDS(weight_missing,"weight_missing.rds")


#ECOG
all_obs_primary_ECOG<-all_obs[ , .(
  Date = seq(month_4, week_plus_1, by = "days"),
  AdvancedDiagnosisDate     = AdvancedDiagnosisDate          # propagate time0 into each new row
),
by = PatientID
]
all_obs_primary_ECOG<-
  merge(all_obs_primary_ECOG,
        ECOG$week1[,.(PatientID,Date,EcogValue)],
        by=c("PatientID","Date"),
        all.x=T
  )
setnames(all_obs_primary_ECOG,"EcogValue","ECOG")


all_obs_secondary_ECOG<-all_obs[ , .(
  Date = seq(month_4, week_plus_4, by = "days"),
  AdvancedDiagnosisDate     = AdvancedDiagnosisDate          # propagate time0 into each new row
),
by = PatientID
]
all_obs_secondary_ECOG<-
  merge(all_obs_secondary_ECOG,
        ECOG$week4[,.(PatientID,Date,EcogValue)],
        by=c("PatientID","Date"),
        all.x=T
  )
setnames(all_obs_secondary_ECOG,"EcogValue","ECOG")

#combine the weights together
ECOG_missing<-list(
  "week_1" =copy(all_obs_primary_ECOG),
  "week_4" =copy(all_obs_secondary_ECOG)
)

rm(list=c("all_obs_primary_ECOG","all_obs_secondary_ECOG"))
saveRDS(ECOG_missing,"ECOG_missing.rds")




#Lab values
all_obs_primary<-all_obs[ , .(
  Date = seq(week_12, week_plus_1, by = "days"),
  time0     = AdvancedDiagnosisDate          # propagate time0 into each new row
),
by = PatientID
]

all_obs_secondary<-all_obs[ , .(
  Date = seq(week_12, week_plus_4, by = "days"),
  time0     = AdvancedDiagnosisDate          # propagate time0 into each new row
),
by = PatientID
]


#Merge the values
for(i in 1:length(lab_values_out)){
  print(lab_vars[i])
  #Some lab values have duplicate. Take mean.
  this_lab<-lab_values_out[[i]]$week1[,.(PatientID,TestDate,TestResultCleaned)]
  this_lab<-this_lab[,mean(TestResultCleaned,na.rm=T),by=.(PatientID,TestDate)]
  setnames(this_lab,"V1","TestResultCleaned")

  all_obs_primary<-
  merge(all_obs_primary,
        this_lab,
        by.x=c("PatientID","Date"),
        by.y=c("PatientID","TestDate"),
        all.x=T
        )
  setnames(all_obs_primary,"TestResultCleaned",lab_vars[i])




  this_lab<-lab_values_out[[i]]$week4[,.(PatientID,TestDate,TestResultCleaned)]
  this_lab<-this_lab[,mean(TestResultCleaned,na.rm=T),by=.(PatientID,TestDate)]
  setnames(this_lab,"V1","TestResultCleaned")

  all_obs_secondary<-
  merge(all_obs_secondary,
        this_lab,
        by.x=c("PatientID","Date"),
        by.y=c("PatientID","TestDate"),
        all.x=T
        )
  setnames(all_obs_secondary,"TestResultCleaned",lab_vars[i])
}

labs_missing<-list(
  "week_1" =copy(all_obs_primary),
  "week_4" =copy(all_obs_secondary)
)
saveRDS(labs_missing,"labs_missing.rds")



```

```{r pattern-missing-data-readi}
#| echo: false
#| eval: false



#Read in the data set for exploring missingness
weight_missing<-readRDS("weight_missing.rds")
ECOG_missing<-readRDS("ECOG_missing.rds")
labs_missing<-readRDS("labs_missing.rds")

all_obs_primary<-list(
  "weight"=weight_missing$week_1,
  "ECOG"=ECOG_missing$week_1,
  "lab"=labs_missing$week_1
)

all_obs_secondary<-list(
  "weight"=weight_missing$week_4,
  "ECOG"=ECOG_missing$week_4,
  "lab"=labs_missing$week_4
)

setnames(all_obs_primary$lab,"time0","AdvancedDiagnosisDate")
setnames(all_obs_secondary$lab,"time0","AdvancedDiagnosisDate")





#get variables of interest (VOI)
VOI<-c(
 "Albumin",
 "ECOG",
 "weight"
)

#get auxilliary variables (includes VOI)
auxilliary<-colnames(all_obs_primary$lab)[!colnames(all_obs_primary$lab) %in%c("PatientID","Date","AdvancedDiagnosisDate",VOI)]






#Build dataset for one patient
#For all variable.
#to do so, we have to restrict to -12 weeks because that's the minimum we chose for the variables.
all_obs_primary_week12<-
merge(
  all_obs_primary$lab,
  all_obs_primary$weight[,.(PatientID,Date,weight)],
  by=c("PatientID","Date"),
  all.x=T
)
all_obs_primary_week12<-
merge(
  all_obs_primary_week12,
  all_obs_primary$ECOG[,.(PatientID,Date,ECOG)],
  by=c("PatientID","Date"),
  all.x=T
)
all_obs_primary_week12[,index:=1:.N,by=PatientID]

#generate weekly index
all_obs_primary_week12[, `weeks since advanced diagnosis date` := floor(as.numeric(difftime(Date,AdvancedDiagnosisDate, units="days")) / 7)]


count_observed<-all_obs_primary_week12[,sum(!is.na(.SD)),by=PatientID,.SDcols=c(VOI,auxilliary)]
count_observed<-count_observed[order(V1,decreasing = T),]  
count_observed[1,] #FC85B4F31A510
#FC85B4F31A510 has the largest number of observation.
#Save this person to work with.
one_obs_primary<-all_obs_primary_week12[PatientID=="FC85B4F31A510",]



#Secondary inclusion criteria
all_obs_secondary_week12<-
  merge(
    all_obs_secondary$lab,
    all_obs_secondary$weight[,.(PatientID,Date,weight)],
    by=c("PatientID","Date"),
    all.x=T
  )
all_obs_secondary_week12<-
  merge(
    all_obs_secondary_week12,
    all_obs_secondary$ECOG[,.(PatientID,Date,ECOG)],
    by=c("PatientID","Date"),
    all.x=T
  )
all_obs_secondary_week12[,index:=1:.N,by=PatientID]

#generate weekly index
all_obs_secondary_week12[, `weeks since advanced diagnosis date` := floor(as.numeric(difftime(Date,AdvancedDiagnosisDate, units="days")) / 7)]

count_observed<-all_obs_secondary_week12[,sum(!is.na(.SD)),by=PatientID,.SDcols=c(VOI,auxilliary)]
count_observed<-count_observed[order(V1,decreasing = T),]  
count_observed[1,] #F94D0B13A35B4
#F94D0B13A35B4 has the largest number of observation.
#Save this person to work with.
one_obs_secondary<-all_obs_secondary_week12[PatientID=="F94D0B13A35B4",]





#let's exclude people who are having wrong data 
#in terms of survival time 

#Read in the data 
ptData_missing<-readRDS("../ptData_time0_diag_v2.rds")
ptData_missing[,advDiag_to_death_weeks:=as.numeric(interval(AdvancedDiagnosisDate,DateOfDeath),"weeks")]

# ptData_missing[advDiag_to_death_weeks<=0,table(DeathInd)] 
# #time to death is 0 or less than 0. There are 442 people like that adn they are all censored.
ptData_missing<-ptData_missing[advDiag_to_death_weeks>0,] 


all_obs_primary_week12<-all_obs_primary_week12[PatientID %in% ptData_missing$PatientID,]
all_obs_secondary_week12<-all_obs_secondary_week12[PatientID %in% ptData_missing$PatientID,]


#The below two PatientIDs are what I've chosen for one_obs_primary and one_obs_secondary
"FC85B4F31A510" %in% ptData_missing$PatientID  #TRUE
"F94D0B13A35B4" %in% ptData_missing$PatientID #TRUE

#merge times 
all_obs_primary_week12<-
merge(
  ptData_missing[,.(PatientID,DateOfDeath,DeathInd,earliest_valid_ResultDate__on_after_time0_PDL1,earliest_valid_ResultDate__on_after_time0_NoPDL1,StartDate, SmokingStatus,Gender,RaceEthnicity,age_at_advDiag, Histology)],
  all_obs_primary_week12,
  all=T,
  by="PatientID"
)
all_obs_secondary_week12<-
  merge(
    ptData_missing[,.(PatientID,DateOfDeath,DeathInd,earliest_valid_ResultDate__on_after_time0_PDL1,earliest_valid_ResultDate__on_after_time0_NoPDL1,StartDate, SmokingStatus,Gender,RaceEthnicity,age_at_advDiag, Histology)],
    all_obs_secondary_week12,
    all=T,
    by="PatientID"
  )


one_obs_primary<-
cbind(
  ptData_missing[PatientID=="FC85B4F31A510",.(DateOfDeath,DeathInd,earliest_valid_ResultDate__on_after_time0_PDL1,earliest_valid_ResultDate__on_after_time0_NoPDL1,StartDate, SmokingStatus,Gender,RaceEthnicity,age_at_advDiag, Histology)],
  one_obs_primary
)


one_obs_secondary<-
  cbind(
    ptData_missing[PatientID=="F94D0B13A35B4",.(DateOfDeath,DeathInd,earliest_valid_ResultDate__on_after_time0_PDL1,earliest_valid_ResultDate__on_after_time0_NoPDL1,StartDate, SmokingStatus,Gender,RaceEthnicity,age_at_advDiag, Histology)],
    one_obs_secondary
  )



saveRDS(VOI,"VOI.rds")
saveRDS(auxilliary,"auxilliary.rds")

saveRDS(all_obs_primary_week12,"all_obs_primary_week12.rds")
saveRDS(one_obs_primary,"one_obs_primary.rds")

saveRDS(all_obs_secondary_week12,"all_obs_secondary_week12.rds")
saveRDS(one_obs_secondary,"one_obs_secondary.rds")

```

```{r read-data}
#| eval: true
#| echo: false
#| include: false

#Read in the data

VOI<-readRDS("VOI.rds")
auxilliary<-readRDS("auxilliary.rds")

all_obs_primary_week12<-readRDS("all_obs_primary_week12.rds")
one_obs_primary<-readRDS("one_obs_primary.rds")

all_obs_secondary_week12<-readRDS("all_obs_secondary_week12.rds")
one_obs_secondary<-readRDS("one_obs_secondary.rds")



```

# Context

I've run landmark analysis without imputing covariates (weight change, Albumin, ECOG scores). But by doing so we
lost so many patients! Under the primary inclusion criteria, the sample size decreased from 24690 to 3016, and under the secondary criteria, it decreased from 16397 to 11309. 

Thus, here, we are trying to identify any auxiliary variables that may explain patterns of missingness in the covariates. If we can find any, then we could impute the covariates and re-do the landmark analysis with the imputed data. 

This idea is from the meeting I had with Ben and Tom on 2025/04/30.

\

# Sketch


Let albumin, weight, and ECOG be variables of interest (VOIs). Since the VOIs are longitudinal in nature, we will explore pattenrwe have longitudinal data set, we will look at pattern of missing
in two levels:

1.  Across subjects (missingness over each day), and
2.  Within subjects (missingness by person over time)

For each lab values, the time interval of data collection was chosen
with advanced diagnosis date as the day 0:

-   Albumin (originally from - 6 weeks):
    -   Primary inclusion criteria: $[-12 weeks, 1 week]$
    -   Secondary inclusion criteria: $[-12 weeks, 4 weeks]$
-   ECOG (originally from - 2 months):
    -   Primary inclusion criteria: $[-4 months, 1 week]$
    -   Secondary inclusion criteria: $[-4 months, 4 week]$
-   Weight (originally from - 6 months):
    -   Primary inclusion criteria: $[-1 year, 1 week]$
    -   Secondary inclusion criteria: $[-1 year, 4 weeks]$
-   All other 20 lab variables (**auxiliary** and originally was not considered for analysis):
    -   Primary inclusion criteria: $[-12 weeks, 1 week]$
    -   Secondary inclusion criteria: $[-12 weeks, 4 weeks]$


Even though ECOG and Weight variables were collected further back than -12 weeks, I restricted them to -12 weeks when I performed analysis in the following sections so that I can present all variables nicely.


\

# How I constructred the data {#sec:how-to-construct-data}

First of all, I excluded 442 patients who had some data fallacy in censoring time. We imputed censoring time according to Flatiron's direction but 442 people's censored date was earlier than advanced diagnosis date. This is false, as patients who were present at the Flatiron's network at the date of advanced diagnosis were able to enter into the dataset. Thus, we used **85,130** for this analysis. 

Table \@ref(tab:tbl-mock-person) is an example of how the data looks like for one person, from -12 weeks back since day of advanced diagnosis to 7 days since advanced diagnosis. Thus, each row shows daily measurement of the variables. We have randomly chosen to present Albumin and white blood cell (WBC) in this table but please know that each person should have 23 columns of all VOIs and auxiliary variables.  


```{r}
#| echo: false
#| eval: true
#| label: tbl-mock-person
#| tab.cap: "A mock data for one patient. Only albumin and white blood cell (WBC) covariates are shown (but in reality, we should have total 23 columns of variables consisting of VOIs and auxiliary variables). The lab values are captured from 12 weeks prior to diagnosis date until 7 days after. For this particular patient, two observations were captured in total, once in week -2 and another in week 0."




# all_obs_primary_week12[PatientID=="F000057FA2792" & !is.na(WBC),]
# all_obs_primary_week12[,which(PatientID=="F000057FA2792" & !is.na(WBC))] #[1] 76 91 

# 1) pick the blocks you want
first6  <- all_obs_primary_week12[1:8,.(AdvancedDiagnosisDate,Date,`weeks since advanced diagnosis date`, Albumin,WBC)]
first6[,AdvancedDiagnosisDate:=as.character(AdvancedDiagnosisDate)]
first6[,Date:=as.character(Date)]

middle  <- all_obs_primary_week12[75:77,.(AdvancedDiagnosisDate,Date,`weeks since advanced diagnosis date`, Albumin,WBC)]
middle[,AdvancedDiagnosisDate:=as.character(AdvancedDiagnosisDate)]
middle[,Date:=as.character(Date)]


middle2  <- all_obs_primary_week12[83:91,.(AdvancedDiagnosisDate,Date,`weeks since advanced diagnosis date`, Albumin,WBC)]
middle2[,AdvancedDiagnosisDate:=as.character(AdvancedDiagnosisDate)]
middle2[,Date:=as.character(Date)]

# 2) make 3 ‚Äúellipsis‚Äù rows
#    here we use the vertical ellipsis character U+22EE
ellipsis_row <- rep("\u22EE", ncol(first6))
ellipsis3     <- as.data.table(
  matrix(ellipsis_row, nrow = 3, ncol = ncol(first6),
         dimnames = list(NULL, names(first6)))
)

# 3) stitch them together
to_show <- rbindlist(list(
  first6,
  ellipsis3,
  middle,
  ellipsis3,
  middle2,
  ellipsis3
), use.names = TRUE, fill = TRUE)

# 4) print with kable + some styling
# knitr::kable(
#   to_show,
#   # caption = "A mock data for one patient. Only albumin and WBC covariates are shown.",
#   escape  = FALSE
# ) %>%
#   kable_styling(
#     bootstrap_options = c("striped","hover","condensed"),
#     full_width = FALSE
#   )

#Adding kable_styling() messes up the table caption numbreing
knitr::kable(
  to_show,
  escape = FALSE
  )

```


When we create a weekly interval, we take average of all observed values in the interval. Thus, each person has 13 rows. Table  \@ref(tab:tbl-mock-average) shows an example of this dataset using the data in Table \@ref(tab:tbl-mock-person).

```{r}
#| eval: true
#| echo: false
#| label: tbl-mock-average 
#| tab.cap: "A mock data for one patient. Observation for Albumin and white blood cell (WBC) are shown. average of all observation each week is shown. If NaN, that means there was no observation seen in that week. This patient is the same patient shown in the previous table."


mock_average<-
all_obs_primary_week12[PatientID=="F000057FA2792",lapply(.SD,function(x)mean(x,na.rm=T)),by=.(`weeks since advanced diagnosis date`),.SDcols = c("Albumin", "WBC")]

kable(
  mock_average,
  escape  = FALSE
)

```



# Proportion of observed values for each person

\



## Weekly interval

We showed an example dataset of how weekly interval looks like in Section \@ref(sec:how-to-construct-data). We generated data like Table \@ref(tab:tbl-mock-person) for all eligible patients (N=85130). And then we took a proportion of weeks that had any observation during the week. There are 13 weeks total, so the denominator used for this calculation was 13. For example, for the patient in Table \@ref(tab:tbl-mock-person) will have 2/13 =  0.1538 for Albumin and WBC. We calculated this proportion for all 23 variables and showed bar plots in Figure \@ref(fig:fig-prop-observed-per-person-weekly). 

```{r fig-prop-observed-per-person-weekly}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| fig.cap: Proportion of observing the lab variable at least once in 7-day interval per person. The axis is cut out at 0.25, but the outliers go up to 1. The denominator used for calculating the proportion was 13, as our data interval was -12 weeks to +1 week since the advanced diagnosis date.





#Just identify variables missing that has most observation per person and choose the top 5 to display.

#First, average out the values over the week
average_over_week<-all_obs_primary_week12[,lapply(.SD,function(x)mean(x,na.rm=T)), .SDcols = c(VOI,auxilliary),by=.(PatientID,`weeks since advanced diagnosis date`)]

prop_obs_primary<-average_over_week[,lapply(.SD,function(x)mean(!is.na(x))), .SDcols = c(VOI,auxilliary),by=.(PatientID)]

prop_obs_primary_long<-melt(prop_obs_primary,id.vars = "PatientID", measure.vars = c(VOI,auxilliary))


# Change outlier, color, shape and size
ggplot(prop_obs_primary_long, aes(x=variable, y=value)) + 
  geom_boxplot(notch=TRUE)+
  scale_y_continuous(limits = c(0,0.25))+
  ggtitle("Proportoin of non-missing obsertation per patient")+
  ylab("Proportion of weeks observed the variable per person")+
  coord_flip() 
```

```{r calc-quartiles-to-explain-figure}
#| echo: false
#| eval: true


#Calculate 1st and 3rd quartile to explain the above plot
prop_obs_primary_summary<-
lapply(c(VOI,auxilliary),function(x)summary(prop_obs_primary[[x]]))
names(prop_obs_primary_summary)<-c(VOI,auxilliary)
prop_obs_primary_summary<-
data.table(
  "Variable" = c(VOI,auxilliary),
  do.call(rbind,prop_obs_primary_summary)
)


#save variable names to print.
max_3rdq<-prop_obs_primary_summary[`3rd Qu.`==max(`3rd Qu.`),unique(`3rd Qu.`)]
max_1stq<-prop_obs_primary_summary[`1st Qu.`==max(`1st Qu.`),unique(`1st Qu.`)]

vars_with_max_3rd_quarts<-prop_obs_primary_summary[`3rd Qu.`==max(`3rd Qu.`),Variable]
if(length(vars_with_max_3rd_quarts)==1){
  vars_with_max_3rd_quarts_print<-vars_with_max_3rd_quarts
}else if(length(vars_with_max_3rd_quarts)==2){
  vars_with_max_3rd_quarts_print<-paste(vars_with_max_3rd_quarts[1]," and ",vars_with_max_3rd_quarts[2], sep="")
}else{
  N<-length(vars_with_max_3rd_quarts)
  vars_with_max_3rd_quarts_print<-vars_with_max_3rd_quarts[1]
  for(i in 2:(N-1)){
    vars_with_max_3rd_quarts_print<-paste(vars_with_max_3rd_quarts_print,", ",vars_with_max_3rd_quarts[i], sep="")
  }
  vars_with_max_3rd_quarts_print<-paste(vars_with_max_3rd_quarts_print,", and ",vars_with_max_3rd_quarts[N], sep="")
}
```

Note that the 1st and 3rd quartiles of `r vars_with_max_3rd_quarts_print` are all the same (IQR = `r max_1stq` - `r round(max_3rdq,4)`) in Figure \@ref(fig:fig-prop-observed-per-person-weekly). We will call these `r length(vars_with_max_3rd_quarts)` variables ***substantially observed variables*** in this subsection hereafter.  It's kind of bad that 3rd quartile is just `r round(max_3rdq,4)` for the substantially observed variables. Too many patients only had 1/13 =0.0769  weeks observed.  In Table \@ref(tab:tbl-prop-observed-per-person-weekly), we show just 6 of these variables, that has the highest mean value from top to bottom. 



```{r tbl-prop-observed-per-person-weekly}
#| echo: false
#| eval: true
#| tab.cap: The top six varibles with highst mean of observing at least one value every 7 days per person. 




#Sort it by mean value because median is 0 for all
kable(
  prop_obs_primary_summary[order(Mean,decreasing = T),][1:6,],
  digits = 5
)

```


So if a patient observed the value only one week, are all variables observed in that week? Like, `r vars_with_max_3rd_quarts`  basically have similar distribution. And based on the Table \@ref(tab:tbl-prop-observed-per-person-weekly), it seems like on average, there was only 1 week was observed. So would that mean that at least for `r vars_with_max_3rd_quarts`, if they were measured, were they measured during the same week?  


Table \@ref(tab:tbl-identify-what-week-observation-is-made-primary) shows one person in the dataset where such is not the case. 
```{r }
#| echo: false
#| eval: true
#| label: tbl-identify-what-week-observation-is-made-primary
#| tab.cap: "One person's data showning the weeks that each variable is observed. All 16 variables with substantially big IQR in Figure 4.1 were observed in this person. "


#for each patient, identify at what week they make the observation
# get_weeks<-function(dat,variable){
#   dat[!is.na(get(variable)),`weeks since advanced diagnosis date`]
# }
# 
# tmptmp<-
# lapply(c(VOI,auxilliary),function(x){
# 
# average_over_week[,get_weeks(.SD,variable = x),by=PatientID]
# 
# })
# names(tmptmp)<-c(VOI,auxilliary)
# 
# saveRDS(tmptmp,"week_observe_primary.rds") #this takes too long. So just save it and read it in.
# 
# tmptmp<-readRDS("week_observe_primary.rds")
# 
# 
# #Expand by weeks 
# tmptmp<-lapply(tmptmp, function(dat){dcast(dat,formula = PatientID~V1)})
# 
# 
# #get each person's data
# 
# #If the person didn't have any observation for all 23 variables, just leave the person out. 
# test<-average_over_week[,any(!is.na(.SD)),.SDcols = c(VOI,auxilliary),by=PatientID]
# pt_have_obs<-test[V1==TRUE,PatientID] #these are the people who have at least one observation
# 
# 
# tmptmp_no_CKD_epi<-tmptmp[c(VOI,auxilliary)[!c(VOI,auxilliary) %in% c("eGFR_mdrd","eGFR_ckd_epi")]]
# 
# library(parallel)
# per_patient<-
# mclapply(pt_have_obs,function(pt){
#   pt_dat<-lapply(tmptmp_no_CKD_epi, function(dat)dat[PatientID==pt])
#   for(var_name in names(pt_dat)){
#     pt_dat[[var_name]][,variable:=var_name]
#   }
#   pt_dat<-rbindlist(pt_dat)
#   
#   
#   #find out if the patient observed all lab values in the same week
#   #if they ever observed the lab value.
#   
#   #Find the weeks we have observed some values
#   week_observed<-apply(pt_dat[,.SD,.SDcols=as.character(c(-12:0))],2,function(x){any(!is.na(x))})
#   week_observed<-names(week_observed)[week_observed==TRUE]
#   
#   
#   
#   
#   list(
#     "variables"=pt_dat$variable, #the variables that appear in the person's data set
#     "week_observed_all_variable"=pt_dat[,sapply(.SD,function(var){sum(!is.na(var))==nrow(pt_dat)}), .SDcols = week_observed]  #for those weeks identify if all variables were observed. IF TRUE, then yes, they were all observed.
# 
#   )
#   
# },mc.cores=ncores)
# names(per_patient)<-pt_have_obs
# saveRDS(per_patient,"per_patient_weekly_primary.rds")

# per_patient #there are lots of false. 
# identify how many have false in them.
# 
# per_patient_table<-
# sapply(per_patient,function(pt){
#   any(pt$week_observed_all_variable==FALSE)
# })
# table(per_patient_table)
# #FALSE  TRUE 
# #19483 19246
# 
# # 19246/(19246+19483) patients have at least one FALSE
# # Meaning  about half of the patients who have at least one measruement don't observe all variables that they ever observe. 
# # For example find a person with FALSE and have variables in vars_with_max_3rd_quarts and out of it. 
# example_dat_find<-
# sapply(per_patient,function(pt){
#   
#   if(all(pt$week_observed_all_variable==TRUE)){
#     return(FALSE)
#   }
#   
#   if(all(vars_with_max_3rd_quarts %in% pt$variables )){
#     return(FALSE)
#   }
#   
#   TRUE
# })
# example_dat_find_pt<-names(example_dat_find)[example_dat_find==TRUE]
# 
# example_dat_find_pt[1] #F000C6DA2A227 <-example?
# per_patient["F000C6DA2A227"]

#Present one as an example. 
# #for example, patient F06D5BC1BDB55"






tmptmp<-readRDS("week_observe_primary.rds")
for(var_dat in names(tmptmp)){
  tmptmp[[var_dat]][,value:=1]
  setnames(tmptmp[[var_dat]],"V1","week")
}
#Expand by weeks
tmptmp<-lapply(tmptmp, function(dat){dcast(dat,formula = PatientID~week, value.var = "value")})
# pt_dat<-lapply(tmptmp, function(dat)dat[PatientID=="F000C6DA2A227"])
pt_dat<-lapply(tmptmp, function(dat)dat[PatientID=="F00053606F5B8"])

for(var_name in names(pt_dat)){
    pt_dat[[var_name]][,variable:=var_name]
  }
pt_dat<-rbindlist(pt_dat)
pt_dat2<-pt_dat[,.SD,.SDcols=c("variable",-12:0)]

setnames(pt_dat2,
         old=as.character(-12:0),
         new=c(paste("week",-12:0)))

#order it so that vars_with_max_3rd_quarts are grouped at the top

vars_with_max_3rd_quarts_one_pt<-vars_with_max_3rd_quarts[vars_with_max_3rd_quarts %in% pt_dat2$variable]
# length(vars_with_max_3rd_quarts_one_pt)

not_vars_with_max_3rd_quarts_one_pt<-vars_with_max_3rd_quarts[!vars_with_max_3rd_quarts %in% pt_dat2$variable]
# length(not_vars_with_max_3rd_quarts_one_pt) #0. Don't use it. 

pt_dat3<-
data.table(
  # "grouping"=c(
  #   "variable in much observed",
  #   rep("",length(vars_with_max_3rd_quarts_one_pt)-1),
  #   "Variable not observed much",
  #   rep("", length(not_vars_with_max_3rd_quarts_one_pt)-1)
  # ),
  
  rbind(
    pt_dat2[variable %in% vars_with_max_3rd_quarts_one_pt,],
    pt_dat2[variable %in% not_vars_with_max_3rd_quarts_one_pt,]
    )
)

#options(knitr.kable.NA = '') to hide NA values.
options(knitr.kable.NA = '') 
kable(
  pt_dat3,
  escape  = FALSE
)


```



Since many variables seemed like they were observed with equal proportion, it seemed like if the variable is observed, then it is observed in the person.  Among those who had at least 1 week observed, when does this one observation get made?




Figure \@ref(fig:fig-weekly-interval) shows the plot of amount of missing across the combination of substantially observed variables in 100 randomly selected patients (there were too many observations and too many variables to display the whole dataset).

```{r fig.height=12, fig.width=10}
#| echo: false
#| eval: true
#| label: fig-weekly-interval
#| fig.cap: "Plots of amount of missing values in each variable and the amount of missing values of substantially observed variables. 100 random patients were selected for the display. The measurements were averaged over 7 days. Blue represents observed and red represents missing."





# #average weekly
# mock_average_all<-
# all_obs_primary_week12[,lapply(.SD,function(x)mean(x,na.rm=T)),by=.(`weeks since advanced diagnosis date`,PatientID),.SDcols = c(VOI,auxilliary)]
# 
# 
# #Since we are doing -12 weeks to +1 week, we will have 13 observations for each lab values
# #Find number of weeks non-missing
# 
# aggr_plot <- aggr(mock_average_all[,.SD,.SDcols = c(VOI,auxilliary)], col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=c(VOI,auxilliary), cex.axis=.7, gap=3,
# ylab=c("Histogram of missing data","Pattern")) #too many variables to display.



# #restrict to vars_with_max_3rd_quarts
# mock_average_all<-
# all_obs_primary_week12[,lapply(.SD,function(x)mean(x,na.rm=T)),by=.(`weeks since advanced diagnosis date`,PatientID),.SDcols = vars_with_max_3rd_quarts]
# #Since we are doing -12 weeks to +1 week, we will have 13 observations for each lab values
# #Find number of weeks non-missing
# aggr_plot <- aggr(mock_average_all[,.SD,.SDcols = vars_with_max_3rd_quarts], col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=vars_with_max_3rd_quarts, cex.axis=.7, gap=3,
# ylab=c("Histogram of missing data","Pattern")) #too many paients to display




#choose 100 random people
set.seed(4)
random_id<-sample(unique(all_obs_primary_week12$PatientID),size = 100, replace = FALSE)
mock_average_random_samples<-all_obs_primary_week12[PatientID %in% random_id,lapply(.SD,function(x)mean(x,na.rm=T)),by=.(`weeks since advanced diagnosis date`,PatientID),.SDcols = vars_with_max_3rd_quarts]

  


# png(paste("VIM_plot.png", sep=""),height=20,width=10, units="in",res=300)
aggr_plot <- aggr(mock_average_random_samples[,.SD,.SDcols = vars_with_max_3rd_quarts], col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=vars_with_max_3rd_quarts, cex.axis=.7, gap=3,
ylab=c("Histogram of missing data","Pattern")) #too many variables to display.
# dev.off()
# summary(aggr_plot)




```


\




## Monthly interval{}

We saw that 
Since we go back to 12 weeks, let's make it every 4 weeks. 

```{r fig-prop-observed-per-person-monthly}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| fig.cap: Proportion of observing the lab variable at least once in 30-day interval per person. The axis is cut out at 0.25, but the outliers go up to 1. The denominator used for calculating the proportion was 4, as our data interval was -12 weeks to +1 week since the advanced diagnosis date. The las tinterval is not 30 days, it's only 7 days after advanced diagnosis date.




#Just identify variables missing that has most observation per person and choose the top 5 to display.
all_obs_primary_week12[,`months since advanced diagnosis date`:=`weeks since advanced diagnosis date`]
all_obs_primary_week12[`weeks since advanced diagnosis date` %in% -1:-4,`months since advanced diagnosis date`:=-1]
all_obs_primary_week12[`weeks since advanced diagnosis date` %in% -5:-8,`months since advanced diagnosis date`:=-2]
all_obs_primary_week12[`weeks since advanced diagnosis date` %in% -9:-12,`months since advanced diagnosis date`:=-3]

average_over_month<-all_obs_primary_week12[,lapply(.SD,function(x)mean(x,na.rm=T)), .SDcols = c(VOI,auxilliary),by=.(PatientID,`months since advanced diagnosis date`)]

prop_obs_primary_mth<-average_over_month[,lapply(.SD,function(x)mean(!is.na(x))), .SDcols = c(VOI,auxilliary),by=.(PatientID)]

prop_obs_primary_long_mth<-melt(prop_obs_primary_mth,id.vars = "PatientID", measure.vars = c(VOI,auxilliary))


# Change outlier, color, shape and size
ggplot(prop_obs_primary_long_mth, aes(x=variable, y=value)) + 
  geom_boxplot(notch=TRUE)+
  ggtitle("Proportoin of non-missing obsertation per patient")+
  ylab("Proportion of weeks observed the variable per person")+
  coord_flip() 
```



```{r tbl-prop-observed-per-person-monthly}
#| echo: false
#| eval: true
#| tab.cap: The top six varibles with highst mean of observing at least one value every 30 days per person. 


prop_obs_primary_summary<-
lapply(c(VOI,auxilliary),function(x)summary(prop_obs_primary_mth[[x]]))
names(prop_obs_primary_summary)<-c(VOI,auxilliary)
prop_obs_primary_summary<-
data.table(
  "Variable" = c(VOI,auxilliary),
  do.call(rbind,prop_obs_primary_summary)
)
#Sort it by mean value because median is 0 for all
kable(
  prop_obs_primary_summary[order(Mean,decreasing = T),][1:6,],
  digits = 5
)

```


