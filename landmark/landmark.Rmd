---
title: "Landmark Analysis"
subtitle: "version 1"
author: "Hyejung Lee <hyejung.lee@utah.edu>"
date: "`r format(Sys.time(), '%a %b %d, %Y %X')`"
always_allow_html: true
output:
  bookdown::github_document2:
    toc: true
    toc_depth: 4
    html_preview: true
  # bookdown::html_document2:
  #   self-contained: true
  #   embed-resources: true
  #   code-fold: true
  #   toc: true
  #   toc_depth: 4
  #   theme: united
  #   toc_float: true
  #   number-sections: true
  # word_document:
  #   toc: true
  #   toc_depth: 3
  #   number_sections: true
# bibliography: references.bib
# csl: nature.csl
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{r include=FALSE}
#| message: false
#| warning: false

knitr::opts_chunk$set(
  cache = TRUE, 
  cache.path = "landmark_cache/", # where to put your .rds files
  warning = FALSE, 
  message = FALSE, 
  cache.lazy = FALSE,
  verbose=TRUE)

# knitr::knit_hooks$set(chunk = function(x, options) x) #for knitting word_document only
# knitr::opts_knit$set(root.dir = "./SAP")
# remotes::install_github('yihui/knitr')
# library(knitr)
library(ggplot2)
library(grid)
library(gridExtra)
library(survival)
library(survminer)
library(officer)
library(officedown)
library(flextable)
library(data.table)
library(parallel)
library(kableExtra)
library(knitr)
library(lubridate)
library(tictoc)
library(gt)
library(gtsummary)
library(tidyverse)
library(DiagrammeR)
library(DiagrammeRsvg)
library(rsvg)



knitr::opts_chunk$set(echo = FALSE)


# BMI<-readRDS("../BMI_overtime.rds") 
# ECOG<-readRDS("../ECOG_overtime.rds") 
# lab_out<-readRDS("../lab_180days.rds")

ncores<-strtoi(Sys.getenv("SLURM_NTASKS")) #Pick up -ntasks or --n from the environment
setDTthreads(threads = ncores)

```

# Context

2025 April 14

I had a meeting with Tom and Ben on last Friday. Ben suggested that I
restrict the patients to those who have:

-   Survive at least 4 weeks post advanced diagnosis
-   Have a valid test result by the end of the 4th week
-   Have albumin, ECOG performance status, and weight change observed to
    use for analysis by the end of:
    -   1st week **(primary inclusion criteria)**
    -   4th week **(secondary inclusion criteria)**

The primary inclusion criteria addresses potential bias when baseline
covariates are measured after treatment assignment. Note that treatment
is a binary variable, which is a function of test result date and 1L
therapy date.

Although our time zero is defined at week 5—implying that every patient
must have at least one measurement of albumin, ECOG, and weight
change—delayed covariate ascertainment risks adjusting for post‑baseline
values. For example, if first‑line therapy begins in week 1 but albumin
is first measured in week 3, that value may already reflect treatment
effects. Restricting covariate observation to week 1 in the primary
analysis (and comparing it to the week 4 window in the secondary
analysis) helps approximate true baseline values at the time of advanced
diagnosis.

\

# Research Aims

-   Aim 1) Identify causal effect of starting 1L therapy before
    receiving valid test results on overall survival of advanced
    non-small cell lung cancer patients.
-   Aim 2) Identify the same thing as Aim 1 in the following subgroups
    of patients, which Wally had previously identified that they have
    higher/lower likelihood of targetable mutations: ECOG 0-2, ECOG 3-4,
    Albumin $\leq 35 g/L$, Albumin $> 35 g/L$, Asian, Female, Male, No
    history of smoking, History of smoking
-   Aim 3) Investigate if there is a trend in causal effect of starting 1L
    therapy before receiving valid test results on overall survival based on the advanced diagnosis year
    

For all 3 aims, we will conduct analysis using the two different samples, each from the primary and secondary inclusion criteria.

\

# Covariate

## Time-fixed covariate

We will use Gender, race/ethnicity, time at advanced diagnosis,
histology, smoking status, and age at diagnosis

## Time-dependenet covariate

Baseline covariate ascertainment proceeded as follows, based on expert
recommendations:

1.  Covariates and time windows
    -   **ECOG performance status**: any assessment recorded from 2
        months before up to 1 week after (or 4 weeks after, for
        secondary inclusion criteria) the date of advanced diagnosis.
    -   **Weight change (**$\geq 10$ lb loss): weight measurements from
        6 months before up to 1 week after (or 4 weeks after, for
        secondary inclusion criteria) diagnosis, with at least two measurements in
        that interval.
    -   **Serum albumin**: binary indicator ($\leq 35 g/L$
        vs.$> 35 g/L$) from 6 weeks before up to 1 week after (or 4
        weeks after, for secondary inclusion criteria) advanced diagnosis.
2.  Inclusion criteria Patients were retained only if they had:
    -   $\geq 1$ ECOG assessment in the specified window,
    -   $\geq 2$ weight measurements in the specified window, and
    -   $\geq 1$ albumin measurement in the specified window.
3.  Value selection
    -   ECOG and albumin: if measured on the date of advanced diagnosis,
        that value was used; otherwise, the measurement closest in time
        to diagnosis was selected, with preference for pre‑diagnosis
        values.
    -   Weight change:
        -   If $\geq 2$ measurements existed before diagnosis, we coded
            whether a $\geq 10$ lb loss occurred in the 6 months
            preceding diagnosis.\
        -   If fewer than two pre‑diagnosis measurements were available,
            we identified the earliest occurrence of $\geq 10$ lb loss
            within the period from 6 months pre‑diagnosis to 1 week (or
            4 weeks, for secondary inclusion criteria) post‑diagnosis.

Implementation details are provided in the analysis script
(new_setup_baseline_diagnosis_v3.R).


```{r time-dep-vars}
#|eval: true

Albumin<-readRDS("../Albumin_overtime_landmark.rds")
ECOG<-readRDS("../ECOG_overtime_landmark.rds")
weight_change<-readRDS("../Weight_change_overtime_landmark.rds")

```

\




# Exclusion

Out of total 85,572 patients in the data set, there are 371 patients who have missing data for time to death or censoring. These patients are excluded first, making the original sample size to be 84,201.

## Data exploration {.unlisted .unnumbered style="display:none;"}

Before we decide on the exclusion, we will look at

-   time from advanced diagnosis until 1L therapy initiation
-   time from advanced diagnosis until receiving valid test result
-   time from advanced diagnosis until death

```{r decide-exclusion-code}
#| eval: true
#| include: false

ptData<-readRDS("../ptData_time0_diag_v2.rds")
ptData[,advDiag_to_death_weeks:=as.numeric(interval(AdvancedDiagnosisDate,DateOfDeath),"weeks")]
ptData[,advDiag_to_valid_PDL1_week:=as.numeric(interval(AdvancedDiagnosisDate,earliest_valid_ResultDate__on_after_time0_PDL1),"weeks")]
ptData[,advDiag_to_valid_gene_week:=as.numeric(interval(AdvancedDiagnosisDate,earliest_valid_ResultDate__on_after_time0_NoPDL1),"weeks")]
ptData[,advDiag_to_valid_test_week:=pmin(advDiag_to_valid_PDL1_week,advDiag_to_valid_gene_week,na.rm = T)]
ptData[,advDiag_to_1L_week:=as.numeric(interval(AdvancedDiagnosisDate,StartDate),"weeks")]

#Exclude those who have no date of death record and have wrong censoring time
ptData<-ptData[advDiag_to_death_weeks>=0,]
# nrow(ptData) #85201

# #Exclude those who have 1L before AdvancedDiagnosisDate 
# ptData<-ptData[advDiag_to_1L_week>=0 | is.na(advDiag_to_1L_week),]
# nrow(ptData) #61102
# 
# #Exclude those who have valid test on or before AdvancedDiagnosisDate
# ptData<-ptData[advDiag_to_valid_test_week>0 | is.na(advDiag_to_valid_test_week),]
# nrow(ptData) #40732
# 



#experience 1L
advDiag_to_1L_week_ceiling<-ptData[,ceiling(advDiag_to_1L_week)]
advDiag_to_1L_week_ceiling[which(advDiag_to_1L_week_ceiling==0)]<-1 # 0 is that 1L happened on the same day as time zero. Consider that as week 1. 
# range(advDiag_to_1L_week_ceiling,na.rm = T) #1 571


#Find maximum number of week when 1L happened
K<-max(advDiag_to_1L_week_ceiling, na.rm = T)
# K #571

#Proportion of people who have experienced first useful test by the end of each week
prop_exp_1L<-
  sapply(1:K,function(this.week){
    sum(advDiag_to_1L_week_ceiling<=this.week, na.rm = T)/length(advDiag_to_1L_week_ceiling)
  })
num_exp_1L<-
  sapply(1:K,function(this.week){
    sum(advDiag_to_1L_week_ceiling<=this.week, na.rm = T)
  })

prop_exp_1L_DT_diag<-
  data.table("k"=1:K,
             "Proportion received 1L"=prop_exp_1L,
             "Number received 1L"=num_exp_1L)





#Proportion dead
#Just use the people who experienced death , DeathInd==1
advDiag_to_death_weeks_ceiling<-ptData[,ceiling(advDiag_to_death_weeks)]


#Find maximum number of week until death/censoring
K<-max(advDiag_to_death_weeks_ceiling, na.rm = T)
# K #622

#Proportion of people who have experienced first useful test by the end of each week
prop_exp_event<-
  sapply(1:K,function(this.week){
    # sum(time0_to_death_weeks_ceiling<=this.week, na.rm = T)/length(time0_to_death_weeks_ceiling) #this one take population (denominator as those who died)
    ptData[advDiag_to_death_weeks_ceiling<=this.week & DeathInd==1,.N]/nrow(ptData)
    
  })

num_exp_event<-
  sapply(1:K,function(this.week){
    # sum(time0_to_death_weeks_ceiling<=this.week, na.rm = T)/length(time0_to_death_weeks_ceiling) #this one take population (denominator as those who died)
    ptData[advDiag_to_death_weeks_ceiling<=this.week & DeathInd==1,.N]
    
  })

prop_exp_event_DT_diag<-
  data.table("k"=1:K,
             "Proportion dead"=prop_exp_event,
             "Number dead"=num_exp_event)






# Proportion experience valid test
advDiag_to_valid_test_week_ceiling<-ptData[,ceiling(advDiag_to_valid_test_week)]
advDiag_to_valid_test_week_ceiling[which(advDiag_to_valid_test_week_ceiling==0)]<-1

#Find maximum number of week for getting valid test
K<-max(advDiag_to_valid_test_week_ceiling, na.rm = T) 
# K #564

#Proportion of people who have useful gene mutation result
prop_valid_test<-
  sapply(1:K,function(this.week){
        sum(advDiag_to_valid_test_week_ceiling<=this.week, na.rm = T)/length(advDiag_to_valid_test_week_ceiling)

  })

num_valid_test<-
  sapply(1:K,function(this.week){
        sum(advDiag_to_valid_test_week_ceiling<=this.week, na.rm = T)

  })

prop_valid_test_DT<-
  data.table("k"=1:K,
             "Proportion who got valid test"=prop_valid_test,
             "Number who got valid test"=num_valid_test)






#group together for plotting
#proportion
tmp1<-copy(prop_exp_1L_DT_diag)
tmp1[,group:="1L initiation"]
setnames(tmp1,"Proportion received 1L","prop")
setnames(tmp1,"Number received 1L","num")

tmp2<-copy(prop_exp_event_DT_diag)
tmp2[,group:="dead"]
setnames(tmp2,"Proportion dead","prop")
setnames(tmp2,"Number dead","num")


tmp3<-copy(prop_valid_test_DT)
tmp3[,group:="valid test"]
setnames(tmp3,"Proportion who got valid test","prop")
setnames(tmp3,"Number who got valid test","num")



diag_comb_plots<-rbind(tmp1,tmp2,tmp3)

```

```{r decide-exclusion-plots, fig.show="hold", out.width='49%',  fig.height=5}
#| eval: true
#| echo: false
#| fig-cap:  Cumulative proportion of 1L initiation, dead, and valid test. The proportions were calculated using all patients after exclusion was applied.




#Generate label for plot
diag_comb_plots[,index:=1:length(prop),by=group]
diag_comb_plots[,last_obs:=max(index),by=group]
diag_comb_plots[,is_last_obs:=(index==last_obs),by=group]

diag_comb_plots[,label:=as.character(NA)]
diag_comb_plots[is_last_obs==TRUE,label:=group]


#proportion
ggplot(data=diag_comb_plots, mapping = aes(x=k,y=prop,col=group))+
  geom_line()+ 
  # theme_classic()
  theme_bw()+
  scale_x_continuous(trans='log', breaks = c(1:5,10,20,50,100,200,400,600))+
  scale_y_continuous(limits=c(0,1), breaks = c(seq(0,0.5,by=0.05), seq(0.5,1,by=0.1)))+
  ylab("Cumulative proportion")+
  xlab("Number of weeks since advanced diagnosis")+
  theme(legend.position="bottom")+
  # guides(col = FALSE)   #remove legend
  ggrepel::geom_label_repel(aes(label = label),
                  nudge_x = 0,
                  nudge_y=0.03,
                  na.rm = TRUE,
                    max.overlaps = getOption("ggrepel.max.overlaps", default = 100))



#Number
ggplot(data=diag_comb_plots, mapping = aes(x=k,y=num,col=group))+
  geom_line()+ 
  # theme_classic()
  theme_bw()+
  scale_x_continuous(trans='log', breaks = c(1:5,10,20,50,100,200,400,600))+
  # scale_y_continuous(limits=c(0,1), breaks = c(seq(0,0.5,by=0.05), seq(0.5,1,by=0.1)))+
  ylab("Cumulative Incidence")+
  xlab("Number of weeks since advanced diagnosis")+
  theme(legend.position="bottom")+
  # guides(col = FALSE)   #remove legend
  ggrepel::geom_label_repel(aes(label = label),
                  nudge_x = 0,
                  nudge_y=0.03,
                  na.rm = TRUE,
                    max.overlaps = getOption("ggrepel.max.overlaps", default = 100))


```

Based on the graph, we decided to subset the samples to have:

-   survived to 4 weeks
-   have received valid test result by 4 weeks

```{r exclusion}
#| echo: false
#| eval: true
#| include: false


ptData<-readRDS("../ptData_time0_diag_v2.rds")
ptData[,advDiag_to_death_weeks:=as.numeric(interval(AdvancedDiagnosisDate,DateOfDeath),"weeks")]
ptData[,advDiag_to_valid_PDL1_week:=as.numeric(interval(AdvancedDiagnosisDate,earliest_valid_ResultDate__on_after_time0_PDL1),"weeks")]
ptData[,advDiag_to_valid_gene_week:=as.numeric(interval(AdvancedDiagnosisDate,earliest_valid_ResultDate__on_after_time0_NoPDL1),"weeks")]
ptData[,advDiag_to_valid_test_week:=pmin(advDiag_to_valid_PDL1_week,advDiag_to_valid_gene_week,na.rm = T)]
ptData[,advDiag_to_1L_week:=as.numeric(interval(AdvancedDiagnosisDate,StartDate),"weeks")]


exclusion_tab<-data.table(
  "Exclusion"=c("Receive 1L therapy before advanced diagnosis date","Receive valid test results before advanced diagnosis date","Died/censored before end of week 4","Do not have any record of receiving valid test by the end of week 4"),
  "Number excluded"=as.numeric(NA),
  "Number remaining"=as.numeric(NA)
)



#Due to data issue, some people are missing censoring time
ptData[DeathInd==0 & advDiag_to_death_weeks<0, .N] #371
pt_exclude<-ptData[DeathInd==0 & advDiag_to_death_weeks<0, PatientID]
#We will exclude them 
ptData<-ptData[!PatientID %in% pt_exclude,]
num_beginning<-nrow(ptData)


#Receive 1L therapy before advanced diagnosis date
ptData[StartDate<AdvancedDiagnosisDate,.N] #994
exclude_pt<-ptData[StartDate<AdvancedDiagnosisDate,PatientID] 
exclusion_tab[Exclusion=="Receive 1L therapy before advanced diagnosis date", `Number excluded`:=length(exclude_pt)]
exclusion_tab[Exclusion=="Receive 1L therapy before advanced diagnosis date", `Number remaining`:=nrow(ptData)-length(exclude_pt)]

ptData<-ptData[!(PatientID %in% exclude_pt),]




#Receive valid test results before advanced diagnosis date
ptData[observe_valid__before_time0_PDL1==TRUE | observe_valid__before_time0_NoPDL1==TRUE,.N] #6522
exclude_pt<-ptData[observe_valid__before_time0_PDL1==TRUE | observe_valid__before_time0_NoPDL1==TRUE,PatientID] 

exclusion_tab[Exclusion=="Receive valid test results before advanced diagnosis date", `Number excluded`:=length(exclude_pt)]
exclusion_tab[Exclusion=="Receive valid test results before advanced diagnosis date", `Number remaining`:=nrow(ptData)-length(exclude_pt)]

ptData<-ptData[!(PatientID %in% exclude_pt),]




#survived up to 4 weeks 
exclusion_tab[Exclusion=="Died/censored before end of week 4", `Number excluded`:=ptData[advDiag_to_death_weeks<=4,.N]]
exclusion_tab[Exclusion=="Died/censored before end of week 4", `Number remaining`:=ptData[advDiag_to_death_weeks>4,.N]]

ptData<-ptData[advDiag_to_death_weeks>4,]



#Receive valid test result prior to the end of 4th week
exclusion_tab[Exclusion=="Do not have any record of receiving valid test by the end of week 4", `Number excluded`:=ptData[advDiag_to_valid_test_week>4 | is.na(advDiag_to_valid_test_week),.N]]
exclusion_tab[Exclusion=="Do not have any record of receiving valid test by the end of week 4", `Number remaining`:=ptData[advDiag_to_valid_test_week<=4,.N]]


ptData<-ptData[advDiag_to_valid_test_week<=4]

```

We have `r num_beginning` patients without any exclusion.

```{r}
#| echo: false
#| eval: true
#| label: tbl-exclusion
#| tbl-cap: Number of patients based on exclusion

kable(exclusion_tab)

```


\


## Primary Inclusion Criteria

```{r exclusion-primary}
#| echo: false
#| eval: true
#| include: false


#Only include people who have observed all variables (including time dependent and independent variables)
ptData1<-copy(ptData)
nrow(ptData1) #27706
exclusion_tab1<-copy(exclusion_tab)


#time-dependent covariate
ptData1<-ptData1[PatientID %in% Albumin$week1[observe_lab_within_window==1,PatientID],]
ptData1<-ptData1[PatientID %in% ECOG$week1[observe_lab_within_window==1,PatientID],]
ptData1<-ptData1[PatientID %in% weight_change$week1[observe_at_least_two_weight==TRUE,PatientID],]
nrow(ptData1) #3018

#time-independent covariate
ptData1[,table(SmokingStatus, useNA = "ifany")] #two unknown not documented. Meaning, not observed.
ptData1[SmokingStatus=="Unknown/Not documented", .(advDiag_to_valid_test_week, advDiag_to_1L_week)] #One in each cohort. Remove them 
ptData1<-ptData1[SmokingStatus!="Unknown/Not documented",]


ptData1[,table(Histology, useNA = "ifany")] 
ptData1[,table(Gender, useNA = "ifany")]
ptData1[,table(RaceEthnicity, useNA = "ifany")] 
ptData1[,sum(is.na(age_at_advDiag))]
ptData1[,sum(is.na(AdvancedDiagnosisDate))]



exclusion_tab1<-
rbind(
  exclusion_tab1,
  data.table(
    Exclusion="Didn't observe all variables (week 1)",
    "Number excluded"=nrow(ptData)-nrow(ptData1),
    "Number remaining"=nrow(ptData1)
  )
  
)
```

```{r}
#| echo: false
#| eval: true
#| label: tbl-exclusion_primary
#| tbl-cap: Number of patients based on exclusion

kable(exclusion_tab1)

```

\


## Secondary Inclusion Criteria

```{r exclusion-secondary}
#| echo: false
#| eval: true
#| include: false


#Only include people who have observed all variables (including time depedent and indenpendent variables)
ptData2<-copy(ptData)
nrow(ptData2) #27706
exclusion_tab2<-copy(exclusion_tab)


#time-dependent covariate
ptData2<-ptData2[PatientID %in% Albumin$week4[observe_lab_within_window==1,PatientID],]
ptData2<-ptData2[PatientID %in% ECOG$week4[observe_lab_within_window==1,PatientID],]
ptData2<-ptData2[PatientID %in% weight_change$week4[observe_at_least_two_weight==TRUE,PatientID],]
nrow(ptData2) #11317

#time-independent covariate
ptData2[,table(SmokingStatus, useNA = "ifany")] #8 unknown not documented. Meaning, not observed.
tmp<-ptData2[SmokingStatus=="Unknown/Not documented", .(advDiag_to_valid_test_week, advDiag_to_1L_week)] 
tmp[is.na(advDiag_to_1L_week),advDiag_to_1L_week:=1000]
tmp[,cohort:="wait"]
tmp[advDiag_to_1L_week<advDiag_to_valid_test_week,cohort:="no_wait"]
tmp
#Among the 8 people with missing Smoking status, 5 people are wait, and 3 are no wait. 
#Exclude them.
ptData2<-ptData2[SmokingStatus!="Unknown/Not documented",]

ptData2[,table(Histology, useNA = "ifany")] 
ptData2[,table(Gender, useNA = "ifany")]
ptData2[,table(RaceEthnicity, useNA = "ifany")] 
ptData2[,sum(is.na(age_at_advDiag))]
ptData2[,sum(is.na(AdvancedDiagnosisDate))]


exclusion_tab2<-
rbind(
  exclusion_tab2,
  data.table(
    Exclusion="Didn't observe all variables (week 4)",
    "Number excluded"=nrow(ptData)-nrow(ptData2),
    "Number remaining"=nrow(ptData2)
  )
  
)
```

```{r}
#| echo: false
#| eval: true
#| label: tbl-exclusion_secondary
#| tbl-cap: Number of patients based on exclusion

kable(exclusion_tab2)

```

\



# Aim 1

## Primary Analysis

```{r primary-analysis}
#| eval: true

ptData1<-
merge(ptData1,
      Albumin$week1[,.(PatientID,TestResultCleaned)],
      all.x = T)
setnames(ptData1,"TestResultCleaned","albumin")
ptData1[,albumin_binary:=ifelse(albumin<=35,"low","normal")]
ptData1[,albumin_binary:=factor(albumin_binary,levels = c("normal","low"), labels = c("normal","low"))]

ptData1<-
merge(ptData1,
      ECOG$week1[,.(PatientID,EcogValue)],
      all.x = T)
setnames(ptData1,"EcogValue","ECOG")


ptData1<-
merge(ptData1,
      weight_change$week1[,.(PatientID,first_date_observe_losing_10lbs)],
      all.x = T)
ptData1[,lost_10lbs:="No"]
ptData1[!is.na(first_date_observe_losing_10lbs),lost_10lbs:="Yes"]
ptData1[,lost_10lbs:=factor(lost_10lbs,levels=c("No","Yes"), labels=c("No","Yes"))]
ptData1[,first_date_observe_losing_10lbs:=NULL]

#Time 0 is 5th week
ptData1[,time0:=NULL]
ptData1[,time0:=as.IDate(as.Date(AdvancedDiagnosisDate)+weeks(4)+days(1))]


#Now treatment assignment.
ptData1[,cohort:="wait"]
ptData1[advDiag_to_1L_week<advDiag_to_valid_test_week,cohort:="no_wait"]
ptData1[,cohort:=factor(cohort,levels=c("wait","no_wait"), labels=c("wait","no_wait"))]


#generate yearly count of advanced diagnosis date
ptData1[,AdvancedDiagnosis_year:=year(AdvancedDiagnosisDate)]
ptData1[,AdvancedDiagnosis_year_factor:=factor(AdvancedDiagnosis_year,levels = sort(unique(AdvancedDiagnosis_year), decreasing = F), labels = sort(unique(AdvancedDiagnosis_year), decreasing = F))]

# ptData1[,min(AdvancedDiagnosis_year)] #2011
ptData1[,AdvancedDiagnosis_year_rescale:=AdvancedDiagnosis_year-min(AdvancedDiagnosis_year)] #make first one 0.
```

\

### Descriptive summary

Summary table:

```{r primary-descriptive-table}
#| eval: true


covars<-list(
  "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
  "lost_10lbs" = "Lost >= 10lbs",
  "ECOG"="ECOG",
  "SmokingStatus"="SmokingStatus",
  "Histology"="Histology",
  "Gender"="Gender",
  "RaceEthnicity"="Race/Ethnicity",
  "age_at_advDiag"="Approximate age at Advanced Diagnosis",
  "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
)  
  primary_decriptive_table<-
    tbl_summary(
      data=ptData1[,.SD,.SDcols=c("cohort",names(covars))],
      by="cohort",
      label=covars,
      missing = "ifany",
      type = list(where(is.numeric) ~ "continuous2"),  # Use "continuous2" for multiple statistics
      statistic = list(
        all_continuous() ~ c("{mean} ({sd})", "{median} ({p25}, {p75})")  # Show both Mean (SD) and Median (Q1, Q3)
      )
    )

```

```{r}
#| echo: false
#| eval: true
#| warning: false
#| label: tbl-primary-dscriptive


primary_decriptive_table |> 
  as_gt() |> 
  #  tab_header(
  #   title = md("What's the difference between this title and caption?"),
  #   subtitle = md("`gtcars` is an R dataset")
  # ) |>
  tab_caption(caption = md("Table XX. Summary of patient characteristics at baseline, for data quality check purposes.")) |> 
  as_raw_html() 
```

As we can observe in the table, there is only one person who is
Hispanic/Latino in no wait cohort. This is insufficient data to make any
meaningful analysis. Thus, we will fuse Hispanic Lanito to Other
category for the analysis.

```{r primary-exclude-pt-for-positivity}
#| echo: false
#| eval: true


#Make HispLatino -> Other 

ptData1[RaceEthnicity=="HispLatino",RaceEthnicity:="Other"]
```

\

### Inverse probability weight

Generate IPW, and re-construct the table.

```{r primary-IPW}
#| eval: true
#| echo: false
#| message: false
#| include: false

#Use logistic regression
covar_cols<-c(
  "albumin_binary",
  "lost_10lbs" ,
  "ECOG",
  "SmokingStatus",
  "Histology",
  "Gender",
  "RaceEthnicity",
  "age_at_advDiag",
  "AdvancedDiagnosis_year_rescale"
)  


this.formula<-formula(paste("cohort~", paste(covar_cols,collapse = "+"), sep=""))
logit.fit<-glm(this.formula,data=ptData1,family="binomial")



#propensity scores
ptData1[,ps:=logit.fit$fitted.values]

#generate weight
ptData1[,w:=ifelse(cohort=="no_wait",1/ps, 1/(1-ps))]

#Propensity score plot for positivity assumption
primary_ps_plot<-ggplot(ptData1, aes(x=ps,fill=cohort))+
  geom_density(alpha=0.2)+
  theme_minimal()
primary_ps_plot #seem like there is a good overlap... Maybe.
#Check the summary of ps by cohort
ptData1[cohort=="wait",summary(ps)]
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#0.05696 0.11658 0.14626 0.15414 0.18184 0.40228
ptData1[cohort=="no_wait",summary(ps)]
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#0.05529 0.13284 0.16594 0.17544 0.21220 0.39429 

#Yes. I thin there are pretty good overlap.



#generate stabilized weights, in case there are extreme weights
prop_no_wait<-mean(ptData1$cohort=="no_wait")
ptData1[,sw:=ifelse(cohort=="no_wait",prop_no_wait/ps, (1-prop_no_wait)/(1-ps))]

#Check extreme weight
ptData1[cohort=="wait",summary(sw)]
ptData1[cohort=="no_wait",summary(sw)]
#all weights under 3. Good!




```

```{r code-primary-both-tables}
#| echo: false
#| eval: true
#| include: false




#before weight
library(survey)
library(tableone)



before<-svydesign(ids= ~ 0, data=ptData1) 
before_tab<- svyCreateTableOne(vars=covar_cols, strata = "cohort",data = before, test = FALSE)
# print(before_tab, smd = TRUE)
# print(before_tab, showAllLevels = TRUE, smd = TRUE)


before_tab_rownames<-rownames(print(before_tab, showAllLevels = TRUE,smd=T))
before_tab<-as.data.frame(print(before_tab,showAllLevels = TRUE, smd=T))
before_tab$this.rownames<-before_tab_rownames



#After weight


after<-svydesign(ids= ~ 0, data=ptData1,weights=ptData1$sw)
after_tab<- svyCreateTableOne(vars=covar_cols, strata = "cohort",data = after, test = FALSE)

after_tab_rownames<-rownames(print(after_tab, showAllLevels = TRUE,smd=T))
after_tab<-as.data.frame(print(after_tab, showAllLevels = TRUE,smd=T))
colnames(after_tab)<-paste(colnames(after_tab),"sw",sep = "_")

#merge the two data sets. Can I just bind them?
# sum(before_tab$this.rownames!=after_tab_rownames) #they are same order. Just cbind them.
# rownames(before_tab)
temp<-cbind(before_tab[,c("this.rownames",colnames(before_tab)[colnames(before_tab)!="this.rownames"])],
            after_tab[,c( "wait_sw","no_wait_sw","SMD_sw")])
rownames(temp)<-NULL


#Change row names to print
pretty_name<-do.call(c,covars)[covar_cols]
new_rownames<-
sapply(temp$this.rownames,function(x){
  
  if(x==""|x=="n"){
    return(x)
  }else{
    
    #logical for index which name to give
    this.index.logical<-
    sapply(names(pretty_name),function(y){
       stringr::str_detect(string = x,
                     pattern = y) 
    })
    
    index<-which(this.index.logical)
    
    #Replace the raw name with pretty name
    newname<-
    stringr::str_replace(string=x, pattern=names(pretty_name)[index], replacement=pretty_name[index])
    return(newname)
  }

})

temp$this.rownames<-new_rownames


```

```{r tbl-primary-dscriptive-both}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| tbl-cap: Summary of Patient Characteristics at Baseline.


# build gt table
gt(temp) |> 
  # First two columns stay as-is:
  cols_label(
    this.rownames = "Variable",
    level         = "Level",
    # now override the 6 numeric columns’ *display* labels:
    wait       = "Wait",
    no_wait    = "No wait",
    SMD        = "SMD",
    wait_sw    = "Wait",
    no_wait_sw = "No wait",
    SMD_sw     = "SMD"
  ) |> 
  # create the two spanners:
  tab_spanner(
    label   = "No IPW",
    columns = c(wait, no_wait, SMD)
  ) |> 
  tab_spanner(
    label   = "IPW",
    columns = c(wait_sw, no_wait_sw, SMD_sw)
  ) |> 
  # optional styling:
  opt_align_table_header("left") |> 
  tab_caption(caption = md("Table XX. Summary of Patient Characteristics at Baseline, without IPW weighting.")) |> 
  as_raw_html()  #this will display the table on

```

Based on the above table, we can observe that when we don't apply IPW,
the standardized mean difference (SMD) for albumin, race/ethnicity, age
at diagnosis, and advanced diagnosis (year) were imbalanced (SMD \>
0.1). However, after IPW, these covariates are all balanced (SMD \<
0.1).

\

### KM curve

```{r fig.show="hold", out.width='49%',  fig.height=6}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-primary-KMplot
#| fig-cap: Figure XX. Kaplan-Meier (KM curve demonstrating survival probability over time. A) original data, B) IPW applied population. 
# #| fig-subcap: ["48 patients used for original body compositions", "46 patients used for composite body compositions"]
# #| layout-ncol: 2

# #| fig-subcap: 
# #|     - 48 patients used for original body compositions
# #|     - 46 patients used for composite body compositions


#Kaplan meier curve
#display that works for HTML.

source("../return_km_plot.R")




#generate time variable
ptData1[,time0_to_death_weeks:=as.numeric(interval(time0,DateOfDeath),"weeks")]
no_ipw<-return_km_plot(data = ptData1,xlab_name = "Time (week)", time="time0_to_death_weeks",covar = "cohort",status ="DeathInd" ) |> suppressWarnings() #Without suppressWarnings(), I still see warning printed out in html file, even with warning: false.

yes_ipw<-return_km_plot(data = ptData1,xlab_name = "Time (week)", time="time0_to_death_weeks",covar = "cohort",status ="DeathInd" ,weight = T,weight_var = "sw") |> suppressWarnings()


#Remove legend
# Assuming your plot is saved as 'x'
# and add title
no_ipw$plot <- no_ipw$plot + 
  # theme(legend.position = "none") + 
  ggtitle("A) Without IPW")
yes_ipw$plot <- yes_ipw$plot + 
  # theme(legend.position = "none")+ 
  ggtitle("B) IPW")


#subfigure a
no_ipw
  

#subfigure b
yes_ipw



```

```{r primary-median-surv}
#| echo: false
#| eval: true


#Just calculate median survival 
#A function that returns median(95%CI) survival time from surfit() object
kmplot_median_CI<-function(km_fit, digits=2){
  #km_fit = survfit() object with binary exposure.
  
  temp<-as.data.frame(summary(km_fit)$table)
  factor_levels<-rownames(temp)
  
  this.formula<-paste("%.",digits,"f (95%%CI: %.",digits,"f - %.",digits,"f)", sep="")
  
  out<-
    lapply(factor_levels,function(x){
      sprintf(this.formula,temp[x,"median"],temp[x,"0.95LCL"],temp[x,"0.95UCL"])
    })
  names(out)<-factor_levels
  out
}

median_summary_noIPW<-kmplot_median_CI(survfit(Surv(time0_to_death_weeks,DeathInd)~cohort, data = ptData1), digits=2)
median_summary_yesIPW<-kmplot_median_CI(survfit(Surv(time0_to_death_weeks,DeathInd)~cohort, data = ptData1, weights = ptData1$sw), digits=2)

```

Without IPW, the median survival of "wait" and "no wait" cohorts were
`r median_summary_noIPW$"cohort=wait"`, and
`r median_summary_noIPW$"cohort=no_wait"`, respectively. With IPW,
however, the median survival decreased very slightly for the wait cohort
(`r median_summary_yesIPW$"cohort=wait"`), while the median survival of
those who waited increased much
(`r median_summary_yesIPW$"cohort=no_wait"`). Even though the confidence
interval substantially overlap.

### Effect of 1L before test result become available

```{r primary-coxph}
#| echo: false
#| eval: true


#Crude fit 
source("../coxph.ci.coef.R")

fit1<-coxph(Surv(time0_to_death_weeks,DeathInd)~cohort, data = ptData1, weights=ptData1$sw, robust = T, x=TRUE)
summary_fit1<-coxph.ci.coef(fit1,x.name="cohortno_wait",digits=3,return_num_binary_x=FALSE,robust=TRUE)
summary_fit1<-summary_fit1["HR(95%CI)"]

```


Using the IPW, we fitted a Cox PH model. The resulting
hazard rate (95% confidence interval) of death by proceeding to 1L
before receiving valid test result was `r summary_fit1`. Since the null
value 1 is included in the 95% CI, we conclude that waiting or not waiting for valid test result proceeding to 1L did not cause much difference in survival. 

Since the type of 1L therapy also affects survival, we show the 1L therapy distribution in the two IPW populations in the next subsection.

\

### 1L therapy distribution

```{r primary-1L-code}
#| echo: false
#| eval: true
#| include: false


# ptData1$FirstLineTherapyGroup
# #Get the most updated classification Wally did for us
# therapy1<-fread("../../../Data/new_1L/firstLinetherapies.csv")
# therapy1<-therapy1[,.(L1therapy,CategoryEric1)]
# colnames(therapy1)<-c("LineName","Group")
# 
# therapy2<-readxl::read_xlsx("../../../Data/new_1L/L1therapiesDiscordantclassesWA.xlsx") #This is the one we have to use updated by Wally
# therapy2<-data.table(therapy2)
# therapy2<-therapy2[,.(L1therapy,Akerley)]
# colnames(therapy2)<-c("LineName","Group")
# 
# # intersect(therapy2$LineName,therapy1$LineName) #they are mutually exclusive!
# #Bind them
# therapy<-rbind(therapy1,therapy2)
# #make a vector out of it.
# therapy_vector<-therapy$Group
# names(therapy_vector)<-therapy$LineName
# 
# therapy_vector_group<-therapy_vector[ptData1$LineName]
# ptData1[,therapy_group:=therapy_vector_group]




#Make sure everything is categorized
table(ptData1$FirstLineTherapyGroup, useNA = "ifany") #294 NAs
# Use my old data
#see if there are any that were not observed in the new grouping
my.dictionary<-readRDS("../../EDA_V9/1Lgroup_dictionary_new_all.rds")
table(!(my.dictionary$FirstLineTherapy %in% ptData1$LineName)) #There are lots not in there.

#Let's switch
ptData1[,FirstLineTherapyGroup_old_and_new:=FirstLineTherapyGroup]
this_group<-my.dictionary[,final]
names(this_group)<-my.dictionary$FirstLineTherapy
ptData1[is.na(FirstLineTherapyGroup),FirstLineTherapyGroup_old_and_new:=this_group[LineName]]
#Make sure verything is categorized
table(ptData1$FirstLineTherapyGroup_old_and_new, useNA = "ifany") #Lots of NA

# saveRDS(ptData1,"ptData1_landmark.rds")

source("../../EDA_V9/wait_trt_dist_plot_facet.R")
plot_out<-wait_trt_dist_plot_facet(
    dat=ptData1[,.(cohort,FirstLineTherapyGroup_old_and_new,sw)],
    cohort="cohort",
    geom_text_location_prop=0.7,
    this.fontsize=3,
    weight = "sw",
    trim.percent = 5, #must be greater than or equal to 1%. Any treatment with at least 5% of population will be plotted
    therapy_col = "FirstLineTherapyGroup_old_and_new"
  )

```

```{r fig.show="hold", out.width='100%'}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-primary-1L
#| fig-cap: Figure XX Distribution of 1L therapy received by patients stratified by cohort with IPW applied. Only the treatments that compose more than 5% of either of the two cohorts is shown in the plot.



plot_out
```

For both cohorts, chemotherapy was the most commonly used therapy,
followed by chemo-immunotherapy. However, the 3rd most common therapy
for "no wait" cohort was immunotherapy, while for the "wait" cohort was
nothing at all. Target therapy was the least common therapy in the
"wait" cohort. I think how the top 3 most contributed 1L therapies are the same between the two cohorts also contribute to similar hazard of death. Waiting would have contributed much to survival if many people received less invasive therapy such as targetable therapy. But only 10.36% of the "wait" patients received targetable therapy so their survival, even if they had longer survival, would not have shown up much in the analysis.


So even if targetable therapy is good for survival, with only 10% of patients receiving the therapy, I don't think it's going to be reflected well in the hazard ratio. So I decided to look at difference in survival between those who received target therapy versus not among the "wait" cohort. I have initially tried to collect the lab values around the time of 1L therapy initiation. However, there were many patients missing the record. Thus, we used the lab values recorded for the advanced diagnosis date. We also collected information on whether there was targetable mutation until the day of 1L therapy initiation (binary) and used this information to construct IPW.


```{r primary-target-vs-notarget}
#| eval: true
#| echo: false
#| include: false


#Try to find time to death of those who received targetable therapy
ptData1_wait<-copy(ptData1)
ptData1_wait<-ptData1_wait[cohort=="wait",]
ptData1_wait<-ptData1_wait[,cohort:=NULL]
ptData1_wait<-ptData1_wait[,cohort:=as.character(NA)]
ptData1_wait[FirstLineTherapyGroup_old_and_new=="Target",cohort:="Target therapy"]
ptData1_wait[is.na(cohort),cohort:="something else"]
ptData1_wait[,cohort:=factor(cohort,levels=c("something else","Target therapy"), labels = c("something else","Target therapy"))]

#Check for their mutation status at baseline. 
#Up to end of week 4 
bio<-readRDS("../../../Data/Enhanced_AdvNSCLCBiomarkers.rds")
setDT(bio)[, TestType := stringr::str_replace(TestType, "Mass spectrometry", "Mass Spectrometry")]
setDT(bio)[, TestType := stringr::str_replace(TestType, "Other sequencing method", "Other")]

setDT(bio)[ #combine NTRK's
  , 
  BiomarkerName := 
    stringr::str_replace_all(BiomarkerName, 
                             c("NTRK1"="NTRK",
                               "NTRK2"="NTRK",
                               "NTRK3"="NTRK",
                               "NTRK - unknown gene type"="NTRK",
                               "NTRK - other"="NTRK"))
]

mutation_positive<-c(
  "Mutation positive",
  "PD-L1 positive",
  "Rearrangement present",
  "Rearrangement positive",
  "Amplification positive",
  "Protein expression positive",
  "PD-L1 positive"
)

#restrict to people of our interest
bio<-bio[PatientID %in% ptData1_wait$PatientID,]
#Merge time 0
bio<-
merge(bio,
      ptData1_wait[,.(PatientID,AdvancedDiagnosisDate)],
      by="PatientID",
      all=T)
#Add 4 weeks after diagnosis date
bio[,week_4:=as.IDate(as.Date(AdvancedDiagnosisDate)+weeks(4))]
#We want all mutation information that are positive and before 4 weeks after advanced diagnosis date
bio<-bio[ResultDate<=week_4 & BiomarkerStatus %in% mutation_positive,]
#Exclude PDL1. It's not target therapy.
bio<-bio[BiomarkerName!="PDL1"]
#these are the people who have targetable mutation
yes_target_wait<-bio[,unique(PatientID)]

ptData1_wait[,targetable_mutation_by_week_4:=FALSE]
ptData1_wait[PatientID %in% yes_target_wait,targetable_mutation_by_week_4:=TRUE]
ptData1_wait[,table(targetable_mutation_by_week_4)]
ptData1_wait[,table(cohort,targetable_mutation_by_week_4)]
#                targetable_mutation_by_week_4
#cohort           FALSE TRUE
#  something else  1691  586
#  Target therapy    25  239


# #ECOG and Albumin at time to decide the therapy
# baselineECOG<-readRDS("../../../Data/BaselineECOG.rds")
# baselineECOG<-baselineECOG[PatientID %in% ptData1_wait$PatientID,]
# baselineECOG[ECOGValue=="Unknown",ECOGValue:=NA]
# baselineECOG[,ECOGValue:=as.integer(ECOGValue)]
# setnames(baselineECOG,"ECOGValue","EcogValue")
# setnames(baselineECOG,"ECOGDate","Date")
# baselineECOG[,Date:=as.IDate(Date)]
# 
# ECOG<-readRDS("../../../Data/ECOG.rds")
# ECOG<-ECOG[PatientID %in% ptData1_wait$PatientID,]
# setnames(ECOG,"EcogDate","Date")
# ECOG<-unique(ECOG[,.(PatientID,Date,EcogValue)])
# ECOG[,N:=.N,by=.(PatientID,Date)]
# ECOG[N>1,] #We will take average
# ECOG2<-ECOG[,mean(as.numeric(EcogValue),na.rm=T),by=.(PatientID,Date)]
# ECOG2
# setnames(ECOG2,"V1","EcogValue")
# 
# 
# #get them merged
# both_ECOG<-
#   merge(unique(baselineECOG[,.(PatientID,Date,EcogValue)]),
#         ECOG2[,.(PatientID,Date,EcogValue)],
#         by=c("PatientID","Date"),
#         all=T)
# both_ECOG[,EcogValue.x:=as.numeric(EcogValue.x)]
# both_ECOG[is.na(EcogValue.x),EcogValue.x:=EcogValue.y]
# both_ECOG[,EcogValue.y:=NULL]
# setnames(both_ECOG,"EcogValue.x","EcogValue")
# # rm(list=c("baselineECOG","ECOG"))
# both_ECOG
# 
# test<-ptData1_wait[,.(PatientID,advDiag_to_1L_week,StartDate)]
# test<-test[!is.na(StartDate)]
# test<-
# merge(
#   test,
#   both_ECOG,
#   by.x=c("PatientID","StartDate"),
#   by.y=c("PatientID","Date"),
#   all.x=T
#   )
# test[,sum(is.na(EcogValue))] #1063
# #Grab most recent value up to 2 months back to 1 week after
# test[,min_date:=as.IDate(as.Date(StartDate) %m-% months(2))]
# test[,max_date:=as.IDate(as.Date(StartDate) + weeks(1))]
# test<-test[min_date<=Date & max_date>=Date,]
# ptData1_wait_tmp<-ptData1_wait[,.(PatientID)]
# ptData1_wait_tmp[,observe_lab_within_window:=0]
# ptData1_wait_tmp[PatientID %in% unique(test$PatientID),observe_lab_within_window:=1]
# ptData1_wait_tmp[,table(observe_lab_within_window)]
# #   0    1 
# # 446 2095 
# 
# #446 people didn't observe ECOG at the window [- 2months, 1week]
# #so we can't really use ECOG.
# 
# 
# #Albumin
# lab<-readRDS("../../labs/raw_lab.rds")
# vars<-readRDS("../../labs/baseline_covariates.rds")
# vars[variables=="Albumin"]
# 
# # we will just use Albumin
# this_vars<-"Albumin"
# 
# #there can be several different baselines we want to use,
# #choose only one here. 
# #set the character string that corresponds to the column name.
# this.baseline<-"StartDate" 
# 
# 
# #save the rows we want to use
# this_Test<-vars[variables==this_vars,unique(Test)]
# 
# #Save the subdat
# temp<-lab[Test %in% this_Test,]
# 
# #remove all invalid dataset
# temp<-temp[!is.na(TestResultCleaned) & TestUnitsCleaned!="",]
# 
# 
# #subset the data to what we need. 
# these.cols<-c("PatientID",this.baseline)
# temp<-merge.data.table(ptData1_wait[,..these.cols],
#                        temp[,.(PatientID,TestDate,TestUnitsCleaned,TestResultCleaned)],
#                        by="PatientID",
#                        all.x=TRUE,
#                        allow.cartesian=TRUE)
# 
# 
# #(-6 weeks,1 week] 
# temp[,min_date:=as.IDate(as.Date(StartDate)- weeks(6))]
# temp[,max_date:=as.IDate(as.Date(StartDate)+ weeks(1))]
# temp<-temp[min_date<=TestDate & max_date>=TestDate,]
# temp<-temp[,days_to_time0:=StartDate-TestDate]
# setnames(temp,"StartDate","time0")
# ptData1_wait_tmp<-ptData1_wait[,.(PatientID)]
# ptData1_wait_tmp[,observe_lab_within_window:=0]
# ptData1_wait_tmp[PatientID %in% unique(temp$PatientID),observe_lab_within_window:=1]
# #   0    1 
# # 507 2034 
# 
# #There are 507 patients missing albumin around the window 
# #So we can't use albumin
# 
# 
# #Let's not use new lab values value around the start of 1L therapy
# #Just use their values at baseline.


source("../whole_analysis_func_v2.R")
ptData1_wait_out<-whole_analysis_func_v2(
  ptData1_wait,
  covars =   list(
    "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
    "lost_10lbs" = "Lost >= 10lbs",
    "ECOG"="ECOG",
    "SmokingStatus"="SmokingStatus",
    "Histology"="Histology",
    "Gender"="Gender",
    "RaceEthnicity"="Race/Ethnicity",
    "age_at_advDiag"="Approximate age at Advanced Diagnosis",
    "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)",
    "targetable_mutation_by_week_4"="Targetable mutation"
  ))

ptData1_wait_out$KM_curves
ptData1_wait_out$SMD_table 
#Some are having SMD > 0.1. very much violating SMD. 
# Save and report 
SMD_sw<-as.numeric(ptData1_wait_out$SMD_table$SMD_sw)
SMD_sw_var<-ptData1_wait_out$SMD_table$this.rownames
SMD_sw_report<-SMD_sw[which(SMD_sw>0.1)]
SMD_sw_var_report<-SMD_sw_var[which(SMD_sw>0.1)]
SMD_sw_var_report<-stringr::str_remove(string = SMD_sw_var_report,pattern = " \\(%\\)")
SMD_sw_var_report<-stringr::str_remove(string = SMD_sw_var_report,pattern = " \\(mean \\(SD\\)\\)")
if(length(SMD_sw_var_report)>1){
  if(length(SMD_sw_var_report)==2){
    tmp1<-paste(SMD_sw_var_report,collapse = " and ")
  }else{
    except_last<-SMD_sw_var_report[1:(length(SMD_sw_var_report)-1)]
    tmp1<-paste(except_last,collapse = ", ")
    tmp1<-paste(tmp1,", and ",SMD_sw_var_report[length(SMD_sw_var_report)], sep = "" )

  }
}else{
  tmp1<-SMD_sw_var_report
}
tmp1


ptData1_wait_out_median_target<-ptData1_wait_out$median_survivals$yes_ipw$"cohort=Target therapy"
ptData1_wait_out_median_else<-ptData1_wait_out$median_survivals$yes_ipw$"cohort=something else"

```


First, here's my presentation of 2 by 2 contingency table, showing the 1L therapy type (Target or not) and whether the patient had targetable mutation by time zero:

```{r target-therapy-mutation-status-contingency-table}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| tbl-cap: 2 by 2 contingency table for targetable mutation status and the respective treatment choices among the wait patients.


cont_table<-ptData1_wait[,.(cohort,targetable_mutation_by_week_4)]
cont_table[,targetable_mutation_by_week_4_characer:=as.character(NA)]
cont_table[targetable_mutation_by_week_4==TRUE,targetable_mutation_by_week_4_characer:="Yes"]
cont_table[targetable_mutation_by_week_4==FALSE,targetable_mutation_by_week_4_characer:="No"]
cont_table[,targetable_mutation_by_week_4:=NULL]
setnames(
  cont_table,
  old=c("cohort","targetable_mutation_by_week_4_characer"),
  new=c("1L therapy type","Have targetable mutation by time zero")
)

cont_table[,table(`1L therapy type`,`Have targetable mutation by time zero` )]

# cont_table<-cont_table[,.N,by=.(`1L therapy type`,`Have targetable mutation by time zero`)]
# cont_table<-dcast(cont_table,`1L therapy type`~`Have targetable mutation by time zero`,value.var = "N")
# 


# cont_table %>% 
#   rename("\t" = `1L therapy type`) %>% 
#   add_column(" " = c("1L therapy type", rep(" ", nrow(.) - 1)), .before = "\t") %>% 
#   kable() %>% 
#   kable_styling(position = "left", full_width = F, ) %>% 
#   add_header_above(c("", "", "Have targetable mutation by time zero", rep(" ", ncol(cont_table) - 2))) %>% 
#   column_spec(1:2, bold = TRUE) 

```

Based on the above contingency table, there are people who have targetable mutation but still got something else (N=586).


To check if targetable mutation patients really live longer or not, we generated IPW applied KM plot, comparing those who received targetable therapy versus not (whether they received anything or not). The variables used to generate IPW are the same as used in the main analysis.

With IPW, `r tmp1` reported high SMD, ranging from `r min(SMD_sw_report)` to `r max(SMD_sw_report)`. Thus, the covariate blance was really off. Below we present the table of covariate distribution before and after IPW.


```{r tbl-primary-wait-1L-dscriptive-both}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| tbl-cap: Summary of Patient Characteristics at Baseline.


# build gt table
gt(ptData1_wait_out$SMD_table ) |> 
  # First two columns stay as-is:
  cols_label(
    this.rownames = "Variable",
    level         = "Level",
    # now override the 6 numeric columns’ *display* labels:
    `something else`  = "Something else",
    `Target therapy`    = "Target therapy",
    SMD        = "SMD",
    `something else_sw`  = "Something else",
    `Target therapy_sw`    = "Target therapy",
    SMD_sw     = "SMD"
  ) |> 
  # create the two spanners:
  tab_spanner(
    label   = "No IPW",
    columns = c(`something else` , `Target therapy`, SMD)
  ) |> 
  tab_spanner(
    label   = "IPW",
    columns = c(`something else_sw` , `Target therapy_sw` ,SMD_sw)
  ) |> 
  # optional styling:
  opt_align_table_header("left") |> 
  tab_caption(caption = md("Table XX. Summary of Patient Characteristics at Baseline, without IPW weighting.")) |> 
  as_raw_html()  #this will display the table on

```


Nonetheless, we still show kalan meier curve for both before and after IPW. When we don't apply IPW, median survival (95% CI) of those who received targeted therapy was `r  ptData1_wait_out$median_survivals$no_ipw$"cohort=Target therapy"`, while those who didn't were  `r ptData1_wait_out$median_survivals$no_ipw$"cohort=something else"`.




```{r fig.show="hold", out.width='49%',  fig.height=6}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-primary-target-KM
#| fig-cap: Figure XX KM received by patients stratified by 1L therapy. IPW population.



#subfigure a
ptData1_wait_out$KM_curves$no_ipw
  

#subfigure b
ptData1_wait_out$KM_curves$yes_ipw



```




\


## Secondary analysis

We repeat the primary analysis except with changed inclusion criteria,
where the patients have up to 4 weeks after advanced diagnosis date to
observe the baseline covariates.

```{r secondary-analysis}
#| eval: true
#| echo: false

ptData2<-
  merge(ptData2,
        Albumin$week4[,.(PatientID,TestResultCleaned)],
        all.x = T)
setnames(ptData2,"TestResultCleaned","albumin")
ptData2[,albumin_binary:=ifelse(albumin<=35,"low","normal")]
ptData2[,albumin_binary:=factor(albumin_binary,levels = c("normal","low"), labels = c("normal","low"))]

ptData2<-
  merge(ptData2,
        ECOG$week4[,.(PatientID,EcogValue)],
        all.x = T)
setnames(ptData2,"EcogValue","ECOG")


ptData2<-
  merge(ptData2,
        weight_change$week4[,.(PatientID,first_date_observe_losing_10lbs)],
        all.x = T)
ptData2[,lost_10lbs:="No"]
ptData2[!is.na(first_date_observe_losing_10lbs),lost_10lbs:="Yes"]
ptData2[,lost_10lbs:=factor(lost_10lbs,levels=c("No","Yes"), labels=c("No","Yes"))]
ptData2[,first_date_observe_losing_10lbs:=NULL]

#Time 0 is 5th week
ptData2[,time0:=NULL]
ptData2[,time0:=as.IDate(as.Date(AdvancedDiagnosisDate)+weeks(4)+days(1))]


#Now treatment assignment.
ptData2[,cohort:="wait"]
ptData2[advDiag_to_1L_week<advDiag_to_valid_test_week,cohort:="no_wait"]
ptData2[,cohort:=factor(cohort,levels=c("wait","no_wait"), labels=c("wait","no_wait"))]



#generate yearly count of advanced diagnosis date
ptData2[,AdvancedDiagnosis_year:=year(AdvancedDiagnosisDate)]
ptData2[,AdvancedDiagnosis_year_factor:=factor(AdvancedDiagnosis_year,levels = sort(unique(AdvancedDiagnosis_year), decreasing = F), labels = sort(unique(AdvancedDiagnosis_year), decreasing = F))]

# ptData2[,min(AdvancedDiagnosis_year)] #2011
ptData2[,AdvancedDiagnosis_year_rescale:=AdvancedDiagnosis_year-min(AdvancedDiagnosis_year)] #make first one 0.

```

\

### Descriptive summary

Summary table:

```{r secondary-descriptive-table}
#| eval: true


covars<-list(
  "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
  "lost_10lbs" = "Lost >= 10lbs",
  "ECOG"="ECOG",
  "SmokingStatus"="SmokingStatus",
  "Histology"="Histology",
  "Gender"="Gender",
  "RaceEthnicity"="Race/Ethnicity",
  "age_at_advDiag"="Approximate age at Advanced Diagnosis",
  "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
)  
  secondary_decriptive_table<-
    tbl_summary(
      data=ptData2[,.SD,.SDcols=c("cohort",names(covars))],
      by="cohort",
      label=covars,
      missing = "ifany",
      type = list(where(is.numeric) ~ "continuous2"),  # Use "continuous2" for multiple statistics
      statistic = list(
        all_continuous() ~ c("{mean} ({sd})", "{median} ({p25}, {p75})")  # Show both Mean (SD) and Median (Q1, Q3)
      )
    )

```

```{r}
#| echo: false
#| eval: true
#| warning: false
#| label: tbl-secondary-dscriptive


secondary_decriptive_table |> 
  as_gt() |> 
  #  tab_header(
  #   title = md("What's the difference between this title and caption?"),
  #   subtitle = md("`gtcars` is an R dataset")
  # ) |>
  tab_caption(caption = md("Table XX. Summary of patient characteristics at baseline, for data quality check purposes.")) |> 
  as_raw_html() 
```

As in the case if the primary analysis, there are hardly any
Hispanic/Latino. Thus, they are combined with "Other" group.

```{r secondary-exclude-pt-for-positivity}
#| echo: false
#| eval: true


#Make HispLatino -> Other 

ptData2[RaceEthnicity=="HispLatino",RaceEthnicity:="Other"]
```

\

### Inverse probability weight

Generate IPW, and re-construct the table.

```{r seocndary-IPW}
#| eval: true
#| echo: false
#| message: false
#| include: false

#Use logistic regression
covar_cols<-c(
  "albumin_binary",
  "lost_10lbs" ,
  "ECOG",
  "SmokingStatus",
  "Histology",
  "Gender",
  "RaceEthnicity",
  "age_at_advDiag",
  "AdvancedDiagnosis_year_rescale"
)  


this.formula<-formula(paste("cohort~", paste(covar_cols,collapse = "+"), sep=""))
logit.fit<-glm(this.formula,data=ptData2,family="binomial")

# logit.fit<-glm(cohort~albumin_binary+lost_10lbs+ECOG+SmokingStatus+Histology+Gender+RaceEthnicity+age_at_advDiag+AdvancedDiagnosis_year,data=ptData2,family="binomial")


#propensity scores
ptData2[,ps:=logit.fit$fitted.values]

#generate weight
ptData2[,w:=ifelse(cohort=="no_wait",1/ps, 1/(1-ps))]

#Propensity score plot
# secondary_ps_plot<-ggplot(ptData2, aes(x=ps,fill=cohort))+
#   geom_density(alpha=0.2)+
#   theme_minimal()
# secondary_ps_plot #seem like there is a good overlap... Maybe.
#Check the summary of ps by cohort
ptData2[cohort=="wait",summary(ps)]
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#0.03944 0.09393 0.11713 0.12356 0.14626 0.37796
ptData2[cohort=="no_wait",summary(ps)]
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#0.05194 0.10637 0.13123 0.13879 0.16594 0.35221 
#Really good overlap.



#generate stabilized weights, in case there are extreme weights
prop_no_wait<-mean(ptData2$cohort=="no_wait")
ptData2[,sw:=ifelse(cohort=="no_wait",prop_no_wait/ps, (1-prop_no_wait)/(1-ps))]

#Check extreme weights
ptData2[cohort=="wait",summary(sw)]
ptData2[cohort=="no_wait",summary(sw)]
#Good. No weights exceeding 3.



```

```{r code-secondary-both-tables}
#| echo: false
#| eval: true
#| include: false




#before weight
library(survey)
library(tableone)



before<-svydesign(ids= ~ 0, data=ptData2) 
before_tab<- svyCreateTableOne(vars=covar_cols, strata = "cohort",data = before, test = FALSE)
# print(before_tab, smd = TRUE)
# print(before_tab, showAllLevels = TRUE, smd = TRUE)


before_tab_rownames<-rownames(print(before_tab, showAllLevels = TRUE,smd=T))
before_tab<-as.data.frame(print(before_tab,showAllLevels = TRUE, smd=T))
before_tab$this.rownames<-before_tab_rownames



#After weight


after<-svydesign(ids= ~ 0, data=ptData2,weights=ptData2$sw)
after_tab<- svyCreateTableOne(vars=covar_cols, strata = "cohort",data = after, test = FALSE)

after_tab_rownames<-rownames(print(after_tab, showAllLevels = TRUE,smd=T))
after_tab<-as.data.frame(print(after_tab, showAllLevels = TRUE,smd=T))
colnames(after_tab)<-paste(colnames(after_tab),"sw",sep = "_")

#merge the two data sets. Can I just bind them?
# sum(before_tab$this.rownames!=after_tab_rownames) #they are same order. Just cbind them.
# rownames(before_tab)
temp<-cbind(before_tab[,c("this.rownames",colnames(before_tab)[colnames(before_tab)!="this.rownames"])],
            after_tab[,c( "wait_sw","no_wait_sw","SMD_sw")])
rownames(temp)<-NULL


#Change row names to print
pretty_name<-do.call(c,covars)[covar_cols]
new_rownames<-
  sapply(temp$this.rownames,function(x){
    
    if(x==""|x=="n"){
      return(x)
    }else{
      
      #logical for index which name to give
      this.index.logical<-
        sapply(names(pretty_name),function(y){
          stringr::str_detect(string = x,
                              pattern = y) 
        })
      
      index<-which(this.index.logical)
      
      #Replace the raw name with pretty name
      newname<-
        stringr::str_replace(string=x, pattern=names(pretty_name)[index], replacement=pretty_name[index])
      return(newname)
    }
    
  })

temp$this.rownames<-new_rownames


```

```{r tbl-secondary-dscriptive-both}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| tbl-cap: Summary of Patient Characteristics at Baseline.


# build gt table
gt(temp) |> 
  # First two columns stay as-is:
  cols_label(
    this.rownames = "Variable",
    level         = "Level",
    # now override the 6 numeric columns’ *display* labels:
    wait       = "Wait",
    no_wait    = "No wait",
    SMD        = "SMD",
    wait_sw    = "Wait",
    no_wait_sw = "No wait",
    SMD_sw     = "SMD"
  ) |> 
  # create the two spanners:
  tab_spanner(
    label   = "No IPW",
    columns = c(wait, no_wait, SMD)
  ) |> 
  tab_spanner(
    label   = "IPW",
    columns = c(wait_sw, no_wait_sw, SMD_sw)
  ) |> 
  # optional styling:
  opt_align_table_header("left") |> 
  tab_caption(caption = md("Table XX. Summary of Patient Characteristics at Baseline, without IPW weighting.")) |> 
  as_raw_html()  #this will display the table on

```

Without IPW, albumin has SMD exceeding 0.1. However, IPW balanced it out.

\

### KM curve

```{r fig.show="hold", out.width='49%',  fig.height=5}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-secondary-KMplot
#| fig-cap: Figure XX. Kaplan-Meier (KM curve demonstrating survival probability over time. A) original data, B) IPW applied population. 
# #| fig-subcap: ["48 patients used for original body compositions", "46 patients used for composite body compositions"]
# #| layout-ncol: 2

# #| fig-subcap: 
# #|     - 48 patients used for original body compositions
# #|     - 46 patients used for composite body compositions


#Kaplan meier curve
#display that works for HTML.



#generate time variable
ptData2[,time0_to_death_weeks:=as.numeric(interval(time0,DateOfDeath),"weeks")]
no_ipw<-return_km_plot(data = ptData2,xlab_name = "Time (week)", time="time0_to_death_weeks",covar = "cohort",status ="DeathInd" ) |> suppressWarnings() #Without suppressWarnings(), I still see warning printed out in html file, even with warning: false.

yes_ipw<-return_km_plot(data = ptData2,xlab_name = "Time (week)", time="time0_to_death_weeks",covar = "cohort",status ="DeathInd" ,weight = T,weight_var = "sw") |> suppressWarnings()


#Remove legend
# Assuming your plot is saved as 'x'
# and add title
no_ipw$plot <- no_ipw$plot + 
  # theme(legend.position = "none") + 
  ggtitle("A) Without IPW")
yes_ipw$plot <- yes_ipw$plot + 
  # theme(legend.position = "none")+ 
  ggtitle("B) IPW")


#subfigure a
no_ipw

#subfigure b
yes_ipw



```

```{r secondary-median-surv}
#| echo: false
#| eval: true


#Just calculate median survival 

median_summary_noIPW<-kmplot_median_CI(survfit(Surv(time0_to_death_weeks,DeathInd)~cohort, data = ptData2), digits=2)
median_summary_yesIPW<-kmplot_median_CI(survfit(Surv(time0_to_death_weeks,DeathInd)~cohort, data = ptData2, weights = ptData2$sw), digits=2)

```

Without IPW, the median survival of "wait" and "no wait" cohorts were
`r median_summary_noIPW$"cohort=wait"`, and
`r median_summary_noIPW$"cohort=no_wait"`, respectively. Patients who
waited lived substantially longer.With IPW, however, the median survival
decreased slightly in wait cohort
(`r median_summary_yesIPW$"cohort=wait"`), and increased quite a bit in
no wait cohort (`r median_summary_yesIPW$"cohort=no_wait"`). Therefore,
the difference in the median survival between the two cohorts is
attenuated with IPW.

### Effect of 1L before test result become available

```{r secondary-coxph}
#| echo: false
#| eval: true


#Crude fit 

fit2<-coxph(Surv(time0_to_death_weeks,DeathInd)~cohort, data = ptData2, weights=ptData2$sw, robust = T, x=TRUE)
summary_fit2<-coxph.ci.coef(fit1,x.name="cohortno_wait",digits=3,return_num_binary_x=FALSE,robust=TRUE)
summary_fit2<-summary_fit2["HR(95%CI)"]

```

Using the IPW, we fitted a Cox PH model. The resulting
hazard rate (95% confidence interval) of death by proceeding to 1L
before receiving valid test result was `r summary_fit2`. Since the null
value 1 is included in the 95% CI, we conclude that waiting or not waiting for valid test result proceeding to 1L did not cause much difference in survival. 

Since the type of 1L therapy also affects survival, we show the 1L therapy distribution in the two IPW populations in the next subsection.

\

### 1L therapy distribution

```{r secondary-1L-code}
#| echo: false
#| eval: true
#| include: false

#Get the most updated classification Wally did for us


#Make sure everything is categorized
table(ptData2$FirstLineTherapyGroup, useNA = "ifany") #1063 NAs
# Use my old data
#see if there are any that were not observed in the new grouping
my.dictionary<-readRDS("../../EDA_V9/1Lgroup_dictionary_new_all.rds")

#Let's switch
ptData2[,FirstLineTherapyGroup_old_and_new:=FirstLineTherapyGroup]
this_group<-my.dictionary[,final]
names(this_group)<-my.dictionary$FirstLineTherapy
ptData2[is.na(FirstLineTherapyGroup),FirstLineTherapyGroup_old_and_new:=this_group[LineName]]
#Make sure verything is categorized
table(ptData2$FirstLineTherapyGroup_old_and_new, useNA = "ifany") #Lots of NA
# saveRDS(ptData2,"ptData2_landmark.rds")

plot_out<-wait_trt_dist_plot_facet(
    dat=ptData2[,.(cohort,FirstLineTherapyGroup_old_and_new,sw)],
    cohort="cohort",
    geom_text_location_prop=0.7,
    this.fontsize=3,
    weight = "sw",
    trim.percent = 5, #must be greater than or equal to 1%. Any treatment with at least 5% of population will be plotted
    therapy_col = "FirstLineTherapyGroup_old_and_new"
  )

```

```{r fig.show="hold", out.width='100%'}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-secondary-1L
#| fig-cap: Figure XX Distribution of 1L therapy received by patients stratified by cohort with IPW applied. Only the treatments that compose more than 5% of either of the two cohorts is shown in the plot.



plot_out
```

Just like the primary analysis, the most common therapies were
chemotherapy, followed by chemo-immunotherapy for both cohorts. However, we observed target therapy from small number of patients in the "no-wait" cohort. This could just be data issue, where some people got tested and found out targetable mutation, but the data did not capture that. For "wait" cohort, the third most common therapy was immunotherapy. 

```{r secondary-target-investigate}
#| eval: false
#| echo: false


#Investigate what's going on
ptData2[cohort=="no_wait" & FirstLineTherapyGroup_old_and_new=="Target",.N] #81 people 
#find out their time-fixed characteristics
flag<-copy(ptData2)
flag<-flag[cohort=="no_wait",]
flag[,cohort:=NULL]  
flag[FirstLineTherapyGroup_old_and_new=="Target",cohort:="Target"] 
flag[is.na(cohort),cohort:="something_else"] 

    tbl_summary(
      data=flag[,.SD,.SDcols=c("cohort",names(covars))],
      by="cohort",
      label=covars,
      missing = "ifany",
      type = list(where(is.numeric) ~ "continuous2"),  # Use "continuous2" for multiple statistics
      statistic = list(
        all_continuous() ~ c("{mean} ({sd})", "{median} ({p25}, {p75})")  # Show both Mean (SD) and Median (Q1, Q3)
      )
    )







bio<-readRDS("../../../Data/Enhanced_AdvNSCLCBiomarkers.rds")
setDT(bio)[, TestType := stringr::str_replace(TestType, "Mass spectrometry", "Mass Spectrometry")]
setDT(bio)[, TestType := stringr::str_replace(TestType, "Other sequencing method", "Other")]

setDT(bio)[ #combine NTRK's
  , 
  BiomarkerName := 
    stringr::str_replace_all(BiomarkerName, 
                             c("NTRK1"="NTRK",
                               "NTRK2"="NTRK",
                               "NTRK3"="NTRK",
                               "NTRK - unknown gene type"="NTRK",
                               "NTRK - other"="NTRK"))
]


flag[,valid_test_date:=pmin(earliest_valid_ResultDate__on_after_time0_PDL1,earliest_valid_ResultDate__on_after_time0_NoPDL1,na.rm = T)]

tmp<-flag[cohort=="Target",.(PatientID,AdvancedDiagnosisDate,valid_test_date, StartDate)]



investigate_pt<-tmp[,PatientID]
for(pt in investigate_pt){
  print(
    tmp[PatientID==pt,]
  )
  
  bio_supset<-bio[PatientID==pt,]
  setkeyv(bio_supset,cols=c("SpecimenCollectedDate","SpecimenReceivedDate","ResultDate"))
  
  #Just show the ones missing result date or result is <= 1L date
  therapy_date<-ptData1[PatientID==pt,StartDate]
  bio_supset<-bio_supset[ResultDate<=therapy_date | is.na(ResultDate),]
  
  
  print(
    bio_supset[,.(PatientID,BiomarkerName,CellType, SpecimenCollectedDate, SpecimenReceivedDate, ResultDate,                   BiomarkerStatus,PercentStaining)]
  )
  readline("[enter]:")
}

#F36DE3098B55D
#FB3E9BEA87698

flag[PatientID=="F36DE3098B55D",.(LineName)] #EGFR
bio[PatientID=="F36DE3098B55D"]

#F05CF759A3240
#F61A0D82CC540 <- this patient received ALK positive therapy. It's result came out 7 days after 1L initation date. So I think the result date is wrong lol
#All other people are not present in the biomarker dataset or missing result Date
pt<-"F05CF759A3240"

bio_supset<-bio[PatientID==pt,]
setkeyv(bio_supset,cols=c("SpecimenCollectedDate","SpecimenReceivedDate","ResultDate"))
therapy_date<-ptData1[PatientID==pt,StartDate]
bio_supset<-bio_supset[ResultDate<=therapy_date | is.na(ResultDate),]

ptData[PatientID==pt, .(observe_valid__before_time0_NoPDL1,observe_valid__before_time0_PDL1) ]
#   observe_valid__before_time0_NoPDL1 observe_valid__before_time0_PDL1
#                               <lgcl>                           <lgcl>
#1:                              FALSE                            FALSE

tmp[PatientID==pt,]
#       PatientID AdvancedDiagnosisDate valid_test_date  StartDate
#          <char>                <IDat>          <IDat>     <IDat>
#1: F05CF759A3240            2020-06-23      2020-07-03 2020-06-26

bio_supset[,.(PatientID,BiomarkerName,CellType, SpecimenCollectedDate, SpecimenReceivedDate, ResultDate,                   BiomarkerStatus,PercentStaining)]
#       PatientID BiomarkerName CellType SpecimenCollectedDate SpecimenReceivedDate ResultDate           BiomarkerStatus PercentStaining
#          <char>        <char>   <char>                <IDat>               <IDat>     <IDat>                    <char>          <char>
#1: F05CF759A3240          EGFR                     2018-04-25           2018-05-09 2018-05-14         Mutation negative                
#2: F05CF759A3240           ALK                     2018-04-25           2018-05-09 2018-05-15     Rearrangement present                
#3: F05CF759A3240          ROS1                     2018-04-25           2018-05-09 2018-05-15 Rearrangement not present                

```

\


# Aim 2

Wally suggested that I do this for subgroups

-   ECOG 0-2
-   ECOG 3-4
-   Albumin $\leq 35$
-   Albumin $> 35$ g/L
-   Asian
-   Female
-   Male
-   No history of smoking
-   History of smoking

As in the case with the Aim 1, the Hispanic/Latino patients were combined with the Other group.

```{r subgroup-primary-code}
#| eval: true
#| include: false

# primary_subgroups<-list(
#   "All"=ptData1,
#   "ECOG (0-2)"=ptData1[ECOG<3,][,ECOG:=NULL],
#   "ECOG (3-4)"=ptData1[ECOG>=3,][,ECOG:=NULL],
#   "Albumin (low)"=ptData1[albumin_binary=="low", ][,albumin_binary:=NULL],
#   "Albumin (normal)"=ptData1[albumin_binary=="normal", ][,albumin_binary:=NULL],
#   "Asian"=ptData1[RaceEthnicity=="AsianNonHisp", ][,RaceEthnicity:=NULL],
#   "Female"=ptData1[Gender=="F",][,Gender:=NULL],
#   "Male"=ptData1[Gender=="M",][,Gender:=NULL],
#   "Smoked"=ptData1[SmokingStatus=="History of smoking",][,SmokingStatus:=NULL],
#   "Never Smoked"=ptData1[SmokingStatus=="No history of smoking",][,SmokingStatus:=NULL]
# )
# 
# 
# 
# source("../whole_analysis_func.R")
# 
# subgroup_analyses_primary<-lapply(primary_subgroups,whole_analysis_func)
# saveRDS(subgroup_analyses_primary,"subgroup_analyses_primary.rds")

subgroup_analyses_primary<-readRDS("subgroup_analyses_primary.rds")
```

```{r subgroup-secondary-code}
#| eval: true
#| include: false

# secondary_subgroups<-list(
#   "All"=ptData2,
#   "ECOG (0-2)"=ptData2[ECOG<3,][,ECOG:=NULL],
#   "ECOG (3-4)"=ptData2[ECOG>=3,][,ECOG:=NULL],
#   "Albumin (low)"=ptData2[albumin_binary=="low", ][,albumin_binary:=NULL],
#   "Albumin (normal)"=ptData2[albumin_binary=="normal", ][,albumin_binary:=NULL],
#   "Asian"=ptData2[RaceEthnicity=="AsianNonHisp", ][,RaceEthnicity:=NULL],
#   "Female"=ptData2[Gender=="F",][,Gender:=NULL],
#   "Male"=ptData2[Gender=="M",][,Gender:=NULL],
#   "Smoked"=ptData2[SmokingStatus=="History of smoking",][,SmokingStatus:=NULL],
#   "Never Smoked"=ptData2[SmokingStatus=="No history of smoking",][,SmokingStatus:=NULL]
# )
# 
# 
# 
# subgroup_analyses_secondary<-lapply(secondary_subgroups,whole_analysis_func)
# saveRDS(subgroup_analyses_secondary,"subgroup_analyses_secondary.rds")


subgroup_analyses_secondary<-readRDS("subgroup_analyses_secondary.rds")


```

\



## Check assumptions {.unlisted .unnumbered style="display:none;"}

First, check the positivity assumption by looking at the love plot. I
generated pdf files titled "primary_cov_plot.pdf" and
"secondary_cov_plot.pdf"

```{r save-subgroup-love-plot}
#| eval: false
#| include: false


#Save the covariance balance plot

primary_loveplots<-lapply(subgroup_analyses_primary,function(x)x$cov_balance_plot)
secondary_loveplots<-lapply(subgroup_analyses_secondary,function(x)x$cov_balance_plot)

for(i in 1:length(primary_loveplots)){
  primary_loveplots[[i]]<- primary_loveplots[[i]]+ggtitle(names(subgroup_analyses_primary)[[i]])
  secondary_loveplots[[i]]<- secondary_loveplots[[i]]+ggtitle(names(subgroup_analyses_secondary)[[i]])

}

library(ggpubr)
#Plot 6 on each page 
n_per_page<-6
chunk_seq <- function(N, x) {
  v   <- seq_len(N)
  grp <- ceiling(seq_along(v) / x)
  split(v, grp)
}
loop_over_this<-chunk_seq(length(primary_loveplots),n_per_page)


pdf("primary_cov_plot.pdf",width=15, height=10)
for(i in 1:length(loop_over_this)){
  
  index<-loop_over_this[[i]]
  love_plots_out<-primary_loveplots[index]
  
  these_plots<-ggarrange(plotlist=love_plots_out,
                         nrow=3,
                         ncol=2,
                         common.legend = T, legend = "top")
  print(these_plots)

  
}

dev.off()



pdf("secondary_cov_plot.pdf",width=15, height=10)
for(i in 1:length(loop_over_this)){
  
  index<-loop_over_this[[i]]
  love_plots_out<-secondary_loveplots[index]
  
  these_plots<-ggarrange(plotlist=love_plots_out,
                         nrow=3,
                         ncol=2,
                         common.legend = T, legend = "top")
  print(these_plots)

  
}

dev.off()


```

Upon reviewing the love plot, we noticed that SMD is not balanced in
many subgroups. Especially, in primary analysis ECOG 3-4 subgroup has
off balance for advanced diagnosis date (year) and weight lost even
after IPW. Asian subgroup also had off balance for albumin and ECOG, but
hardly any. So we will just focus on ECOG 3-4 subgroup.

Okay actually love plot doesn't work b/c it creates SMD for each factor
level. We should just look at the SMD

```{r primary-subgroup-SMD-check}
#| eval: false
#| include: false



#Identify variable that is not balanced after IPW
primary_subgroup_large_SMD_sw<-
lapply(subgroup_analyses_primary,function(subgroup){
  tmp<-subgroup$SMD_table
  subset<-tmp[,c("this.rownames","SMD_sw")]
  subset<-data.table(subset)
  subset[,SMD_sw:=as.numeric(SMD_sw)]
  subset<-subset[!is.na(SMD_sw),]
  subset[SMD_sw>0.1,]
})
primary_subgroup_large_SMD_sw

for(i in 1:length(subgroup_analyses_primary)){
  print(names(subgroup_analyses_primary)[i])
  print(subgroup_analyses_primary[[i]]$SMD_table)
  readline("[enter]:")
}

#ECOG 3-4: positivity assumption violation on weight lost and race/ethnicity
  # This looks like there isn't enough sample size to capture people who are Asian or have lost weight. just exclude these two variables and the patienst and re0fit them
#Asian : positivity assumption violation on weight lost 
  # This loook slike there isnn't enough people who have lost weight. Just exclude this one person and interpret differently.
#Never smoker : positivity assumption violation on weight lost 
  # Similarly, exclude the 4 people who lost more than 4 people and re-fit. 

```




We observed not enough patients having lost more than 10 lbs or of a particular race in some subgroups, leading to no observation in no-wait cohort. For example, in Asian subgroup, there was only one person who had lost more than 10 lbs (in "wait" cohort). So we re-fitted the model by excluding this single patient and excluding the binary lost $\geq 10 lbs$ variable. Similarly, for ECOG 3-4 subgroup, there was hardly no patients who have lost more than 10 lbs and are Asians. And for Never-smoked subgroup, only 4 people lost more than 10 lbs. Upon re-fitting the model, the SMDs were still off balance in some covariates in ECOG 3-4 and Asian subgroups. However, the SMD balance was achieved in Never-smoked subgroup, with all SMD < 0.1 except for histology (SMD=0.126). There were slightly higher proportion of patients with Non-squamous cell carcinoma in the wait cohort compared to NSCLC histology NOS or Squamous cell carcinoma than no-wait cohort. Thus, we will show the result of this analysis for Never-smoked subgroup. The interpretation will be restricted to among the never-smokers who did not lose more than 10 lbs in the past 6 months before advanced diagnosis date.



```{r primary-subgroup-refit}
#| eval: true
#| include: false



source("../whole_analysis_func_v2.R")
# 
# #For ECOG 3-4
# #Exclude Asians and who have lost significant weight
# tmp<-ptData1[ECOG>=3,][,ECOG:=NULL]
# nrow(tmp) #121
# tmp<-tmp[lost_10lbs=="No"][RaceEthnicity!="AsianNonHisp",]
# nrow(tmp) #101
# #Lost 20 people
# tmp_out<-
# whole_analysis_func_v2(
#   dat=tmp,
#   covars =   list(
#     "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
#     #"lost_10lbs" = "Lost >= 10lbs",
#     # "ECOG"="ECOG",
#     "SmokingStatus"="SmokingStatus",
#     "Histology"="Histology",
#     "Gender"="Gender",
#     #"RaceEthnicity"="Race/Ethnicity",
#     "age_at_advDiag"="Approximate age at Advanced Diagnosis",
#     "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
#   )
#   )
# 
# tmp_out$SMD_table #advnaced diangosis year =0.367, and smoking status smd= 0.285
# #Let's not do them.


#For Asian
tmp<-ptData1[RaceEthnicity=="AsianNonHisp", ][,RaceEthnicity:=NULL]
nrow(tmp) #72
tmp<-tmp[lost_10lbs=="No"]
nrow(tmp) #71
#Lost 1 person
tmp_out<-
whole_analysis_func_v2(
  dat=tmp,
  covars =   list(
    "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
    #"lost_10lbs" = "Lost >= 10lbs",
    "ECOG"="ECOG",
    "SmokingStatus"="SmokingStatus",
    "Histology"="Histology",
    "Gender"="Gender",
    #"RaceEthnicity"="Race/Ethnicity",
    "age_at_advDiag"="Approximate age at Advanced Diagnosis",
    "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
  )
  )

# tmp_out$SMD_table #Albumin SMD=0.321, 
#Let's not do them.


#Never smoked
tmp<-ptData1[SmokingStatus=="No history of smoking",][,SmokingStatus:=NULL]
nrow(tmp) # 379
tmp<-tmp[lost_10lbs=="No"]
nrow(tmp) #379
#Lost 4 people
tmp_out<-
whole_analysis_func_v2(
  dat=tmp,
  covars =   list(
    "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
    #"lost_10lbs" = "Lost >= 10lbs",
    "ECOG"="ECOG",
    # "SmokingStatus"="SmokingStatus",
    "Histology"="Histology",
    "Gender"="Gender",
    "RaceEthnicity"="Race/Ethnicity",
    "age_at_advDiag"="Approximate age at Advanced Diagnosis",
    "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
  )
  )
tmp_out$SMD_table #finally! 
#This one has SMD below 0.1, or the biggest one is histology with SMD = 0.126.
#Let's use them. 

subgroup_analyses_primary$`Never Smoked`<-tmp_out



```


\

What about secondary analysis? Do the same thing.

```{r secondary-subgroup-SMD-check}
#| eval: false
#| include: false



#Identify variable that is not balanced after IPW
secondary_subgroup_large_SMD_sw<-
lapply(subgroup_analyses_secondary,function(subgroup){
  tmp<-subgroup$SMD_table
  subset<-tmp[,c("this.rownames","SMD_sw")]
  subset<-data.table(subset)
  subset[,SMD_sw:=as.numeric(SMD_sw)]
  subset<-subset[!is.na(SMD_sw),]
  subset[SMD_sw>0.1,]
})
secondary_subgroup_large_SMD_sw #unbalanced SMD found in ECOG 3-4 and Asian subgroups


for(i in 1:length(subgroup_analyses_secondary)){
  print(names(subgroup_analyses_secondary)[i])
  print(subgroup_analyses_secondary[[i]]$SMD_table)
  readline("[enter]:")
}

#ECOG 3-4: positivity assumption violation on race/ethnicity. No Asian/Non-Hispanic observed in no-wait cohort
  # Just exclude them. Due to small sample size. There are 20 asians in wait cohort only.
#Asian : positivity assumption violation on weight lost. No one lost more than 10 lbs in no-wait cohort. 
  # Exclude the two patients who have lost 10 lbs.

```



```{r secondary-subgroup-refit}
#| eval: true
#| include: false



source("../whole_analysis_func_v2.R")

#For ECOG 3-4
#Exclude Asians 
tmp<-ptData2[ECOG>=3,][,ECOG:=NULL]
nrow(tmp) #536
tmp<-tmp[RaceEthnicity!="AsianNonHisp",]
nrow(tmp) #516
#Lost 20 people
tmp_out<-
whole_analysis_func_v2(
  dat=tmp,
  covars =   list(
    "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
    #"lost_10lbs" = "Lost >= 10lbs",
    # "ECOG"="ECOG",
    "SmokingStatus"="SmokingStatus",
    "Histology"="Histology",
    "Gender"="Gender",
    #"RaceEthnicity"="Race/Ethnicity",
    "age_at_advDiag"="Approximate age at Advanced Diagnosis",
    "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
  )
  )

tmp_out$SMD_table #Good!
subgroup_analyses_secondary$`ECOG (3-4)`<-tmp_out


#For Asian
tmp<-ptData2[RaceEthnicity=="AsianNonHisp", ][,RaceEthnicity:=NULL]
nrow(tmp) #283
tmp<-tmp[lost_10lbs=="No"]
nrow(tmp) #81
#Lost 2 people
tmp_out<-
whole_analysis_func_v2(
  dat=tmp,
  covars =   list(
    "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
    #"lost_10lbs" = "Lost >= 10lbs",
    "ECOG"="ECOG",
    "SmokingStatus"="SmokingStatus",
    "Histology"="Histology",
    "Gender"="Gender",
    #"RaceEthnicity"="Race/Ethnicity",
    "age_at_advDiag"="Approximate age at Advanced Diagnosis",
    "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
  )
  )

tmp_out$SMD_table #the age is a bit off balance (SMD=0.141) but otherwise it's good! 
subgroup_analyses_secondary$Asian<-tmp_out


```


Similar to the subgroup analyses using the primary inclusion criteria, there were only small number of patients who ever lost $\geq$ 10 lbs (ECOG 3-4 and Asians subgroups) and there were only few Asian patients (ECOG 3-4 subgroup). Thus, we re-fitted the models by removing these patients and the variable from constructing the IPW. By doing so, we were able to achieve the SMD balance in all covariate except for a bit high SMD in age at baseline in Asian subgroup (SMD=0.141). But it was small enough so we decided to present the result. 


\


## Result


We checked for the positivity assumption and SMD balance to make sure that I can make causal inference. 

Some confounders in ECOG 3-4 and Asian subgroups violated positivity assumption under both the primary and secondary inclusion criteria, and likewise for never-smoked supbgroup under the secondary inclusion criteria. Thus, we cannot make causal inference for them. Below, we provide results excluding these cases.

```{r subgroup-tbl}
#| eval: true


#Here we provide result of the Aim 2!

tmp<-
data.table(
  "Patient Population"=names(subgroup_analyses_primary),
  "Primary inclusion criteria"=sapply(subgroup_analyses_primary,function(x)x$HR_95_CI["HR(95%CI)"]),
  "Secondary inclusion criteria"=sapply(subgroup_analyses_secondary,function(x)x$HR_95_CI["HR(95%CI)"])
) 
tmp[`Patient Population`=="All",`Patient Population`:="All (Aim 1)"]

# #Remove ECOG 3-4, Asian, and Never smoker results from primary analysis
# tmp[`Patient Population` %in% c("ECOG (3-4)","Asian"), `Primary inclusion criteria`:=""]
# 

#Remove ECOG 3-4 and Asian results from secondary analysis
# tmp[`Patient Population` %in% c("ECOG (3-4)","Asian"), `Secondary inclusion criteria`:=""]



# tmp|> 
#   kable(caption = "Table XX. Hazard ratio and 95% confidence interval of proceeding to 1L without waiting for valid test results. Empty cells mean that causal analysis was impossible due to positivity assumption violation in some confounders.")
# 


tmp |> 
  gt() |> 
  # footnote on the Never-smoker subgroup in primary inclusion criteria
  tab_footnote(
    footnote = "Excluded 4 patients who lost >= 10 lbs at baseline. The interpretation should be among never-smokers who didn't lost substantial weight.",
    locations = cells_body(
      columns = `Primary inclusion criteria`,
      rows    = `Patient Population` == "Never Smoked"
    ),
    placement = "right"
  )  |> 
  # footnote on the Never-smoker subgroup in ECOG 3-4 for secondary inclusion criteria
  tab_footnote(
    footnote = "Excluded 20 Asian/Non-Hispanic patients. The interpretation should be fairly sick patients who are not Asian/Non-Hispanics.",
    locations = cells_body(
      columns = `Secondary inclusion criteria`,
      rows    = `Patient Population` == "ECOG (3-4)"
    ),
    placement = "right"
  )    |> 
  # footnote on the Never-smoker subgroup in Asian for secondary inclusion criteria
  tab_footnote(
    footnote = "Excluded 2 patients who lost >= 10 lbs at baseline. The interpretation should be Asian/Non-Hispanics who did not lose substantial weight.",
    locations = cells_body(
      columns = `Secondary inclusion criteria`,
      rows    = `Patient Population` == "Asian"
    ),
    placement = "right"
  )   |> 
  # footnote on the ECOG 3-4 subgroup for primary inclusion criteria
  tab_footnote(
    footnote = "Excluded Asian/Non-hispanics (N=5) and those who lost more than 10 lbs (N=15) because there were only small number of them and they were all in wait cohort. SMD balanced not achived for Smoking status (SMD=0.285) and year of advanced diagnosis (SMD=0.367). The interpretation should be among those who are substantially sick but haven't lost more than 10 lbs and are not Asian/Non-Hispanics.",
    locations = cells_body(
      columns = `Primary inclusion criteria`,
      rows    = `Patient Population` == "ECOG (3-4)"
    ),
    placement = "right"
  ) |> 
  # footnote on Asian for primary inclusion criteria
  tab_footnote(
    footnote = "Excluded lost more than 10 lbs (N=1) who was in wait cohort. SMD balanced not achived for Albumin (SMD=0.321). The interpretation should be given as among Asian/Non-Hispanics who did not lose substantial weight.",
    locations = cells_body(
      columns = `Primary inclusion criteria`,
      rows    = `Patient Population` == "Asian"
    ),
    placement = "right"
  ) |> 
  as_raw_html()
  

```

As we can see in the Table, there isn't any evidence for increased
hazard of death by proceeding to 1L therapy without waiting for valid
test result except for the Asian subgroup under primary inclusion criteria. However, there were substantial SMD imbalance in smoking status and year of advanced diagnosis so we won't take this result as notable.

\

# Aim 3

Treatment availability differed substantially over time, reflecting rapid advances in therapies for targetable mutations over the past decade. Therefore, we stratified our analysis by calendar year (2011–2022). We used the same confounders used in Aim 1 to construct IPW.

```{r subgroup-diag-year}
#| eval: true
#| include: false


# these_years<-unique(ptData1$AdvancedDiagnosis_year) |> sort()
# subgroup_diag_year<-
# lapply(these_years,function(this_year){
#   ptData1[AdvancedDiagnosis_year==this_year,][,AdvancedDiagnosis_year_rescale:=NULL]
# })
# 
# primary<-lapply(subgroup_diag_year,whole_analysis_func)
# saveRDS(primary,"primary_subgroup_year.rds")
primary<-readRDS("primary_subgroup_year.rds")


# subgroup_diag_year<-
# lapply(these_years,function(this_year){
#   ptData2[AdvancedDiagnosis_year==this_year,][,AdvancedDiagnosis_year_rescale:=NULL]
# })
# secondary<-lapply(subgroup_diag_year,whole_analysis_func)
# saveRDS(secondary,"secondary_subgroup_year.rds")
secondary<-readRDS("secondary_subgroup_year.rds")



#Check for positivity assumption
#Identify variable that is not balanced after IPW
these_years<-unique(ptData1$AdvancedDiagnosis_year) |> sort()

primary_subgroup_large_SMD_sw<-
lapply(primary,function(subgroup){
  tmp<-subgroup$SMD_table
  subset<-tmp[,c("this.rownames","SMD_sw")]
  subset<-data.table(subset)
  subset[,SMD_sw:=as.numeric(SMD_sw)]
  subset<-subset[!is.na(SMD_sw),]
  subset[SMD_sw>0.1,]
})
names(primary_subgroup_large_SMD_sw)<-these_years
primary_subgroup_large_SMD_sw



for(i in 1:length(primary)){
  print(these_years[i])
  print(primary[[i]]$SMD_table)
  readline("[enter]:")
}
#2011 :positivity assumption violation on Histology. No one in no-wait cohort has observed Squamous cell carcinoma. No one in wait cohort observed NSCLC histology NOS and Black/non-hispanic.
  # remove histology = NSCLC histology NOS and Squamous cell carcinoma and race ethnicity. 
#2012: positivity assumption violation on weight loss, histology and race/ethnicity. Lots of no observation in no-wait cohort
  #remove histology = NSCLC histology NOS and Squamous cell carcinoma 
  #remove losing weight
#2013: positivity assumption violation on histology and race/ethnicity. 
  # remove NSCLC histology NOS and Asian
#2014: positivity assumption violation on histology
  # remove NSCLC histology 
#2015 : SMD violation on smoking status & race/ethinicity
  # remove one asian
  # there's SMD imbalance on Smoking history. May need to remove No history of smoking
#2016: positivity assumption violation on weight loss
  # remove weight. two people
#2017: SMD violation on weight loss
  # remove weight. 10 people
#2018: SMD violation on ECOG and histology
  # If I remove weight and asian, would that improve my SMD?
#2019: GOOD
#2020: SMD violation on albumin, histology, race/ethnicity, age. 
  # if I remove weight and Aisna, would that make things better?
#2021: SMD violation on race/ethnicity and age. 
  #Remove Asian?
#2022: positivity assumption violation on histology
  # Remove NSCLC histology NOS   ? positivity assumption violation
  # May need to remove weight lost and asian non-hispanic. 
#Only one year was good. Drop it. 






#Secondary analysis?
secondary_subgroup_large_SMD_sw<-
lapply(secondary,function(subgroup){
  tmp<-subgroup$SMD_table
  subset<-tmp[,c("this.rownames","SMD_sw")]
  subset<-data.table(subset)
  subset[,SMD_sw:=as.numeric(SMD_sw)]
  subset<-subset[!is.na(SMD_sw),]
  subset[SMD_sw>0.1,]
})
names(secondary_subgroup_large_SMD_sw)<-these_years
secondary_subgroup_large_SMD_sw



for(i in 1:length(secondary)){
  print(these_years[i])
  print(secondary[[i]]$SMD_table)
  readline("[enter]:")
}
#2011 :positivity assumption violation on Histology,
  # remove Squamous cell carcinoma
#2012: positivity assumption violation on weight loss, histology, and race/ethnicity. 
  #Remove them all whoever we see little
#2013: SMD violation on albumin
  # well, it's only albumin and it's just 0.14... let's see if removing lost > 10lbs helsp 
#2014: Good
#2015 : Good
#2016: Good
#2017: Good
#2018: Good
#2019: Good
#2020: Good
#2021: Good
#2022: Good


```


```{r subgroup-year-refit}
#| eval: true
#| include: false


source("../whole_analysis_func_v2.R")

#Try to refit them by excluding people 

#For primary inclusion criteria:
#2011 :positivity assumption violation on Histology. No one in no-wait cohort has observed Squamous cell carcinoma. No one in wait cohort observed NSCLC histology NOS and Black/non-hispanic.
  # remove histology = NSCLC histology NOS and Squamous cell carcinoma and race ethnicity. 
#2012: positivity assumption violation on weight loss, histology and race/ethnicity. Lots of no observation in no-wait cohort
  #remove histology = NSCLC histology NOS and Squamous cell carcinoma 
  #remove losing weight
#2013: positivity assumption violation on histology and race/ethnicity. 
  # remove NSCLC histology NOS and Asian
#2014: positivity assumption violation on histology
  # remove NSCLC histology 
#2015 : SMD violation on smoking status & race/ethinicity
  # remove one asian
  # there's SMD imbalance on Smoking history. May need to remove No history of smoking
#2016: positivity assumption violation on weight loss
  # remove weight. two people
#2017: SMD violation on weight loss
  # remove weight. 10 people
#2018: SMD violation on ECOG and histology
  # not bigger than 0.2, so leave it.
#2019: GOOD
#2020: SMD violation on albumin, histology, race/ethnicity, age. 
  # if I remove weight and Aisna, would that make things better?
#2021: SMD violation on race/ethnicity and age. 
  #all under 0.2. Leave it.
#2022: positivity assumption violation on histology
  # Remove NSCLC histology NOS   ? positivity assumption violation
  # May need to remove weight lost and asian non-hispanic. 


names(primary)<-these_years

# #For 2011
# # remove histology = NSCLC histology NOS and Squamous cell carcinoma and race ethnicity. 
# #Exclude black 
# tmp<-ptData1[AdvancedDiagnosis_year==2011,][,AdvancedDiagnosis_year_rescale:=NULL]
# nrow(tmp) #16
# tmp<-tmp[Histology=="Non-squamous cell carcinoma",]
# nrow(tmp) #14
# tmp<-tmp[RaceEthnicity!="BlackNonHisp",]
# nrow(tmp) #13
# #Lost 3 people
# #there's no one who lost more than 10 lbs 
# tmp_out<-
# whole_analysis_func_v2(
#   dat=tmp,
#   covars =   list(
#     "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
#     #"lost_10lbs" = "Lost >= 10lbs",
#     "ECOG"="ECOG",
#     "SmokingStatus"="SmokingStatus",
#     # "Histology"="Histology",
#     "Gender"="Gender",
#     #"RaceEthnicity"="Race/Ethnicity",
#     "age_at_advDiag"="Approximate age at Advanced Diagnosis",
#     "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
#   )
#   )
# 
# tmp_out$SMD_table #forget it. Imbalance crazy. Just don't report 2011. 
# #Not enough patient to balance covariates. 
# 
# 
# #For 2012
#   #remove histology = NSCLC histology NOS and Squamous cell carcinoma 
#   #remove losing weight
# tmp<-ptData1[AdvancedDiagnosis_year==2012,][,AdvancedDiagnosis_year_rescale:=NULL]
# nrow(tmp) #47
# tmp<-tmp[Histology=="Non-squamous cell carcinoma",]
# nrow(tmp) #43
# tmp$lost_10lbs |> table()
# # No Yes 
# # 42   1 
# tmp<-tmp[lost_10lbs=="No",]
# nrow(tmp) #42
# #Lost 5 patients
# #there's no one who lost more than 10 lbs 
# tmp_out<-
# whole_analysis_func_v2(
#   dat=tmp,
#   covars =   list(
#     "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
#     #"lost_10lbs" = "Lost >= 10lbs",
#     "ECOG"="ECOG",
#     "SmokingStatus"="SmokingStatus",
#     # "Histology"="Histology",
#     "Gender"="Gender",
#     #"RaceEthnicity"="Race/Ethnicity",
#     "age_at_advDiag"="Approximate age at Advanced Diagnosis",
#     "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
#   )
#   )
# 
# tmp_out$SMD_table #forget it. Imbalance crazy. Just don't report 2012. 
# #Not enough patient to balance covariates. 
# 
# 



#For 2013
# remove NSCLC histology NOS and Asian
tmp<-ptData1[AdvancedDiagnosis_year==2013,][,AdvancedDiagnosis_year_rescale:=NULL]
nrow(tmp) #54
tmp<-tmp[Histology!="NSCLC histology NOS",]
nrow(tmp) #52
tmp<-tmp[RaceEthnicity!="AsianNonHisp"]
nrow(tmp) #50
#Lost 4 patients
tmp$lost_10lbs |> table() #No one lost substantial weight 

tmp<-tmp[Histology!="Squamous cell carcinoma",]
nrow(tmp) #44
#Lost 10 people in total

tmp_out<-
whole_analysis_func_v2(
  dat=tmp,
  covars =   list(
    "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
    "lost_10lbs" = "Lost >= 10lbs",
    "ECOG"="ECOG",
    "SmokingStatus"="SmokingStatus",
    # "Histology"="Histology",
    "Gender"="Gender",
    #"RaceEthnicity"="Race/Ethnicity",
    "age_at_advDiag"="Approximate age at Advanced Diagnosis",
    "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
  )
  )

tmp_out$SMD_table #I could do it. 
primary$`2013`<-tmp_out








#For 2014
# remove NSCLC histology  and weight
tmp<-ptData1[AdvancedDiagnosis_year==2014,][,AdvancedDiagnosis_year_rescale:=NULL]
nrow(tmp) #84
tmp$Histology |> table()
tmp<-tmp[Histology=="Non-squamous cell carcinoma",]
nrow(tmp) #80
tmp<-tmp[lost_10lbs=="No",]
nrow(tmp) #78
#Lost 6 patients

tmp_out<-
whole_analysis_func_v2(
  dat=tmp,
  covars =   list(
    "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
    # "lost_10lbs" = "Lost >= 10lbs",
    "ECOG"="ECOG",
    "SmokingStatus"="SmokingStatus",
    # "Histology"="Histology",
    "Gender"="Gender",
    "RaceEthnicity"="Race/Ethnicity",
    "age_at_advDiag"="Approximate age at Advanced Diagnosis",
    "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
  )
  )

tmp_out$SMD_table #I could do it. 
primary$`2014`<-tmp_out







#For 2015
  # remove one asian
  # there's SMD imbalance on Smoking history. May need to remove No history of smoking
tmp<-ptData1[AdvancedDiagnosis_year==2015,][,AdvancedDiagnosis_year_rescale:=NULL]
nrow(tmp) #136
tmp<-tmp[RaceEthnicity!="AsianNonHisp",]
nrow(tmp) #135
#Lost 1 person

tmp_out<-
whole_analysis_func_v2(
  dat=tmp,
  covars =   list(
    "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
    "lost_10lbs" = "Lost >= 10lbs",
    "ECOG"="ECOG",
    "SmokingStatus"="SmokingStatus",
    "Histology"="Histology",
    "Gender"="Gender",
    "RaceEthnicity"="Race/Ethnicity",
    "age_at_advDiag"="Approximate age at Advanced Diagnosis",
    "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
  )
  )

tmp_out$SMD_table #I could do it. 
primary$`2015`<-tmp_out







#For 2016
# remove weight. two people
tmp<-ptData1[AdvancedDiagnosis_year==2016,][,AdvancedDiagnosis_year_rescale:=NULL]
nrow(tmp) #233
tmp<-tmp[lost_10lbs=="No",]
nrow(tmp) #231
#Lost 2 patients
primary$`2016`$SMD_table

tmp_out<-
whole_analysis_func_v2(
  dat=tmp,
  covars =   list(
    "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
    # "lost_10lbs" = "Lost >= 10lbs",
    "ECOG"="ECOG",
    "SmokingStatus"="SmokingStatus",
    "Histology"="Histology",
    "Gender"="Gender",
    "RaceEthnicity"="Race/Ethnicity",
    "age_at_advDiag"="Approximate age at Advanced Diagnosis",
    "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
  )
  )

tmp_out$SMD_table #Good
primary$`2016`<-tmp_out











#For 2017
# remove weight.
tmp<-ptData1[AdvancedDiagnosis_year==2017,][,AdvancedDiagnosis_year_rescale:=NULL]
nrow(tmp) #426
tmp<-tmp[lost_10lbs=="No",]
nrow(tmp) #416
#Lost 10 patients
primary$`2017`$SMD_table

tmp_out<-
whole_analysis_func_v2(
  dat=tmp,
  covars =   list(
    "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
    # "lost_10lbs" = "Lost >= 10lbs",
    "ECOG"="ECOG",
    "SmokingStatus"="SmokingStatus",
    "Histology"="Histology",
    "Gender"="Gender",
    "RaceEthnicity"="Race/Ethnicity",
    "age_at_advDiag"="Approximate age at Advanced Diagnosis",
    "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
  )
  )

tmp_out$SMD_table #Good
primary$`2017`<-tmp_out







#For 2020
primary$`2020`$SMD_table
# remove Asians?
tmp<-ptData1[AdvancedDiagnosis_year==2020,][,AdvancedDiagnosis_year_rescale:=NULL]
nrow(tmp) #394
tmp<-tmp[RaceEthnicity!="AsianNonHisp",]
nrow(tmp) #386
#Lost 8 patients


tmp_out<-
whole_analysis_func_v2(
  dat=tmp,
  covars =   list(
    "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
    "lost_10lbs" = "Lost >= 10lbs",
    "ECOG"="ECOG",
    "SmokingStatus"="SmokingStatus",
    "Histology"="Histology",
    "Gender"="Gender",
    "RaceEthnicity"="Race/Ethnicity",
    "age_at_advDiag"="Approximate age at Advanced Diagnosis",
    "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
  )
  )

tmp_out$SMD_table #Good enough. all under 0.2
primary$`2020`<-tmp_out




#For 2022
primary$`2022`$SMD_table
# remove Asians?
tmp<-ptData1[AdvancedDiagnosis_year==2022,][,AdvancedDiagnosis_year_rescale:=NULL]
nrow(tmp) #334
tmp<-tmp[Histology!="NSCLC histology NOS",]
nrow(tmp) #320
#Lost 14 patients


tmp_out<-
whole_analysis_func_v2(
  dat=tmp,
  covars =   list(
    "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
    "lost_10lbs" = "Lost >= 10lbs",
    "ECOG"="ECOG",
    "SmokingStatus"="SmokingStatus",
    "Histology"="Histology",
    "Gender"="Gender",
    "RaceEthnicity"="Race/Ethnicity",
    "age_at_advDiag"="Approximate age at Advanced Diagnosis",
    "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
  )
  )

tmp_out$SMD_table #Good enough. all under 0.2
primary$`2022`<-tmp_out







### ----- Secondary

#Do for 2011, 2012, 2013. 
names(secondary)<-these_years

# #For 2011
# secondary$`2011`$SMD_table
# tmp<-ptData2[AdvancedDiagnosis_year==2011,][,AdvancedDiagnosis_year_rescale:=NULL]
# nrow(tmp) #79
# tmp<-tmp[Histology!="Squamous cell carcinoma",]
# nrow(tmp) #76
# #Lost 3 patients
# tmp$lost_10lbs |> table() #No one lost <= 10 lbs
# 
# tmp_out<-
# whole_analysis_func_v2(
#   dat=tmp,
#   covars =   list(
#     "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
#     # "lost_10lbs" = "Lost >= 10lbs",
#     "ECOG"="ECOG",
#     "SmokingStatus"="SmokingStatus",
#     "Histology"="Histology",
#     "Gender"="Gender",
#     "RaceEthnicity"="Race/Ethnicity",
#     "age_at_advDiag"="Approximate age at Advanced Diagnosis",
#     "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
#   )
#   )
# tmp_out$SMD_table #Not good for gender. 
# #Exclude Asians and black to see if that makes it better.
# # tmp<-tmp[!RaceEthnicity %in% c("AsianNonHisp","BlackNonHisp"),]
# tmp<-tmp[!RaceEthnicity %in% c("AsianNonHisp"),]
# 
# nrow(tmp) #71
# #Lost 8 people in total
# 
# tmp_out<-
# whole_analysis_func_v2(
#   dat=tmp,
#   covars =   list(
#     "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
#     "lost_10lbs" = "Lost >= 10lbs",
#     "ECOG"="ECOG",
#     "SmokingStatus"="SmokingStatus",
#     "Histology"="Histology",
#     "Gender"="Gender",
#     "RaceEthnicity"="Race/Ethnicity",
#     "age_at_advDiag"="Approximate age at Advanced Diagnosis",
#     "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
#   )
#   )
# tmp_out$SMD_table #Not good for gender. #Skip this year?
# 
# 
# 
# 
# 



#For 2012
secondary$`2012`$SMD_table #Remove weight loss and NSCLC histology NOS and AsianNonHisp 
tmp<-ptData2[AdvancedDiagnosis_year==2012,][,AdvancedDiagnosis_year_rescale:=NULL]
nrow(tmp) #160
tmp<-tmp[lost_10lbs=="No",]
nrow(tmp) #158

tmp<-tmp[Histology!="NSCLC histology NOS",]
nrow(tmp) #153

tmp<-tmp[RaceEthnicity!="AsianNonHisp",]
nrow(tmp) #147

#Lost 13 people

tmp_out<-
whole_analysis_func_v2(
  dat=tmp,
  covars =   list(
    "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
    # "lost_10lbs" = "Lost >= 10lbs",
    "ECOG"="ECOG",
    "SmokingStatus"="SmokingStatus",
    "Histology"="Histology",
    "Gender"="Gender",
    "RaceEthnicity"="Race/Ethnicity",
    "age_at_advDiag"="Approximate age at Advanced Diagnosis",
    "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
  )
  )
tmp_out$SMD_table #Good!
secondary$`2012`<-tmp_out






# #For 2013
# secondary$`2013`$SMD_table #Let's see if removing lost weight will help balance albumin more. 
# tmp<-ptData2[AdvancedDiagnosis_year==2013,][,AdvancedDiagnosis_year_rescale:=NULL]
# nrow(tmp) #246
# tmp<-tmp[lost_10lbs=="No",]
# nrow(tmp) #242
# #Lost 4 people
# 
# tmp_out<-
# whole_analysis_func_v2(
#   dat=tmp,
#   covars =   list(
#     "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
#     # "lost_10lbs" = "Lost >= 10lbs",
#     "ECOG"="ECOG",
#     "SmokingStatus"="SmokingStatus",
#     "Histology"="Histology",
#     "Gender"="Gender",
#     "RaceEthnicity"="Race/Ethnicity",
#     "age_at_advDiag"="Approximate age at Advanced Diagnosis",
#     "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
#   )
#   )
# tmp_out$SMD_table #No. just use the original.
# 
# 

```

For primary inclusion criterion, we remove 2011 and 2012 data and report the rest. 
For the secondary inclusion criterion, remove 2011. 


```{r last-figure-code}
#| echo: false
#| eval: true




these_years<-unique(ptData2$AdvancedDiagnosis_year) |> sort()
tmptmp<-
data.table(
  "Advanced diagnosis year"=these_years,
  "Primary"=sapply(primary,function(x)x$HR_95_CI["HR(95%CI)"]),
  "secondary"=sapply(secondary,function(x)x$HR_95_CI["HR(95%CI)"])
) 


primary_plot<-
sapply(tmptmp$Primary,function(x){
  all_numbers<-stringr::str_extract_all(x,"-?\\d*\\.?\\d+([eE][+-]?\\d+)?")[[1]]
  all_numbers<-as.numeric(all_numbers)
  names(all_numbers)<-c("est","lwr","upr")
  all_numbers
})
primary_plot<-t(primary_plot)
primary_plot<-
data.table(
  year=tmptmp$`Advanced diagnosis year`,
  primary_plot
)
primary_plot<-primary_plot[year>=2013,] #Only show for just 2013 and onward.



secondary_plot<-
  sapply(tmptmp$secondary,function(x){
    all_numbers<-stringr::str_extract_all(x,"-?\\d*\\.?\\d+([eE][+-]?\\d+)?")[[1]]
    all_numbers<-as.numeric(all_numbers)
    names(all_numbers)<-c("est","lwr","upr")
    all_numbers
  })
secondary_plot<-t(secondary_plot)
secondary_plot<-
  data.table(
    year=tmptmp$`Advanced diagnosis year`,
    secondary_plot
  )
secondary_plot<-secondary_plot[year>=2012,] #Only show for just 2012 and onward.



```






```{r fig.show="hold", out.width='49%',  fig.height=6}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-subgroup-by_year
#| fig-cap: Figure XX. HR(95%CI) of those who don't wait for valie test result prior to initiating 1L therapy, grouped by advanced diagnosis year. Samples were collected using A) primary inclusion criteria, B) secondary inclusion criteria




#Primary analysis
ggplot(primary_plot, aes(x=factor(year), y=est)) + 
  geom_errorbar(aes(ymin=lwr, ymax=upr), width=.1) +
  geom_line() +
  geom_point()+
  geom_hline(yintercept = 1,color="red")  +
  ylab("Survival rate (95% CI)")+
  xlab("Diagnosis year")+
  theme_minimal() + 
  ggtitle("Primar analysis")


#Secondary analysis
ggplot(secondary_plot, aes(x=factor(year), y=est)) + 
  geom_errorbar(aes(ymin=lwr, ymax=upr), width=.1) +
  geom_line() +
  geom_point()+
  geom_hline(yintercept = 1,color="red")  +
  ylab("Survival rate (95% CI)")+
  xlab("Diagnosis year")+
  theme_minimal() + 
  ggtitle("Secondary analysis")

```

As we can see in the plot above, there isn't much trend in hazard ratio.






\

# Follow up from 2025/04/30 meeting


## target therapy in no-wait cohort exploration

**Q**: In the Secondary analysis of Aim 1, there are people in "no_wait" cohort who received targetable therapy (Figure \@ref(fig:fig-secondary-1L)). Is this just data error? Or is there some particular demographics that demonstrates this?



**A**: We just looked at the baseline characteristics of all covariates we used. It's shown in Table \@ref(tab:tbl-secondary-target-investigate-copy). Based on the table, it seems like the wait patients patients who either didn't receive any therapy or received something else than target therapy have the following that are opposite to those who received targeted therapy.:

- higher proportion of having history of smoking than not
- higher proportion of Squamous cell carcinoma than other kinds
- slightly more male than female



```{r tbl-secondary-target-investigate-copy, results='asis'}
#| eval: true
#| echo: false


#Investigate what's going on
# ptData2[cohort=="no_wait" & FirstLineTherapyGroup_old_and_new=="Target",.N] #81 people 
#find out their time-fixed characteristics

flag<-copy(ptData2)
flag<-flag[cohort=="no_wait",]
flag[,cohort:=NULL]  
flag[FirstLineTherapyGroup_old_and_new=="Target",cohort:="Target"] 
flag[is.na(cohort),cohort:="something_else"] 

tbl_summary(
  data=flag[,.SD,.SDcols=c("cohort",names(covars))],
  by="cohort",
  label=covars,
  missing = "ifany",
  type = list(where(is.numeric) ~ "continuous2"),  # Use "continuous2" for multiple statistics
  statistic = list(
    all_continuous() ~ c("{mean} ({sd})", "{median} ({p25}, {p75})")  # Show both Mean (SD) and Median (Q1, Q3)
    )
  ) |> 
  as_gt() |> 
  #  tab_header(
  #   title = md("What's the difference between this title and caption?"),
  #   subtitle = md("`gtcars` is an R dataset")
  # ) |>
  tab_caption(caption = md("Table XX. Summary of patient characteristics at baseline. Restricted to 'No-wait' cohort from the Secondary inclusion criteria. The patients were stratified by the type 1L therapy. 'something_else' stratum also contains those who did not receive any 1L therapy.")) |> 
  as_raw_html() |> 
  cat()
```




\


## build KM curve comparing target vs something else therapy for primary inclusion criteria

**Q**: Under the Aim 1, where I conduct the analysis using primary inclusion criteria, I show KM curve of those who received targetable therapy vs not (including those who didn’t) \@ref(fig:fig-secondary-KMplot). Please rebuild by 


1. restricting to only "wait" cohort
2. Include binary indicator variable whether or not the patients has mutation by the time they receive 1L therapy IPW including all baseline demographics + lab values which I am already including.

Additionally, provide 2 by 2 contingency table showing the 1L therapy type (Target vs. not Target) and whether the patient had targetable mutation by time zero. 


**A**:  Sound good. Under the primary inclusion criteria, we selected "wait" cohort and generated a binary variable indicating whether or not patient has targetable mutation at time zero. 




```{r primary-target-vs-notarget-v2}
#| eval: true
#| echo: false
#| include: false


#Try to find time to death of those who received targetable therapy
ptData1_wait<-copy(ptData1)
ptData1_wait<-ptData1_wait[cohort=="wait",]
ptData1_wait<-ptData1_wait[,cohort:=NULL]
ptData1_wait<-ptData1_wait[,cohort:=as.character(NA)]
ptData1_wait[FirstLineTherapyGroup_old_and_new=="Target",cohort:="Target therapy"]
ptData1_wait[is.na(cohort),cohort:="something else"]
ptData1_wait[,cohort:=factor(cohort,levels=c("something else","Target therapy"), labels = c("something else","Target therapy"))]

#Check for their mutation status at baseline. 
#Up to end of week 4 
bio<-readRDS("../../../Data/Enhanced_AdvNSCLCBiomarkers.rds")
setDT(bio)[, TestType := stringr::str_replace(TestType, "Mass spectrometry", "Mass Spectrometry")]
setDT(bio)[, TestType := stringr::str_replace(TestType, "Other sequencing method", "Other")]

setDT(bio)[ #combine NTRK's
  , 
  BiomarkerName := 
    stringr::str_replace_all(BiomarkerName, 
                             c("NTRK1"="NTRK",
                               "NTRK2"="NTRK",
                               "NTRK3"="NTRK",
                               "NTRK - unknown gene type"="NTRK",
                               "NTRK - other"="NTRK"))
]

mutation_positive<-c(
  "Mutation positive",
  "PD-L1 positive",
  "Rearrangement present",
  "Rearrangement positive",
  "Amplification positive",
  "Protein expression positive",
  "PD-L1 positive"
)

#restrict to people of our interest
bio<-bio[PatientID %in% ptData1_wait$PatientID,]
#Merge time 0
bio<-
merge(bio,
      ptData1_wait[,.(PatientID,AdvancedDiagnosisDate)],
      by="PatientID",
      all=T)
#Add 4 weeks after diagnosis date
bio[,week_4:=as.IDate(as.Date(AdvancedDiagnosisDate)+weeks(4))]
#We want all mutation information that are positive and before 4 weeks after advanced diagnosis date
bio<-bio[ResultDate<=week_4 & BiomarkerStatus %in% mutation_positive,]
#Exclude PDL1. It's not target therapy.
bio<-bio[BiomarkerName!="PDL1"]
#these are the people who have targetable mutation
yes_target_wait<-bio[,unique(PatientID)]

ptData1_wait[,targetable_mutation_by_week_4:=FALSE]
ptData1_wait[PatientID %in% yes_target_wait,targetable_mutation_by_week_4:=TRUE]
# ptData1_wait[,table(targetable_mutation_by_week_4)]
# ptData1_wait[,table(cohort,targetable_mutation_by_week_4)]
#                targetable_mutation_by_week_4
#cohort           FALSE TRUE
#  something else  1691  586
#  Target therapy    25  239




# #ECOG and Albumin at time to decide the therapy
# baselineECOG<-readRDS("../../../Data/BaselineECOG.rds")
# baselineECOG<-baselineECOG[PatientID %in% ptData1_wait$PatientID,]
# baselineECOG[ECOGValue=="Unknown",ECOGValue:=NA]
# baselineECOG[,ECOGValue:=as.integer(ECOGValue)]
# setnames(baselineECOG,"ECOGValue","EcogValue")
# setnames(baselineECOG,"ECOGDate","Date")
# baselineECOG[,Date:=as.IDate(Date)]
# 
# ECOG<-readRDS("../../../Data/ECOG.rds")
# ECOG<-ECOG[PatientID %in% ptData1_wait$PatientID,]
# setnames(ECOG,"EcogDate","Date")
# ECOG<-unique(ECOG[,.(PatientID,Date,EcogValue)])
# ECOG[,N:=.N,by=.(PatientID,Date)]
# ECOG[N>1,] #We will take average
# ECOG2<-ECOG[,mean(as.numeric(EcogValue),na.rm=T),by=.(PatientID,Date)]
# ECOG2
# setnames(ECOG2,"V1","EcogValue")
# 
# 
# #get them merged
# both_ECOG<-
#   merge(unique(baselineECOG[,.(PatientID,Date,EcogValue)]),
#         ECOG2[,.(PatientID,Date,EcogValue)],
#         by=c("PatientID","Date"),
#         all=T)
# both_ECOG[,EcogValue.x:=as.numeric(EcogValue.x)]
# both_ECOG[is.na(EcogValue.x),EcogValue.x:=EcogValue.y]
# both_ECOG[,EcogValue.y:=NULL]
# setnames(both_ECOG,"EcogValue.x","EcogValue")
# # rm(list=c("baselineECOG","ECOG"))
# both_ECOG
# 
# test<-ptData1_wait[,.(PatientID,advDiag_to_1L_week,StartDate)]
# test<-test[!is.na(StartDate)] #Only keep the people who have received 1L therapy 
# pt_ptData1_wait_receive_1L<-test$PatientID
# test<-
# merge(
#   test,
#   both_ECOG,
#   by.x=c("PatientID"),
#   by.y="PatientID",
#   all.x=T,
#   allow.cartesian = T
#   )
# 
# #Grab most recent value up to 2 months back to the day of therapy
# test[,min_date:=as.IDate(as.Date(StartDate) %m-% months(2))]
# test[,max_date:=StartDate]
# # test[PatientID=="FFFD467D22B40",]
# test<-test[min_date<=Date & max_date>=Date,]
# #check how many people got dropped b/c they don't have observation within the 2 weeks before 1L therapy
# table(pt_ptData1_wait_receive_1L %in% test$PatientID )
# #FALSE  TRUE 
# #    8  2087 
# # 8 people are missing ECOG
# missing_alb<-pt_ptData1_wait_receive_1L[!pt_ptData1_wait_receive_1L %in% test$PatientID]
# tmptmp<-
# merge(both_ECOG[PatientID %in% missing_alb,],
#       ptData1_wait[PatientID %in% missing_alb,.(PatientID,StartDate)],
#       by=c("PatientID")
#       )
# tmptmp[PatientID==missing_alb[1],]
# tmptmp[PatientID==missing_alb[2],]
# tmptmp[PatientID==missing_alb[3],]
# tmptmp[PatientID==missing_alb[4],]
# 
# 
# 
# 
# 
# 
# #
# #
# #Albumin
# lab<-readRDS("../../labs/raw_lab.rds")
# vars<-readRDS("../../labs/baseline_covariates.rds")
# vars[variables=="Albumin"]
# 
# # we will just use Albumin
# this_vars<-"Albumin"
# 
# #there can be several different baselines we want to use,
# #choose only one here.
# #set the character string that corresponds to the column name.
# this.baseline<-"StartDate"
# 
# 
# #save the rows we want to use
# this_Test<-vars[variables==this_vars,unique(Test)]
# 
# #Save the subdat
# temp<-lab[Test %in% this_Test,]
# 
# #remove all invalid dataset
# temp<-temp[!is.na(TestResultCleaned) & TestUnitsCleaned!="",]
# 
# 
# #subset the data to what we need.
# these.cols<-c("PatientID",this.baseline)
# temp<-merge.data.table(ptData1_wait[,..these.cols],
#                        temp[,.(PatientID,TestDate,TestUnitsCleaned,TestResultCleaned)],
#                        by="PatientID",
#                        all.x=TRUE,
#                        allow.cartesian=TRUE)
# 
# 
# #(-6 weeks,1 week]
# temp[,min_date:=as.IDate(as.Date(StartDate)- weeks(6))]
# temp[,max_date:=StartDate]
# temp<-temp[min_date<=TestDate & max_date>=TestDate,]
# temp<-temp[,days_to_time0:=StartDate-TestDate]
# setnames(temp,"StartDate","time0")
# ptData1_wait_tmp<-ptData1_wait[,.(PatientID,LineName)]
# ptData1_wait_tmp[,observe_lab_within_window:=0]
# ptData1_wait_tmp[PatientID %in% unique(temp$PatientID),observe_lab_within_window:=1]
# ptData1_wait_tmp[,table(observe_lab_within_window)]
# #   0    1
# # 523 2018
# 
# #Exclude people not having any therapy
# ptData1_wait_tmp[!is.na(LineName),table(observe_lab_within_window)]
# #   0    1 
# #  77 2018 
# #77 people are missing it.
# 
# 
# #Let's not use new lab values value around the start of 1L therapy
# #Just use their values at baseline.

source("../whole_analysis_func_v2.R")
ptData1_wait_out<-whole_analysis_func_v2(
  ptData1_wait,
  covars =   list(
    # "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
    # "lost_10lbs" = "Lost >= 10lbs",
    # "ECOG"="ECOG",
    "SmokingStatus"="SmokingStatus",
    "Histology"="Histology",
    "Gender"="Gender",
    "RaceEthnicity"="Race/Ethnicity",
    "age_at_advDiag"="Approximate age at Advanced Diagnosis",
    "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)",
    "targetable_mutation_by_week_4"="Targetable mutation"
  ))

ptData1_wait_out$KM_curves
ptData1_wait_out$SMD_table 
#Some are having SMD > 0.1. very much violating SMD. 
# Save and report 
SMD_sw<-as.numeric(ptData1_wait_out$SMD_table$SMD_sw)
SMD_sw_var<-ptData1_wait_out$SMD_table$this.rownames
SMD_sw_report<-SMD_sw[which(SMD_sw>0.1)]
SMD_sw_var_report<-SMD_sw_var[which(SMD_sw>0.1)]
SMD_sw_var_report<-stringr::str_remove(string = SMD_sw_var_report,pattern = " \\(%\\)")
SMD_sw_var_report<-stringr::str_remove(string = SMD_sw_var_report,pattern = " \\(mean \\(SD\\)\\)")
if(length(SMD_sw_var_report)>1){
  if(length(SMD_sw_var_report)==2){
    tmp1<-paste(SMD_sw_var_report,collapse = " and ")
  }else{
    except_last<-SMD_sw_var_report[1:(length(SMD_sw_var_report)-1)]
    tmp1<-paste(except_last,collapse = ", ")
    tmp1<-paste(tmp1,", and ",SMD_sw_var_report[length(SMD_sw_var_report)], sep = "" )

  }
}else{
  tmp1<-SMD_sw_var_report
}
tmp1


ptData1_wait_out_median_target<-ptData1_wait_out$median_survivals$yes_ipw$"cohort=Target therapy"
ptData1_wait_out_median_else<-ptData1_wait_out$median_survivals$yes_ipw$"cohort=something else"

```



Below is the 2 by 2 contingency table showing the 1L therapy type (Target or not) and whether the patient had targetable mutation by time zero (Table \@ref(tab:tbl-target-therapy-mutation-status-contingency-table-v2)). Based on the above contingency table, there are people who have targetable mutation but still got something else (N=586).:


```{r }
#| echo: false
#| eval: true
#| include: false
#| warning: false
#| message: false

cont_table<-ptData1_wait[,.(cohort,targetable_mutation_by_week_4)]
cont_table[,Have_targetable_mutation_by_week_4:=as.character(NA)]
cont_table[targetable_mutation_by_week_4==TRUE,Have_targetable_mutation_by_week_4:="Yes"]
cont_table[targetable_mutation_by_week_4==FALSE,Have_targetable_mutation_by_week_4:="No"]
cont_table[,targetable_mutation_by_week_4:=NULL]

before<-svydesign(ids= ~ 0, data=cont_table) 
before_tab<- svyCreateTableOne(vars="Have_targetable_mutation_by_week_4", strata = "cohort",data = before, test = FALSE)

```


```{r }
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: tbl-target-therapy-mutation-status-contingency-table-v2



# before_tab %>%
#   as_kable(
#     caption ="2 by 2 contingency table for targetable mutation status and the respective treatment choices among the wait patients. Even those who didn't receive any 1L therapy is included in the table, in the 'something else' group."
#   )

# 1. run print() but swallow its console output
invisible(
  capture.output(
    before_tab2 <- print(
      before_tab,
      showAllLevels = TRUE,
      smd            = TRUE
    )
  )
)

# 2. now before_tab2 is the object you want to tabulate
knitr::kable(
  before_tab2,
  caption = "2 by 2 contingency table for targetable mutation status and the respective treatment choices among the wait patients. Even those who didn't receive any 1L therapy is included in the table, in the 'something else' group.")




```


To check if receiving targetable therapy is really beneficial for survival, we show the KM plot by the type 1L therapy. The samples used in the KM plot is IPW adjusted samples.

To build IPW, I thought it would be more appropriate to find the values around the time the person received 1L therapy. That means we need to exclude those who didn't receive 1L therapy so we did exclude them. But among those who received 1L therapy, 8 people didn't have any record of ECOG between 2 months before and up to 1L therapy date and 77 people didn't have any albumin observed 6 weeks prior to and up to 1L therapy date. So we decided to just drop all time-varying variables (ECOG, albumin, weight change). That is, we only used demographic (fixed values) and the binary targetable mutation variable. So this means that in the end, we included those who didn't receive 1L therapy as well.   

`r tmp1` reported high SMD, ranging from `r min(SMD_sw_report)` to `r max(SMD_sw_report)` in the IPW population (Table \@ref(tab:tbl-primary-wait-1L-dscriptive-both-v2)). Thus, IPW failed to generate pseudopopulations where the potential confounders are evenly distributed. 

```{r tbl-primary-wait-1L-dscriptive-both-v2,results='asis'}
#| echo: false
#| eval: true
#| warning: false
#| message: false


# build gt table
gt(ptData1_wait_out$SMD_table ) |> 
  # First two columns stay as-is:
  cols_label(
    this.rownames = "Variable",
    level         = "Level",
    # now override the 6 numeric columns’ *display* labels:
    `something else`  = "Something else",
    `Target therapy`    = "Target therapy",
    SMD        = "SMD",
    `something else_sw`  = "Something else",
    `Target therapy_sw`    = "Target therapy",
    SMD_sw     = "SMD"
  ) |> 
  # create the two spanners:
  tab_spanner(
    label   = "No IPW",
    columns = c(`something else` , `Target therapy`, SMD)
  ) |> 
  tab_spanner(
    label   = "IPW",
    columns = c(`something else_sw` , `Target therapy_sw` ,SMD_sw)
  ) |> 
  # optional styling:
  opt_align_table_header("left") |> 
  tab_caption(caption = md("Table XX. Summary of Patient Characteristics at Baseline.")) |> 
  as_raw_html() |>  #this will display the table on
  cat()

```


Nonetheless, we present KM plot for both IPW and no IPW population for exploration. 
 When we don't apply IPW, median survival (95% CI) of those who received targeted therapy was `r  ptData1_wait_out$median_survivals$no_ipw$"cohort=Target therapy"`, while those who didn't were  `r ptData1_wait_out$median_survivals$no_ipw$"cohort=something else"`. When we apply the IPW, those who received targeted therapy was `r  ptData1_wait_out$median_survivals$yes_ipw$"cohort=Target therapy"`, while those who didn't were  `r ptData1_wait_out$median_survivals$yes_ipw$"cohort=something else"` (Figure \@ref(fig:fig-primary-target-KM-v2)).




```{r fig.show="hold", out.width='49%',  fig.height=6}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-primary-target-KM-v2
#| fig-cap: Figure XX KM received by patients stratified by 1L therapy. IPW population.



#subfigure a
ptData1_wait_out$KM_curves$no_ipw
  

#subfigure b
ptData1_wait_out$KM_curves$yes_ipw



```



\


### modified instruction from Tom

Tom and I met lat in May to discuss about this the KM curve. He thinks that it is more useful that I compare the survival curve of those who received targetable therapy vs something else. So we will go ahead and do that comparison.

We will also set time zero to be 1L therapy. So we will have to obtain the variables again near 1L therapy.

Among 2541 patient who have indicated to have waited until targetable mutation status were observed before proceeding to 1L therapy, only 825 patients had targetable mutation status observed prior to initiating 1L therapy. Among 825 patients, 606 patients received some sort of 1L therapy. 21 patients out of 606 patients were missing some covariate values. Thus, in total, 585 patients were used for analysis. 


```{r primary-target-only}
#| eval: true
#| echo: false
#| include: false

ptData1<-readRDS("ptData1_landmark.rds")

#Try to find time to death of those who received targetable therapy
ptData1_wait<-copy(ptData1)
ptData1_wait<-ptData1_wait[cohort=="wait",]
ptData1_wait<-ptData1_wait[,cohort:=NULL]
ptData1_wait<-ptData1_wait[,cohort:=as.character(NA)]
ptData1_wait[FirstLineTherapyGroup_old_and_new=="Target",cohort:="Target therapy"]
ptData1_wait[is.na(cohort),cohort:="something else"]
ptData1_wait[,cohort:=factor(cohort,levels=c("something else","Target therapy"), labels = c("something else","Target therapy"))]

#Check for their mutation status at baseline. 
#Up to end of week 4 
bio<-readRDS("../../../Data/Enhanced_AdvNSCLCBiomarkers.rds")
setDT(bio)[, TestType := stringr::str_replace(TestType, "Mass spectrometry", "Mass Spectrometry")]
setDT(bio)[, TestType := stringr::str_replace(TestType, "Other sequencing method", "Other")]

setDT(bio)[ #combine NTRK's
  , 
  BiomarkerName := 
    stringr::str_replace_all(BiomarkerName, 
                             c("NTRK1"="NTRK",
                               "NTRK2"="NTRK",
                               "NTRK3"="NTRK",
                               "NTRK - unknown gene type"="NTRK",
                               "NTRK - other"="NTRK"))
]

mutation_positive<-c(
  "Mutation positive",
  "PD-L1 positive",
  "Rearrangement present",
  "Rearrangement positive",
  "Amplification positive",
  "Protein expression positive",
  "PD-L1 positive"
)

#restrict to people of our interest
bio<-bio[PatientID %in% ptData1_wait$PatientID,]
#Merge time 0
bio<-
merge(bio,
      ptData1_wait[,.(PatientID,AdvancedDiagnosisDate)],
      by="PatientID",
      all=T)
#Add 4 weeks after diagnosis date
bio[,week_4:=as.IDate(as.Date(AdvancedDiagnosisDate)+weeks(4))]
#We want all mutation information that are positive and before 4 weeks after advanced diagnosis date
bio<-bio[ResultDate<=week_4 & BiomarkerStatus %in% mutation_positive,]
#Exclude PDL1. It's not target therapy.
bio<-bio[BiomarkerName!="PDL1"]
#these are the people who have targetable mutation
yes_target_wait<-bio[,unique(PatientID)]

ptData1_wait[,targetable_mutation_by_week_4:=FALSE]
ptData1_wait[PatientID %in% yes_target_wait,targetable_mutation_by_week_4:=TRUE]

#Restrict patient to those who have targetable mutation
ptData1_wait_have_targetable_mutation<-ptData1_wait[targetable_mutation_by_week_4==TRUE,]
# nrow(ptData1_wait_have_targetable_mutation) #825
# nrow(ptData1_wait) #2541

#Only use the people who have 1L therapy
# ptData1_wait_have_targetable_mutation[,table(FirstLineTherapyGroup)] #there are some who have No therapy. 105 of them. Remove them.
ptData1_wait_have_targetable_mutation<-ptData1_wait_have_targetable_mutation[FirstLineTherapyGroup!="None",]
# nrow(ptData1_wait_have_targetable_mutation) #606

#ECOG at 1L therapy
baselineECOG<-readRDS("../../../Data/BaselineECOG.rds")
baselineECOG<-baselineECOG[PatientID %in% ptData1_wait_have_targetable_mutation$PatientID,]
baselineECOG[ECOGValue=="Unknown",ECOGValue:=NA]
baselineECOG[,ECOGValue:=as.integer(ECOGValue)]
setnames(baselineECOG,"ECOGValue","EcogValue")
setnames(baselineECOG,"ECOGDate","Date")
baselineECOG[,Date:=as.IDate(Date)]

ECOG<-readRDS("../../../Data/ECOG.rds")
ECOG<-ECOG[PatientID %in% ptData1_wait_have_targetable_mutation$PatientID,]
setnames(ECOG,"EcogDate","Date")
ECOG<-unique(ECOG[,.(PatientID,Date,EcogValue)])
ECOG[,N:=.N,by=.(PatientID,Date)]
ECOG[N>1,] #We will take average
ECOG2<-ECOG[,mean(as.numeric(EcogValue),na.rm=T),by=.(PatientID,Date)]
ECOG2
setnames(ECOG2,"V1","EcogValue")


#get them merged
both_ECOG<-
  merge(unique(baselineECOG[,.(PatientID,Date,EcogValue)]),
        ECOG2[,.(PatientID,Date,EcogValue)],
        by=c("PatientID","Date"),
        all=T)
both_ECOG[,EcogValue.x:=as.numeric(EcogValue.x)]
both_ECOG[is.na(EcogValue.x),EcogValue.x:=EcogValue.y]
both_ECOG[,EcogValue.y:=NULL]
setnames(both_ECOG,"EcogValue.x","EcogValue")
rm(list=c("baselineECOG","ECOG"))
both_ECOG

#upto to 2 months before and 1 week after 1L therapy 
both_ECOG<-
merge(
  ptData1_wait_have_targetable_mutation[,.(PatientID,StartDate,AdvancedDiagnosisDate)],
  both_ECOG,
  by="PatientID",
  all.x = T,
  allow.cartesian = T
)
both_ECOG[,min_date:=as.IDate(as.Date(StartDate)  %m-% months(2))]
both_ECOG[,max_date:=as.IDate(as.Date(StartDate) + days(7)- days(1))]

test<-both_ECOG[min_date<=Date & max_date>=Date,]
#check how many people got dropped b/c they don't have observation within the 2 weeks before 1L therapy
table(ptData1_wait_have_targetable_mutation$PatientID %in% test$PatientID )
# FALSE  TRUE  
#     2   604 
# 2 people are missing ECOG. Save their ID
missing_ECOG<-ptData1_wait_have_targetable_mutation[!PatientID %in% test$PatientID, PatientID]
#Explore them
both_ECOG[PatientID %in% missing_ECOG,]




baseline_dat<-both_ECOG[min_date<=Date & max_date>=Date,]
baseline_dat<-baseline_dat[,days_to_time0:=StartDate-Date]
baseline_dat[,sum(is.na(EcogValue))] #0. No missing
baseline_dat[,EcogValue:=as.numeric(EcogValue)]

#Identify if people observed anything within this -2 months to 1 week period.
tmp<-ptData1_wait_have_targetable_mutation[,.(PatientID)]
tmp[,observe_lab_within_window:=0]
tmp[PatientID %in% unique(baseline_dat$PatientID),observe_lab_within_window:=1]
#If we observe the lab value in either (-2 months , 1 week) 
#then we give 1. If we don't observe, then we return 0.
setnames(baseline_dat,"StartDate","time0")
#Find out the value to use for entry criteria.
ECOG_for_entry_criteria_func<-function(dat){
  #Per patient
  exact_data<-dat[Date==time0,]
  
  
  if(nrow(exact_data)>0){
    #If we have observation on time zero, get it
    #Just return the data with averaging if there are more than one measurement
    return(
      data.table(time0=unique(exact_data$time0),
                 Date=unique(exact_data$Date),
                 EcogValue=mean(exact_data$EcogValue,na.rm=TRUE))
    )
    
    
  }else{
    #otherwise,
    tmp<-dat[Date<=max_date & Date>=min_date,]
    
    if(nrow(tmp)==0){
      #If we have no valid test, then return NA
      return(
        data.table(time0=unique(dat$time0),
                   Date=as.IDate(NA),
                   EcogValue=as.numeric(NA)
        ))
      
    }
    
    #If we have something..
    
    #anything before advanced diagnosis date,
    if(tmp[Date< time0 ,.N]>0){
      #If we have anything before advanced diagnosis date,
      #then just return the most recent copy (Clostest to diagnose date)
      tmp<-tmp[order(Date, decreasing = T),]
      
    }else{
      #Or if we only have observation later than advanced diagnosis date,
      #Return the one that's closest to advnaced diagnosis date
      tmp<-tmp[order(Date, decreasing = T),]
      
    }
    return(tmp[1,.(time0,Date,EcogValue)])
    
    
    
    
  }
}

ECOG_for_entry_criteria<-baseline_dat[,ECOG_for_entry_criteria_func(.SD),by=PatientID]

#Merge with data
out<-
  merge(tmp,
        ECOG_for_entry_criteria,
        by="PatientID",
        all.x=T,
        allow.cartesian = T)
setnames(out,"time0","StartDate")

# out[,table(EcogValue, useNA = "ifany")] # This is the ecogvalue for this new dataset! Only 2 people are missing ECOG.
# EcogValue
#    0    1    2    3 <NA> 
#  190  284  107   23    2 
ECOG_for_ptData1_wait_have_targetable_mutation<-copy(out)







#Albumin
lab<-readRDS("../../labs/raw_lab.rds")
vars<-readRDS("../../labs/baseline_covariates.rds")
vars[variables=="Albumin"]

# we will just use Albumin
this_vars<-"Albumin"

#there can be several different baselines we want to use,
#choose only one here.
#set the character string that corresponds to the column name.
this.baseline<-"StartDate"


#save the rows we want to use
this_Test<-vars[variables==this_vars,unique(Test)]

#Save the subdat
temp<-lab[Test %in% this_Test,]

#remove all invalid dataset
temp<-temp[!is.na(TestResultCleaned) & TestUnitsCleaned!="",]


#subset the data to what we need. 
these.cols<-c("PatientID",this.baseline)
temp<-merge.data.table(ptData1_wait_have_targetable_mutation[,..these.cols],
                       temp[,.(PatientID,TestDate,TestUnitsCleaned,TestResultCleaned)],
                       by="PatientID",
                       all.x=TRUE,
                       allow.cartesian=TRUE)


### Entry Criteria - start ###
#For baseline value, time windows are:
#(-6 weeks,1 week] 

#generate two
baseline_dat<-copy(temp)
baseline_dat[,min_date:=as.IDate(as.Date(StartDate)- weeks(6))]
baseline_dat[,max_date:=as.IDate(as.Date(StartDate)+ weeks(1)-days(1))]

#Extract only those that are within this time frame
baseline_dat<-baseline_dat[min_date<=TestDate & max_date>=TestDate,]
baseline_dat<-baseline_dat[,days_to_time0:=StartDate-TestDate]
setnames(baseline_dat, "StartDate", "time0")
#Identify if people observed anything within this -6 weeks to 1 week period. 

tmp<-ptData1_wait_have_targetable_mutation[,.(PatientID)]
tmp[,observe_lab_within_window:=0]
tmp[PatientID %in% unique(baseline_dat$PatientID),observe_lab_within_window:=1]


#If we observe the lab value in either (-6 weeks , 1 week) or (-6 weeks, 4 weeks)
#then we give 1. If we don't observe, then we return 0.

#If we have observation before advanced diagnosis date, then take the observation closest to that

#Find out the value to use for entry criteria.
lab_for_entry_criteria_func<-function(dat){
  #Per patient
  exact_data<-dat[TestDate==time0,]
  
  
  if(nrow(exact_data)>0){
    #If we have observation on time zero, get it
    #Just return the data with averaging if there are more than one measurement
    return(
      data.table(time0=unique(exact_data$time0),
                 TestDate=unique(exact_data$TestDate),
                 TestResultCleaned=mean(exact_data$TestResultCleaned,na.rm=TRUE))
    )
    
    
  }else{
    #otherwise,
    tmp<-dat[TestDate<=max_date & TestDate>=min_date,]
    
    if(nrow(tmp)==0){
      #If we have no valid test, then return NA
      return(
        data.table(time0=unique(dat$time0),
                   TestDate=as.IDate(NA),
                   TestResultCleaned=as.numeric(NA)
        ))
      
    }
    
    #If we have something..
    
    #anything before advanced diagnosis date,
    if(tmp[TestDate< time0 ,.N]>0){
      #If we have anything before advanced diagnosis date,
      #then just return the most recent copy (Clostest to diagnose date)
      tmp<-tmp[order(TestDate, decreasing = T),]
      
    }else{
      #Or if we only have observation later than advanced diagnosis date,
      #Return the one that's closest to advnaced diagnosis date
      tmp<-tmp[order(TestDate, decreasing = T),]
      
    }
    return(tmp[1,.(time0,TestDate,TestResultCleaned)])
    
    
    
    
  }
}

lab_value_for_entry_criteria<-baseline_dat[,lab_for_entry_criteria_func(.SD),by=PatientID]

#Merge with data
out<-
  merge(tmp,
        lab_value_for_entry_criteria,
        by="PatientID",
        all.x=T,
        allow.cartesian = T)

# out[,table(TestResultCleaned, useNA = "ifany")] # This is the albumin for this new dataset! 
  # 16   19   23   24   26   27   28   29   30   31   32   33   34   35   36 36.9   37 37.3   38   39   40   41 41.8   42 
  #  1    1    3    2    6    4    6   12   14   17   22   26   36   26   41    1   44    1   45   46   48   45    1   35 
  # 43 43.8   44   45   46   47   48 <NA> 
  # 34    1   26   26    7    5    4   20 
#20 people missing albumin
Albumin_for_ptData1_wait_have_targetable_mutation<-copy(out)




#Weight


#Get baseline weight
vital<-readRDS("../../../Data/Vitals.rds")
vital<-vital[PatientID %in% ptData1_wait_have_targetable_mutation$PatientID,]

#Make sure the units are comparable
vital[Test=="body weight", unique(TestUnitsCleaned)] #"kg" ""
#Only kg.
vital[Test=="body weight", unique(TestUnits)] #[1] "lb" ""   "oz" "kg"

#Just extract body weight.
weight<-vital[Test=="body weight",]

#Want to use kg
#Is there any missing?
weight[is.na(TestResult) & !is.na(TestResultCleaned),.N]
weight[!is.na(TestResult) & is.na(TestResultCleaned),.N]
weight[!is.na(TestResult) & is.na(TestResultCleaned),]
weight[!is.na(TestResult) & is.na(TestResultCleaned),.(TestResult,TestUnits,TestResultCleaned,TestUnitsCleaned)]
#All of TestResult are missing units. 
#Just use TestResultCleaned.


#remove all invalid dataset
temp<-weight[!is.na(TestResultCleaned) & TestUnitsCleaned!="",]


#subset the data to what we need. 
temp<-merge.data.table(ptData1_wait_have_targetable_mutation[,.(PatientID,time0)],
                       temp[,.(PatientID,TestDate,TestUnitsCleaned,TestResultCleaned)],
                       by="PatientID",
                       all.x=TRUE,
                       allow.cartesian=TRUE)

### Entry Criteria - start ###
#For entry criteria, see if we have observed at least two weights 
#In the past 6 months until to maximum times:
#(-6 months,1 week] 

#We want to look at change in body composition 
#For the time0, get all data in the window: (-6 months,4 weeks] days
#choose the value that's closes to 0 distance from time 0. 
baseline_dat<-copy(temp)
baseline_dat[,min_date:=as.IDate(as.Date(time0)%m-% months(6))]
#Up to 1 week after
baseline_dat[,max_date:=as.IDate(as.Date(time0)+ weeks(1) - days(1))]
#Extract only those that are within this time frame
baseline_dat<-baseline_dat[min_date<=TestDate & max_date>=TestDate,]
baseline_dat<-baseline_dat[,days_to_time0:=time0-TestDate]
baseline_dat


#If we observe the lab value in (-6 weeks , 1 week) 
#then we give 1. If we don't observe, then we return 0.
lost_10lbs_or_more<-function(one_dat){
  # per patient data
  dat<-copy(one_dat)
  
  out<-data.table(
    observe_at_least_two_weight=FALSE,
    first_date_observe_losing_10lbs=as.IDate(NA)
  )
  
  #If there's only one record, not allowed to enter study. return NA
  if(nrow(dat)<2){
    return(out)
  }
  
  #If there are more than 1 record,
  out[,observe_at_least_two_weight:=TRUE]
  
  #check if we can get the data before advanced diangosis date.
  #If so, just use those info.
  if(dat[days_to_time0>=0,.N]>1){
    dat<-dat[days_to_time0>=0,]
  }
  
  
  
  # assume DT is your data.table with columns “Date” and “X”
  setorder(dat, TestDate)  # make sure it’s in ascending time order
  
  # compute running peak and flag drops of ≥10
  dat[ , peak := cummax(TestResultCleaned) ]
  dat[ , dropped_10 := (peak - TestResultCleaned) >= 10 ]
  
  # find the first date where that flag is TRUE. IF nothing is TRUE, that means this person never lost 10 lbs
  if( dat[dropped_10 == TRUE,.N]>0){
    out[,first_date_observe_losing_10lbs:=dat[dropped_10 == TRUE, TestDate][1]]
  }
  
  return(out)
}

#Averate out if multiple measurement exist for same day
baseline_dat_average<-baseline_dat[,mean(TestResultCleaned),by=c("PatientID","TestDate","TestUnitsCleaned","min_date","max_date","days_to_time0")]
setnames(baseline_dat_average,"V1","TestResultCleaned")
lost_weight<-baseline_dat_average[,lost_10lbs_or_more(.SD),by=PatientID]



final<-
  merge(ptData1_wait_have_targetable_mutation[,.(PatientID)],
        lost_weight,
        by="PatientID",
        all.x=T)

final[is.na(observe_at_least_two_weight),observe_at_least_two_weight:=FALSE]

final[,sum(is.na(observe_at_least_two_weight))] #0
#Everyone has observed at least two weights within this
#time interval. 
final[,sum(!is.na(first_date_observe_losing_10lbs))] #31
#But only 31 people have lost more than 10 lbs.

Weight_for_ptData1_wait_have_targetable_mutation<-copy(final)


#Combine all three data together
ptData1_wait_have_targetable_mutation_covars<-
merge(
  ECOG_for_ptData1_wait_have_targetable_mutation[,.(PatientID, StartDate,EcogValue)],
  Albumin_for_ptData1_wait_have_targetable_mutation[,.(PatientID, TestResultCleaned)],
  by="PatientID",
  all=T
)

ptData1_wait_have_targetable_mutation_covars<-
merge(
  ptData1_wait_have_targetable_mutation_covars,
  Weight_for_ptData1_wait_have_targetable_mutation[,.(PatientID, observe_at_least_two_weight)],
  by="PatientID",
  all=T
)


setnames(
  ptData1_wait_have_targetable_mutation_covars,
  old=c("EcogValue","TestResultCleaned","observe_at_least_two_weight"),
  new=c("ECOG","Albumin","Weight_change")
)

#Find out how many people are missing any values
# nrow(na.omit(ptData1_wait_have_targetable_mutation_covars))
# #585
# nrow(ptData1_wait_have_targetable_mutation_covars)
# # 606

#606 - 585 =21 patients are lost 
# It's fine. 
# let's just exclude them

ptData1_wait_have_targetable_mutation_v2<-
merge(
  ptData1_wait_have_targetable_mutation_covars,
  ptData1_wait_have_targetable_mutation[,.(PatientID, DateOfDeath,DeathInd, RaceEthnicity,SmokingStatus,Histology,Gender,age_at_advDiag,AdvancedDiagnosis_year_rescale, FirstLineTherapyGroup)],
  all.x = TRUE,
  by="PatientID"
)
# nrow(na.omit(ptData1_wait_have_targetable_mutation_v2)) #585
ptData1_wait_have_targetable_mutation_v2<-na.omit(ptData1_wait_have_targetable_mutation_v2)
ptData1_wait_have_targetable_mutation_v2[,cohort:=ifelse(FirstLineTherapyGroup=="Target","Target","something_else")]
ptData1_wait_have_targetable_mutation_v2[,cohort:=factor(cohort,levels = c("Target","something_else"), labels=c("Target","something_else"))]
setnames(
  ptData1_wait_have_targetable_mutation_v2,
  "StartDate",
  "time0"
)

ptData1_wait_have_targetable_mutation_v2[,albumin_binary:=ifelse(Albumin<=35,"<=35",">35" )]
setnames(
  ptData1_wait_have_targetable_mutation_v2,
  "Weight_change",
  "lost_10lbs"
)

source("../whole_analysis_func_v2.R")
ptData1_wait_have_targetable_mutation_v2_out<-whole_analysis_func_v2(
  ptData1_wait_have_targetable_mutation_v2,
  covars =   list(
    "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
    "lost_10lbs" = "Lost >= 10lbs",
    "ECOG"="ECOG",
    "SmokingStatus"="SmokingStatus",
    "Histology"="Histology",
    "Gender"="Gender",
    "RaceEthnicity"="Race/Ethnicity",
    "age_at_advDiag"="Approximate age at Advanced Diagnosis",
    "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
  ))

# ptData1_wait_have_targetable_mutation_v2_out$KM_curves
# ptData1_wait_have_targetable_mutation_v2_out$SMD_table 
#Some are having SMD > 0.1. very much violating SMD. 
# Save and report 
SMD_sw<-as.numeric(ptData1_wait_have_targetable_mutation_v2_out$SMD_table$SMD_sw)
SMD_sw_var<-ptData1_wait_have_targetable_mutation_v2_out$SMD_table$this.rownames
SMD_sw_report<-SMD_sw[which(SMD_sw>0.1)]
SMD_sw_var_report<-SMD_sw_var[which(SMD_sw>0.1)]
SMD_sw_var_report<-stringr::str_remove(string = SMD_sw_var_report,pattern = " \\(%\\)")
SMD_sw_var_report<-stringr::str_remove(string = SMD_sw_var_report,pattern = " \\(mean \\(SD\\)\\)")
if(length(SMD_sw_var_report)>1){
  if(length(SMD_sw_var_report)==2){
    tmp1<-paste(SMD_sw_var_report,collapse = " and ")
  }else{
    except_last<-SMD_sw_var_report[1:(length(SMD_sw_var_report)-1)]
    tmp1<-paste(except_last,collapse = ", ")
    tmp1<-paste(tmp1,", and ",SMD_sw_var_report[length(SMD_sw_var_report)], sep = "" )

  }
}else{
  tmp1<-SMD_sw_var_report
}
# tmp1


ptData1_wait_have_targetable_mutation_v2_out_median_target<-ptData1_wait_have_targetable_mutation_v2_out$median_survivals$yes_ipw$"cohort=Target therapy"
ptData1_wait_have_targetable_mutation_v2_out_median_else<-ptData1_wait_have_targetable_mutation_v2_out$median_survivals$yes_ipw$"cohort=something else"

```


\@ref(tab:tbl-primary-wait_have_targetable_mutation) shows the SMD plot of the subset of patients. After IPW, we see that only `r tmp1` is unbalanced but barely bigger than 0.1. Thus, we assume that the covariates are well balanced.

```{r tbl-primary-wait_have_targetable_mutation,results='asis'}
#| echo: false
#| eval: true
#| warning: false
#| message: false


# build gt table
gt(ptData1_wait_have_targetable_mutation_v2_out$SMD_table ) |> 
  # First two columns stay as-is:
  cols_label(
    this.rownames = "Variable",
    level         = "Level",
    # now override the 6 numeric columns’ *display* labels:
    `something_else`  = "Something else",
    `Target`    = "Target therapy",
    SMD        = "SMD",
    `something_else_sw`  = "Something else",
    `Target_sw`    = "Target therapy",
    SMD_sw     = "SMD"
  ) |> 
  # create the two spanners:
  tab_spanner(
    label   = "No IPW",
    columns = c(`something_else` , `Target`, SMD)
  ) |> 
  tab_spanner(
    label   = "IPW",
    columns = c(`something_else_sw` , `Target_sw` ,SMD_sw)
  ) |> 
  # optional styling:
  opt_align_table_header("left") |> 
  tab_caption(caption = md("Table XX. SMD plots")) |> 
  as_raw_html() |>  #this will display the table on
  cat()

```


Figure \@ref(fig:fig-primary-target-only-KM) shows KM plots of this population, both before and after IPW. In both subfigure A) and B), we can see that the median survival of patients who received targetable mutation is longer than those who received something else. In the IPW population, the median survival of patients receiving targeted therapy was`r  ptData1_wait_have_targetable_mutation_v2_out$median_survivals$yes_ipw$"cohort=Target therapy"`, while those who received some other therapies were  `r ptData1_wait_have_targetable_mutation_v2_out$median_survivals$yes_ipw$"cohort=something_else"` .




```{r fig.show="hold", out.width='49%',  fig.height=6}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-primary-target-only-KM
#| fig-cap: Figure XX KM plot among 'wait' cohorts who have targetable mutation before receiving 1L therapy, stratified by types of 1L therapy.



#subfigure a
ptData1_wait_out$KM_curves$no_ipw
  

#subfigure b
ptData1_wait_out$KM_curves$yes_ipw



```




\

## Aim 2 exclude variables without much observation

**Q**: In Aim 2, I repeated Aim 1 but in subgroups of population based on the the characteristics of interest. I didn't report the result of some subgroups saying that there were IPW violation due to one cohort not having any observation for certain factor level for categorical variables. I also said that there are SMD much bigger than 1. However, some of them were because of just not having enough sample sizes. I am to re-do those analysis by excluding those variables or patients.   


**A**: The modification was applied directly to section {#aim-2}. The resulting table is copied below (\@ref(tab"subgroup-tbl-copy)). Substantial difference was found in Asian subgroup with primary inclusion criteria. Interpretation is as follows. Among Asian patients who ddin't lose substantial weight (losing more than 10 lbs up to 6 months prior to time zero), waiting for test result decreased hazard of death on average by 71% (95% CI:19% - 89%). However, there Asians also have substantial SMD imbalance. The SMD table is shown in \@ref(tab:tbl-subgroup-refit-primary-SMD-asian). No wait cohort had more patietns who had normal range of Albumin. 

```{r subgroup-tbl-copy, results='asis'}
#| eval: true


#Here we provide result of the Aim 2!

tmp<-
data.table(
  "Patient Population"=names(subgroup_analyses_primary),
  "Primary inclusion criteria"=sapply(subgroup_analyses_primary,function(x)x$HR_95_CI["HR(95%CI)"]),
  "Secondary inclusion criteria"=sapply(subgroup_analyses_secondary,function(x)x$HR_95_CI["HR(95%CI)"])
) 
tmp[`Patient Population`=="All",`Patient Population`:="All (Aim 1)"]

# #Remove ECOG 3-4, Asian, and Never smoker results from primary analysis
# tmp[`Patient Population` %in% c("ECOG (3-4)","Asian"), `Primary inclusion criteria`:=""]
# 

#Remove ECOG 3-4 and Asian results from secondary analysis
# tmp[`Patient Population` %in% c("ECOG (3-4)","Asian"), `Secondary inclusion criteria`:=""]



# tmp|> 
#   kable(caption = "Table XX. Hazard ratio and 95% confidence interval of proceeding to 1L without waiting for valid test results. Empty cells mean that causal analysis was impossible due to positivity assumption violation in some confounders.")
# 


tmp |> 
  gt() |> 
  # footnote on the Never-smoker subgroup in primary inclusion criteria
  tab_footnote(
    footnote = "Excluded 4 patients who lost >= 10 lbs at baseline. The interpretation should be among never-smokers who didn't lost substantial weight.",
    locations = cells_body(
      columns = `Primary inclusion criteria`,
      rows    = `Patient Population` == "Never Smoked"
    ),
    placement = "right"
  )  |> 
  # footnote on the Never-smoker subgroup in ECOG 3-4 for secondary inclusion criteria
  tab_footnote(
    footnote = "Excluded 20 Asian/Non-Hispanic patients. The interpretation should be fairly sick patients who are not Asian/Non-Hispanics.",
    locations = cells_body(
      columns = `Secondary inclusion criteria`,
      rows    = `Patient Population` == "ECOG (3-4)"
    ),
    placement = "right"
  )    |> 
  # footnote on the Never-smoker subgroup in Asian for secondary inclusion criteria
  tab_footnote(
    footnote = "Excluded 2 patients who lost >= 10 lbs at baseline. The interpretation should be Asian/Non-Hispanics who did not lose substantial weight.",
    locations = cells_body(
      columns = `Secondary inclusion criteria`,
      rows    = `Patient Population` == "Asian"
    ),
    placement = "right"
  )   |> 
  # footnote on the ECOG 3-4 subgroup for primary inclusion criteria
  tab_footnote(
    footnote = "Excluded Asian/Non-hispanics (N=5) and those who lost more than 10 lbs (N=15) because there were only small number of them and they were all in wait cohort. SMD balanced not achived for Smoking status (SMD=0.285) and year of advanced diagnosis (SMD=0.367). The interpretation should be among those who are substantially sick but haven't lost more than 10 lbs and are not Asian/Non-Hispanics.",
    locations = cells_body(
      columns = `Primary inclusion criteria`,
      rows    = `Patient Population` == "ECOG (3-4)"
    ),
    placement = "right"
  ) |> 
  # footnote on Asian for primary inclusion criteria
  tab_footnote(
    footnote = "Excluded lost more than 10 lbs (N=1) who was in wait cohort. SMD balanced not achived for Albumin (SMD=0.321). The interpretation should be given as among Asian/Non-Hispanics who did not lose substantial weight.",
    locations = cells_body(
      columns = `Primary inclusion criteria`,
      rows    = `Patient Population` == "Asian"
    ),
    placement = "right"
  )  |> 
  as_raw_html() |> 
  cat()
  

```




```{r tbl-subgroup-refit-primary-SMD-asian,results='asis'}
#| echo: false
#| eval: true
#| warning: false
#| message: false


# build gt table
gt(subgroup_analyses_primary$Asian$SMD_table ) |> 
  # First two columns stay as-is:
  cols_label(
    this.rownames = "Variable",
    level         = "Level",
    # now override the 6 numeric columns’ *display* labels:
    `wait`  = "Wait",
    `no_wait`    = "No wait",
    SMD        = "SMD",
    `wait_sw`  = "Wait",
    `no_wait_sw`    = "No wait",
    SMD_sw     = "SMD"
  ) |> 
  # create the two spanners:
  tab_spanner(
    label   = "No IPW",
    columns = c(wait , no_wait, SMD)
  ) |> 
  tab_spanner(
    label   = "IPW",
    columns = c(wait_sw , no_wait_sw, SMD_sw)
  ) |> 
  # optional styling:
  opt_align_table_header("left") |> 
  tab_caption(caption = md("Table XX. Summary of Asian Patients' Characteristics at Baseline.")) |> 
  as_raw_html() |>  #this will display the table on
  cat()

```

