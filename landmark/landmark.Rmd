---
title: "Landmark Analysis"
subtitle: "version 1"
author: "Hyejung Lee <hyejung.lee@utah.edu>"
date: "`r format(Sys.time(), '%a %b %d, %Y %X')`"
output:
  github_document:
    toc: true
    toc_depth: 2
    html_preview: true
   # bookdown::html_document2:
   #  self-contained: true
   #  embed-resources: true
   #  code-fold: true
   #  toc: true
   #  theme: united
   #  toc_float: true
   #  number-sections: true
  # word_document:
  #   toc: true
  #   toc_depth: 2
  #   number_sections: true 
# bibliography: references.bib
# csl: nature.csl
execute:
  cache: true
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{r include=FALSE}
#| message: false
#| warning: false

# knitr::opts_knit$set(root.dir = "./SAP")
# remotes::install_github('yihui/knitr')
# library(knitr)
library(ggplot2)
library(survival)
library(survminer)
library(officer)
library(officedown)
library(flextable)
library(data.table)
library(parallel)
library(kableExtra)
library(knitr)
library(lubridate)
library(tictoc)
library(gt)
library(gtsummary)

library(DiagrammeR)
library(DiagrammeRsvg)
library(rsvg)



knitr::opts_chunk$set(echo = FALSE)


# BMI<-readRDS("../BMI_overtime.rds") 
# ECOG<-readRDS("../ECOG_overtime.rds") 
# lab_out<-readRDS("../lab_180days.rds")

ncores<-strtoi(Sys.getenv("SLURM_NTASKS")) #Pick up -ntasks or --n from the environment
setDTthreads(threads = ncores)

```

# Context

2025 April 14

I had a meeting with Tom and Ben on last Friday. Ben suggested that I
restrict the patients to those who have:

-   Survive at least four weeks post advanced diagnosis
-   Have a valid test result by the end of the fourth week
-   Have albumin, ECOG performance status, and weight change observed to
    use for analysis

We break this into two different scenarios, where:

-   **Primary Analysis**: time-dependent covariates must be observed by
    1 week post advanced diagnosis by the end of 1st week
-   **Secondary Analysis**: time-dependent covariates must be observed
    by 1 week post advanced diagnosis by the end of 4th week

Primary analysis addresses potential bias when baseline covariates are
measured after treatment assignment. Note that treatment is a binary
variable, which is a function of test result date and 1L therapy date.

Although our time zero is defined at week 5—implying that every patient
must have at least one measurement of albumin, ECOG, and weight
change—delayed covariate ascertainment risks adjusting for post‑baseline
values. For example, if first‑line therapy begins in week 1 but albumin
is first measured in week 3, that value may already reflect treatment
effects. Restricting covariate observation to week 1 in the primary
analysis (and comparing it to the week 4 window in the secondary
analysis) helps approximate true baseline values at the time of advanced
diagnosis.

\

# Covariate

## Time-fixed covariate

We will use Gender, race/ethnicity, time at advanced diagnosis,
histology, smoking status, and age at diagnosis

## Time-dependenet covariate

Baseline covariate ascertainment proceeded as follows, based on expert
recommendations:

1.  Covariates and time windows
    -   **ECOG performance status**: any assessment recorded from 2
        months before up to 1 week after (or 4 weeks after, for secondary analysis) the date of advanced
        diagnosis.
    -   **Weight change (**$\geq 10$ lb loss): weight measurements from 6
    months before up to 1 week after (or 4 weeks after, for secondary analysis) diagnosis, with at least two
    measurements in that interval.
    -   **Serum albumin**: binary indicator ($\leq 35 g/L$ vs.$> 35 g/L$)
    from 6 weeks before up to 1 week after (or 4 weeks after, for secondary analysis) advanced diagnosis.
2.  Inclusion criteria 
Patients were retained only if they had: 
    -   $\geq 1$ ECOG assessment in the specified window, 
    -   $\geq 2$ weight measurements in the
    specified window, and 
    -   $\geq 1$ albumin measurement in the specified window.
3.  Value selection   
    -   ECOG and albumin: if measured on the date of
    advanced diagnosis, that value was used; otherwise, the measurement
    closest in time to diagnosis was selected, with preference for
    pre‑diagnosis values.
    -   Weight change: 
        -   If $\geq 2$ measurements existed before diagnosis, we coded whether a $\geq 10$ lb loss occurred in the 6 months preceding diagnosis.         
        -   If fewer than two pre‑diagnosis measurements were available, we identified the earliest occurrence of $\geq 10$ lb loss within the period from 6 months pre‑diagnosis to 1 week (or 4 weeks, for secondary analysis) post‑diagnosis. 
        
        
        
Implementation details are provided in the analysis script (new_setup_baseline_diagnosis_v3.R).


Here, I said 4 weeks after, but it is 1 week after for primary analysis.


```{r time-dep-vars}
#|eval: true

Albumin<-readRDS("../Albumin_overtime_landmark.rds")
ECOG<-readRDS("../ECOG_overtime_landmark.rds")
weight_change<-readRDS("../Weight_change_overtime_landmark.rds")

```

\

# Exclusion

We will subset samples to have:

-   survived to 4 weeks
-   have received valid test result by 4 weeks

```{r exclusion}
#| echo: false
#| eval: true
#| include: false


ptData<-readRDS("../ptData_time0_diag_v2.rds")
ptData[,advDiag_to_death_weeks:=as.numeric(interval(AdvancedDiagnosisDate,DateOfDeath),"weeks")]
ptData[,advDiag_to_valid_PDL1_week:=as.numeric(interval(AdvancedDiagnosisDate,earliest_valid_ResultDate__on_after_time0_PDL1),"weeks")]
ptData[,advDiag_to_valid_gene_week:=as.numeric(interval(AdvancedDiagnosisDate,earliest_valid_ResultDate__on_after_time0_NoPDL1),"weeks")]
ptData[,advDiag_to_valid_test_week:=pmin(advDiag_to_valid_PDL1_week,advDiag_to_valid_gene_week,na.rm = T)]
ptData[,advDiag_to_1L_week:=as.numeric(interval(AdvancedDiagnosisDate,StartDate),"weeks")]


exclusion_tab<-data.table(
  "Exclusion"=c("Receive 1L therapy before advanced diagnosis date","Receive valid test results before advanced diagnosis date","Died/censored before end of week 4","Do not have any record of receiving valid test by the end of week 4"),
  "Number excluded"=as.numeric(NA),
  "Number remaining"=as.numeric(NA)
)



#Due to data issue, some people are missing censoring time
# ptData[DeathInd==0 & time0_to_death_weeks<=0, .N] #442
pt_exclude<-ptData[DeathInd==0 & advDiag_to_death_weeks<=0, PatientID]
#We will exclude them 
ptData<-ptData[!PatientID %in% pt_exclude,]
num_beginning<-nrow(ptData)


#Receive 1L therapy before advanced diagnosis date
ptData[StartDate<AdvancedDiagnosisDate,.N] #994
exclude_pt<-ptData[StartDate<AdvancedDiagnosisDate,PatientID] 
exclusion_tab[Exclusion=="Receive 1L therapy before advanced diagnosis date", `Number excluded`:=length(exclude_pt)]
exclusion_tab[Exclusion=="Receive 1L therapy before advanced diagnosis date", `Number remaining`:=nrow(ptData)-length(exclude_pt)]

ptData<-ptData[!(PatientID %in% exclude_pt),]




#Receive valid test results before advanced diagnosis date
ptData[observe_valid__before_time0_PDL1==TRUE | observe_valid__before_time0_NoPDL1==TRUE,.N] #6501
exclude_pt<-ptData[observe_valid__before_time0_PDL1==TRUE | observe_valid__before_time0_NoPDL1==TRUE,PatientID] 

exclusion_tab[Exclusion=="Receive valid test results before advanced diagnosis date", `Number excluded`:=length(exclude_pt)]
exclusion_tab[Exclusion=="Receive valid test results before advanced diagnosis date", `Number remaining`:=nrow(ptData)-length(exclude_pt)]

ptData<-ptData[!(PatientID %in% exclude_pt),]




#survived up to 4 weeks 
exclusion_tab[Exclusion=="Died/censored before end of week 4", `Number excluded`:=ptData[advDiag_to_death_weeks<=4,.N]]
exclusion_tab[Exclusion=="Died/censored before end of week 4", `Number remaining`:=ptData[advDiag_to_death_weeks>4,.N]]

ptData<-ptData[advDiag_to_death_weeks>4,]



#Receive valid test result prior to the end of 4th week
exclusion_tab[Exclusion=="Do not have any record of receiving valid test by the end of week 4", `Number excluded`:=ptData[advDiag_to_valid_test_week>4 | is.na(advDiag_to_valid_test_week),.N]]
exclusion_tab[Exclusion=="Do not have any record of receiving valid test by the end of week 4", `Number remaining`:=ptData[advDiag_to_valid_test_week<=4,.N]]


ptData<-ptData[advDiag_to_valid_test_week<=4]

```

We have `r num_beginning` patients without any exclusion.

```{r}
#| echo: false
#| eval: true
#| label: tbl-exclusion
#| tbl-cap: Number of patients based on exclusion

kable(exclusion_tab)

```

\

## Primary analysis


```{r exclusion-primary}
#| echo: false
#| eval: true
#| include: false


#Only include people who have observed all variables (including time depedent and indenpendent variables)
ptData1<-copy(ptData)
nrow(ptData1) #27706
exclusion_tab1<-copy(exclusion_tab)


#time-dependent covariate
ptData1<-ptData1[PatientID %in% Albumin$week1[observe_lab_within_window==1,PatientID],]
ptData1<-ptData1[PatientID %in% ECOG$week1[observe_lab_within_window==1,PatientID],]
ptData1<-ptData1[PatientID %in% weight_change$week1[observe_at_least_two_weight==TRUE,PatientID],]
nrow(ptData1) #3018

#time-independent covariate
ptData1[,table(SmokingStatus, useNA = "ifany")] #two unknown not documented. Meaning, not observed.
ptData1[SmokingStatus=="Unknown/Not documented", .(advDiag_to_valid_test_week, advDiag_to_1L_week)] #One in each cohort. Remove them 
ptData1<-ptData1[SmokingStatus!="Unknown/Not documented",]


ptData1[,table(Histology, useNA = "ifany")] 
ptData1[,table(Gender, useNA = "ifany")]
ptData1[,table(RaceEthnicity, useNA = "ifany")] 
ptData1[,sum(is.na(age_at_advDiag))]
ptData1[,sum(is.na(AdvancedDiagnosisDate))]



exclusion_tab1<-
rbind(
  exclusion_tab1,
  data.table(
    Exclusion="Didn't observe all variables (week 1)",
    "Number excluded"=nrow(ptData)-nrow(ptData1),
    "Number remaining"=nrow(ptData1)
  )
  
)
```



```{r}
#| echo: false
#| eval: true
#| label: tbl-exclusion_primary
#| tbl-cap: Number of patients based on exclusion

kable(exclusion_tab1)

```




\

## Secondary analysis


```{r exclusion-secondary}
#| echo: false
#| eval: true
#| include: false


#Only include people who have observed all variables (including time depedent and indenpendent variables)
ptData2<-copy(ptData)
nrow(ptData2) #27706
exclusion_tab2<-copy(exclusion_tab)


#time-dependent covariate
ptData2<-ptData2[PatientID %in% Albumin$week4[observe_lab_within_window==1,PatientID],]
ptData2<-ptData2[PatientID %in% ECOG$week4[observe_lab_within_window==1,PatientID],]
ptData2<-ptData2[PatientID %in% weight_change$week4[observe_at_least_two_weight==TRUE,PatientID],]
nrow(ptData2) #11317

#time-independent covariate
ptData2[,table(SmokingStatus, useNA = "ifany")] #8 unknown not documented. Meaning, not observed.
tmp<-ptData2[SmokingStatus=="Unknown/Not documented", .(advDiag_to_valid_test_week, advDiag_to_1L_week)] 
tmp[is.na(advDiag_to_1L_week),advDiag_to_1L_week:=1000]
tmp[,cohort:="wait"]
tmp[advDiag_to_1L_week<advDiag_to_valid_test_week,cohort:="no_wait"]
tmp
#Among the 8 people with missing Smoking status, 5 people are wait, and 3 are no wait. 
#Exclude them.
ptData2<-ptData2[SmokingStatus!="Unknown/Not documented",]

ptData2[,table(Histology, useNA = "ifany")] 
ptData2[,table(Gender, useNA = "ifany")]
ptData2[,table(RaceEthnicity, useNA = "ifany")] 
ptData2[,sum(is.na(age_at_advDiag))]
ptData2[,sum(is.na(AdvancedDiagnosisDate))]


exclusion_tab2<-
rbind(
  exclusion_tab2,
  data.table(
    Exclusion="Didn't observe all variables (week 4)",
    "Number excluded"=nrow(ptData)-nrow(ptData2),
    "Number remaining"=nrow(ptData2)
  )
  
)
```



```{r}
#| echo: false
#| eval: true
#| label: tbl-exclusion_secondary
#| tbl-cap: Number of patients based on exclusion

kable(exclusion_tab2)

```



\

# Primary Analysis

```{r primary-analysis}
#| eval: true

ptData1<-
merge(ptData1,
      Albumin$week1[,.(PatientID,TestResultCleaned)],
      all.x = T)
setnames(ptData1,"TestResultCleaned","albumin")
ptData1[,albumin_binary:=ifelse(albumin<=35,"low","normal")]
ptData1[,albumin_binary:=factor(albumin_binary,levels = c("normal","low"), labels = c("normal","low"))]

ptData1<-
merge(ptData1,
      ECOG$week1[,.(PatientID,EcogValue)],
      all.x = T)
setnames(ptData1,"EcogValue","ECOG")


ptData1<-
merge(ptData1,
      weight_change$week1[,.(PatientID,first_date_observe_losing_10lbs)],
      all.x = T)
ptData1[,lost_10lbs:="No"]
ptData1[!is.na(first_date_observe_losing_10lbs),lost_10lbs:="Yes"]
ptData1[,lost_10lbs:=factor(lost_10lbs,levels=c("No","Yes"), labels=c("No","Yes"))]
ptData1[,first_date_observe_losing_10lbs:=NULL]

#Time 0 is 5th week
ptData1[,time0:=NULL]
ptData1[,time0:=as.IDate(as.Date(AdvancedDiagnosisDate)+weeks(4)+days(1))]


#Now treatment assignment.
ptData1[,cohort:="wait"]
ptData1[advDiag_to_1L_week<advDiag_to_valid_test_week,cohort:="no_wait"]
ptData1[,cohort:=factor(cohort,levels=c("wait","no_wait"), labels=c("wait","no_wait"))]


#generate yearly count of advanced diagnosis date
ptData1[,AdvancedDiagnosis_year:=year(AdvancedDiagnosisDate)]
ptData1[,AdvancedDiagnosis_year_factor:=factor(AdvancedDiagnosis_year,levels = sort(unique(AdvancedDiagnosis_year), decreasing = F), labels = sort(unique(AdvancedDiagnosis_year), decreasing = F))]

# ptData1[,min(AdvancedDiagnosis_year)] #2011
ptData1[,AdvancedDiagnosis_year_rescale:=AdvancedDiagnosis_year-min(AdvancedDiagnosis_year)] #make first one 0.
```


\

## Descriptive summary


Summary table:

```{r primary-descriptive-table}
#| eval: true


covars<-list(
  "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
  "lost_10lbs" = "Lost >= 10lbs",
  "ECOG"="ECOG",
  "SmokingStatus"="SmokingStatus",
  "Histology"="Histology",
  "Gender"="Gender",
  "RaceEthnicity"="Race/Ethnicity",
  "age_at_advDiag"="Approximate age at Advanced Diagnosis",
  "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
)  
  primary_decriptive_table<-
    tbl_summary(
      data=ptData1[,.SD,.SDcols=c("cohort",names(covars))],
      by="cohort",
      label=covars,
      missing = "ifany",
      type = list(where(is.numeric) ~ "continuous2"),  # Use "continuous2" for multiple statistics
      statistic = list(
        all_continuous() ~ c("{mean} ({sd})", "{median} ({p25}, {p75})")  # Show both Mean (SD) and Median (Q1, Q3)
      )
    )

```




```{r}
#| echo: false
#| eval: true
#| warning: false
#| label: tbl-primary-dscriptive


primary_decriptive_table |> 
  as_gt() |> 
  #  tab_header(
  #   title = md("What's the difference between this title and caption?"),
  #   subtitle = md("`gtcars` is an R dataset")
  # ) |>
  tab_caption(caption = md("Table XX. Summary of Patient Characteristics at Baseline, without IPW weighting.")) |> 
  as_raw_html() 
```


As we can observe in the table, there is only one person who is Hispanic/Latino in no wait cohort. This is insufficient data to make any meaningful analysis. Thus, we will fuse Hispanic Lanito to Other category. 

```{r primary-exclude-pt-for-positivity}
#| echo: false
#| eval: true


#Make HispLatino -> Other 

ptData1[RaceEthnicity=="HispLatino",RaceEthnicity:="Other"]
```


\

## Inverse probability weight


Generate IPW, and re-construct the table.

```{r primary-IPW}
#| eval: true
#| echo: false
#| message: false
#| include: false

#Use logistic regression
covar_cols<-c(
  "albumin_binary",
  "lost_10lbs" ,
  "ECOG",
  "SmokingStatus",
  "Histology",
  "Gender",
  "RaceEthnicity",
  "age_at_advDiag",
  "AdvancedDiagnosis_year_rescale"
)  


this.formula<-formula(paste("cohort~", paste(covar_cols,collapse = "+"), sep=""))
logit.fit<-glm(this.formula,data=ptData1,family="binomial")

# logit.fit<-glm(cohort~albumin_binary+lost_10lbs+ECOG+SmokingStatus+Histology+Gender+RaceEthnicity+age_at_advDiag+AdvancedDiagnosis_year,data=ptData1,family="binomial")


#propensity scores
ptData1[,ps:=logit.fit$fitted.values]

#generate weight
ptData1[,w:=ifelse(cohort=="wait",1/ps, 1/(1-ps))]

#Propensity score plot for positivity assumption
primary_ps_plot<-ggplot(ptData1, aes(x=ps,fill=cohort))+
  geom_density(alpha=0.2)+
  theme_minimal()
primary_ps_plot #seem like there is a good overlap... Maybe.
#Check the summary of ps by cohort
ptData1[cohort=="wait",summary(ps)]
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#0.05696 0.11658 0.14626 0.15414 0.18184 0.40228
ptData1[cohort=="no_wait",summary(ps)]
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#0.05529 0.13284 0.16594 0.17544 0.21220 0.39429 

#Yes. I thin there are pretty good overlap.



#generate stabilized weights, in case there are extreme weights
prop_no_wait<-mean(ptData1$cohort=="no_wait")
ptData1[,sw:=ifelse(cohort=="no_wait",prop_no_wait/ps, (1-prop_no_wait)/(1-ps))]

#Check extreme weight
ptData1[cohort=="wait",summary(sw)]
ptData1[cohort=="no_wait",summary(sw)]
#all weights under 3. Good!




```




```{r code-primary-both-tables}
#| echo: false
#| eval: true
#| include: false




#before weight
library(survey)
library(tableone)



before<-svydesign(ids= ~ 0, data=ptData1) 
before_tab<- svyCreateTableOne(vars=covar_cols, strata = "cohort",data = before, test = FALSE)
# print(before_tab, smd = TRUE)
# print(before_tab, showAllLevels = TRUE, smd = TRUE)


before_tab_rownames<-rownames(print(before_tab, showAllLevels = TRUE,smd=T))
before_tab<-as.data.frame(print(before_tab,showAllLevels = TRUE, smd=T))
before_tab$this.rownames<-before_tab_rownames



#After weight


after<-svydesign(ids= ~ 0, data=ptData1,weights=ptData1$sw)
after_tab<- svyCreateTableOne(vars=covar_cols, strata = "cohort",data = after, test = FALSE)

after_tab_rownames<-rownames(print(after_tab, showAllLevels = TRUE,smd=T))
after_tab<-as.data.frame(print(after_tab, showAllLevels = TRUE,smd=T))
colnames(after_tab)<-paste(colnames(after_tab),"sw",sep = "_")

#merge the two data sets. Can I just bind them?
# sum(before_tab$this.rownames!=after_tab_rownames) #they are same order. Just cbind them.
# rownames(before_tab)
temp<-cbind(before_tab[,c("this.rownames",colnames(before_tab)[colnames(before_tab)!="this.rownames"])],
            after_tab[,c( "wait_sw","no_wait_sw","SMD_sw")])
rownames(temp)<-NULL


#Change row names to print
pretty_name<-do.call(c,covars)[covar_cols]
new_rownames<-
sapply(temp$this.rownames,function(x){
  
  if(x==""|x=="n"){
    return(x)
  }else{
    
    #logical for index which name to give
    this.index.logical<-
    sapply(names(pretty_name),function(y){
       stringr::str_detect(string = x,
                     pattern = y) 
    })
    
    index<-which(this.index.logical)
    
    #Replace the raw name with pretty name
    newname<-
    stringr::str_replace(string=x, pattern=names(pretty_name)[index], replacement=pretty_name[index])
    return(newname)
  }

})

temp$this.rownames<-new_rownames


```


```{r tbl-primary-dscriptive-both}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| tbl-cap: Summary of Patient Characteristics at Baseline.


# build gt table
gt(temp) |> 
  # First two columns stay as-is:
  cols_label(
    this.rownames = "Variable",
    level         = "Level",
    # now override the 6 numeric columns’ *display* labels:
    wait       = "Wait",
    no_wait    = "No wait",
    SMD        = "SMD",
    wait_sw    = "Wait",
    no_wait_sw = "No wait",
    SMD_sw     = "SMD"
  ) |> 
  # create the two spanners:
  tab_spanner(
    label   = "No IPW",
    columns = c(wait, no_wait, SMD)
  ) |> 
  tab_spanner(
    label   = "IPW",
    columns = c(wait_sw, no_wait_sw, SMD_sw)
  ) |> 
  # optional styling:
  opt_align_table_header("left") |> 
  tab_caption(caption = md("Table XX. Summary of Patient Characteristics at Baseline, without IPW weighting.")) |> 
  as_raw_html()  #this will display the table on

```



Based on the above table, we can observe that when we don't apply IPW, the standardized mean difference (SMD) for albumin, race/ethnicity, age at diagnosis, and advanced diagnosis (year) were imbalanced (SMD > 0.1). However, after IPW, these covariates are all balanced (SMD < 0.1). 

\


## KM curve



```{r fig.show="hold", out.width='49%',  fig.height=5}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-primary-KMplot
#| fig-cap: Figure XX. Kaplan-Meier (KM curve demonstrating survival probability over time. A) original data, B) IPW applied population. 
# #| fig-subcap: ["48 patients used for original body compositions", "46 patients used for composite body compositions"]
# #| layout-ncol: 2

# #| fig-subcap: 
# #|     - 48 patients used for original body compositions
# #|     - 46 patients used for composite body compositions


#Kaplan meier curve
#display that works for HTML.

source("../return_km_plot.R")




#generate time variable
ptData1[,time0_to_death_weeks:=as.numeric(interval(time0,DateOfDeath),"weeks")]
no_ipw<-return_km_plot(data = ptData1,xlab_name = "Time (week)", time="time0_to_death_weeks",covar = "cohort",status ="DeathInd" ) |> suppressWarnings() #Without suppressWarnings(), I still see warning printed out in html file, even with warning: false.

yes_ipw<-return_km_plot(data = ptData1,xlab_name = "Time (week)", time="time0_to_death_weeks",covar = "cohort",status ="DeathInd" ,weight = T,weight_var = "sw") |> suppressWarnings()


#Remove legend
# Assuming your plot is saved as 'x'
# and add title
no_ipw$plot <- no_ipw$plot + 
  # theme(legend.position = "none") + 
  ggtitle("A) Without IPW")
yes_ipw$plot <- yes_ipw$plot + 
  # theme(legend.position = "none")+ 
  ggtitle("B) IPW")


#subfigure a
no_ipw
  

#subfigure b
yes_ipw



```


```{r primary-median-surv}
#| echo: false
#| eval: true


#Just calculate median survival 
#A function that returns median(95%CI) survival time from surfit() object
kmplot_median_CI<-function(km_fit, digits=2){
  #km_fit = survfit() object with binary exposure.
  
  temp<-as.data.frame(summary(km_fit)$table)
  factor_levels<-rownames(temp)
  
  this.formula<-paste("%.",digits,"f (95%%CI: %.",digits,"f - %.",digits,"f)", sep="")
  
  out<-
    lapply(factor_levels,function(x){
      sprintf(this.formula,temp[x,"median"],temp[x,"0.95LCL"],temp[x,"0.95UCL"])
    })
  names(out)<-factor_levels
  out
}

median_summary_noIPW<-kmplot_median_CI(survfit(Surv(time0_to_death_weeks,DeathInd)~cohort, data = ptData1), digits=2)
median_summary_yesIPW<-kmplot_median_CI(survfit(Surv(time0_to_death_weeks,DeathInd)~cohort, data = ptData1, weights = ptData1$sw), digits=2)

```


Without IPW, the median survival of "wait" and "no wait" cohorts were `r median_summary_noIPW$"cohort=wait"`, and `r median_summary_noIPW$"cohort=no_wait"`, respectively. With IPW, however, the median survival decreased very slightly for the wait cohort  (`r median_summary_yesIPW$"cohort=wait"`), while the median survival of those who waited increased much (`r median_summary_yesIPW$"cohort=no_wait"`). Even though the confidence interval substantially overlap.


## Effect of 1L before test result become available

```{r primary-coxph}
#| echo: false
#| eval: true


#Crude fit 
source("../coxph.ci.coef.R")

fit1<-coxph(Surv(time0_to_death_weeks,DeathInd)~cohort, data = ptData1, weights=ptData1$sw, robust = T, x=TRUE)
summary_fit1<-coxph.ci.coef(fit1,x.name="cohortno_wait",digits=3,return_num_binary_x=FALSE,robust=TRUE)
summary_fit1<-summary_fit1["HR(95%CI)"]

```
Using the IPW, we fitted a Cox PH model. From this, we conclude that the hazard rate (95% confidence interval) of death by proceeding to 1L before receiving valid test result is `r summary_fit1`. Since the null value 1 is included in the 95% CI, we conclude that proceeding to 1L therapy right away did not produce much difference. 


\

## 1L therapy distribution

```{r primary-1L-code}
#| echo: false
#| eval: true
#| include: false


# ptData1$FirstLineTherapyGroup
# #Get the most updated classification Wally did for us
# therapy1<-fread("../../../Data/new_1L/firstLinetherapies.csv")
# therapy1<-therapy1[,.(L1therapy,CategoryEric1)]
# colnames(therapy1)<-c("LineName","Group")
# 
# therapy2<-readxl::read_xlsx("../../../Data/new_1L/L1therapiesDiscordantclassesWA.xlsx") #This is the one we have to use updated by Wally
# therapy2<-data.table(therapy2)
# therapy2<-therapy2[,.(L1therapy,Akerley)]
# colnames(therapy2)<-c("LineName","Group")
# 
# # intersect(therapy2$LineName,therapy1$LineName) #they are mutually exclusive!
# #Bind them
# therapy<-rbind(therapy1,therapy2)
# #make a vector out of it.
# therapy_vector<-therapy$Group
# names(therapy_vector)<-therapy$LineName
# 
# therapy_vector_group<-therapy_vector[ptData1$LineName]
# ptData1[,therapy_group:=therapy_vector_group]




#Make sure everything is categorized
table(ptData1$FirstLineTherapyGroup, useNA = "ifany") #294 NAs
# Use my old data
#see if there are any that were not observed in the new grouping
my.dictionary<-readRDS("../../EDA_V9/1Lgroup_dictionary_new_all.rds")
table(!(my.dictionary$FirstLineTherapy %in% ptData1$LineName)) #There are lots not in there.

#Let's switch
ptData1[,FirstLineTherapyGroup_old_and_new:=FirstLineTherapyGroup]
this_group<-my.dictionary[,final]
names(this_group)<-my.dictionary$FirstLineTherapy
ptData1[is.na(FirstLineTherapyGroup),FirstLineTherapyGroup_old_and_new:=this_group[LineName]]
#Make sure verything is categorized
table(ptData1$FirstLineTherapyGroup_old_and_new, useNA = "ifany") #Lots of NA

source("../../EDA_V9/wait_trt_dist_plot_facet.R")
plot_out<-wait_trt_dist_plot_facet(
    dat=ptData1[,.(cohort,FirstLineTherapyGroup_old_and_new,sw)],
    cohort="cohort",
    geom_text_location_prop=0.7,
    this.fontsize=3,
    weight = "sw",
    trim.percent = 5, #must be greater than or equal to 1%. Any treatment with at least 5% of population will be plotted
    therapy_col = "FirstLineTherapyGroup_old_and_new"
  )

```


```{r fig.show="hold", out.width='100%'}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-primary-1L
#| fig-cap: Figure XX Distribution of 1L therapy received by patients stratified by cohort with IPW applied. Only the treatments that compose more than 5% of either of the two cohorts is shown in the plot.



plot_out
```

For those who waited for the valid test result, most people received chemotherapy, followed by chemoimmunotherapy, and immunotherapy alone. And surprisingly, many didn't receive any therapy. The 5th most observed therapy was target therapy.

For those who proceeded to 1L therapy without waiting for valid test result, chemotherapy was the most common, followed by chemoimmunotherapy, and immunotherapy. 

\

# Secondary analysis

We repeat the primary analysis except with changed inclusion criteria, where the patients have upto 4 weeks after advanced diagnosis date to observe the baseline covariates.



```{r secondary-analysis}
#| eval: true
#| echo: false

ptData2<-
  merge(ptData2,
        Albumin$week4[,.(PatientID,TestResultCleaned)],
        all.x = T)
setnames(ptData2,"TestResultCleaned","albumin")
ptData2[,albumin_binary:=ifelse(albumin<=35,"low","normal")]
ptData2[,albumin_binary:=factor(albumin_binary,levels = c("normal","low"), labels = c("normal","low"))]

ptData2<-
  merge(ptData2,
        ECOG$week4[,.(PatientID,EcogValue)],
        all.x = T)
setnames(ptData2,"EcogValue","ECOG")


ptData2<-
  merge(ptData2,
        weight_change$week4[,.(PatientID,first_date_observe_losing_10lbs)],
        all.x = T)
ptData2[,lost_10lbs:="No"]
ptData2[!is.na(first_date_observe_losing_10lbs),lost_10lbs:="Yes"]
ptData2[,lost_10lbs:=factor(lost_10lbs,levels=c("No","Yes"), labels=c("No","Yes"))]
ptData2[,first_date_observe_losing_10lbs:=NULL]

#Time 0 is 5th week
ptData2[,time0:=NULL]
ptData2[,time0:=as.IDate(as.Date(AdvancedDiagnosisDate)+weeks(4)+days(1))]


#Now treatment assignment.
ptData2[,cohort:="wait"]
ptData2[advDiag_to_1L_week<advDiag_to_valid_test_week,cohort:="no_wait"]
ptData2[,cohort:=factor(cohort,levels=c("wait","no_wait"), labels=c("wait","no_wait"))]



#generate yearly count of advanced diagnosis date
ptData2[,AdvancedDiagnosis_year:=year(AdvancedDiagnosisDate)]
ptData2[,AdvancedDiagnosis_year_factor:=factor(AdvancedDiagnosis_year,levels = sort(unique(AdvancedDiagnosis_year), decreasing = F), labels = sort(unique(AdvancedDiagnosis_year), decreasing = F))]

# ptData2[,min(AdvancedDiagnosis_year)] #2011
ptData2[,AdvancedDiagnosis_year_rescale:=AdvancedDiagnosis_year-min(AdvancedDiagnosis_year)] #make first one 0.

```


\

## Descriptive summary


Summary table:

```{r secondary-descriptive-table}
#| eval: true


covars<-list(
  "albumin_binary" = "Albumin (<= 35 g/L vs. > 35g/L)",
  "lost_10lbs" = "Lost >= 10lbs",
  "ECOG"="ECOG",
  "SmokingStatus"="SmokingStatus",
  "Histology"="Histology",
  "Gender"="Gender",
  "RaceEthnicity"="Race/Ethnicity",
  "age_at_advDiag"="Approximate age at Advanced Diagnosis",
  "AdvancedDiagnosis_year_rescale"="Advanced Diagnosis (year)"
)  
  secondary_decriptive_table<-
    tbl_summary(
      data=ptData2[,.SD,.SDcols=c("cohort",names(covars))],
      by="cohort",
      label=covars,
      missing = "ifany",
      type = list(where(is.numeric) ~ "continuous2"),  # Use "continuous2" for multiple statistics
      statistic = list(
        all_continuous() ~ c("{mean} ({sd})", "{median} ({p25}, {p75})")  # Show both Mean (SD) and Median (Q1, Q3)
      )
    )

```





```{r}
#| echo: false
#| eval: true
#| warning: false
#| label: tbl-secondary-dscriptive


secondary_decriptive_table |> 
  as_gt() |> 
  #  tab_header(
  #   title = md("What's the difference between this title and caption?"),
  #   subtitle = md("`gtcars` is an R dataset")
  # ) |>
  tab_caption(caption = md("Table XX. Summary of Patient Characteristics at Baseline, without IPW weighting.")) |> 
  as_raw_html() 
```


As in the case if the primary analysis, there are hardly any hispanic/latino. They are fused with Other category.



```{r secondary-exclude-pt-for-positivity}
#| echo: false
#| eval: true


#Make HispLatino -> Other 

ptData2[RaceEthnicity=="HispLatino",RaceEthnicity:="Other"]
```



\




## Inverse probability weight


Generate IPW, and re-construct the table.

```{r seocndary-IPW}
#| eval: true
#| echo: false
#| message: false
#| include: false

#Use logistic regression
covar_cols<-c(
  "albumin_binary",
  "lost_10lbs" ,
  "ECOG",
  "SmokingStatus",
  "Histology",
  "Gender",
  "RaceEthnicity",
  "age_at_advDiag",
  "AdvancedDiagnosis_year_rescale"
)  


this.formula<-formula(paste("cohort~", paste(covar_cols,collapse = "+"), sep=""))
logit.fit<-glm(this.formula,data=ptData2,family="binomial")

# logit.fit<-glm(cohort~albumin_binary+lost_10lbs+ECOG+SmokingStatus+Histology+Gender+RaceEthnicity+age_at_advDiag+AdvancedDiagnosis_year,data=ptData2,family="binomial")


#propensity scores
ptData2[,ps:=logit.fit$fitted.values]

#generate weight
ptData2[,w:=ifelse(cohort=="wait",1/ps, 1/(1-ps))]

#Propensity score plot
# secondary_ps_plot<-ggplot(ptData2, aes(x=ps,fill=cohort))+
#   geom_density(alpha=0.2)+
#   theme_minimal()
# secondary_ps_plot #seem like there is a good overlap... Maybe.
#Check the summary of ps by cohort
ptData2[cohort=="wait",summary(ps)]
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#0.03386 0.09165 0.11496 0.12160 0.14436 0.32224 
ptData2[cohort=="no_wait",summary(ps)]
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#0.04707 0.10471 0.12927 0.13776 0.16543 0.38700
#Really good overlap.



#generate stabilized weights, in case there are extreme weights
prop_no_wait<-mean(ptData2$cohort=="no_wait")
ptData2[,sw:=ifelse(cohort=="no_wait",prop_no_wait/ps, (1-prop_no_wait)/(1-ps))]

#Check extreme weights
ptData2[cohort=="wait",summary(sw)]
ptData2[cohort=="no_wait",summary(sw)]
#Good. No weights exceeding 3.



```




```{r code-secondary-both-tables}
#| echo: false
#| eval: true
#| include: false




#before weight
library(survey)
library(tableone)



before<-svydesign(ids= ~ 0, data=ptData2) 
before_tab<- svyCreateTableOne(vars=covar_cols, strata = "cohort",data = before, test = FALSE)
# print(before_tab, smd = TRUE)
# print(before_tab, showAllLevels = TRUE, smd = TRUE)


before_tab_rownames<-rownames(print(before_tab, showAllLevels = TRUE,smd=T))
before_tab<-as.data.frame(print(before_tab,showAllLevels = TRUE, smd=T))
before_tab$this.rownames<-before_tab_rownames



#After weight


after<-svydesign(ids= ~ 0, data=ptData2,weights=ptData2$sw)
after_tab<- svyCreateTableOne(vars=covar_cols, strata = "cohort",data = after, test = FALSE)

after_tab_rownames<-rownames(print(after_tab, showAllLevels = TRUE,smd=T))
after_tab<-as.data.frame(print(after_tab, showAllLevels = TRUE,smd=T))
colnames(after_tab)<-paste(colnames(after_tab),"sw",sep = "_")

#merge the two data sets. Can I just bind them?
# sum(before_tab$this.rownames!=after_tab_rownames) #they are same order. Just cbind them.
# rownames(before_tab)
temp<-cbind(before_tab[,c("this.rownames",colnames(before_tab)[colnames(before_tab)!="this.rownames"])],
            after_tab[,c( "wait_sw","no_wait_sw","SMD_sw")])
rownames(temp)<-NULL


#Change row names to print
pretty_name<-do.call(c,covars)[covar_cols]
new_rownames<-
  sapply(temp$this.rownames,function(x){
    
    if(x==""|x=="n"){
      return(x)
    }else{
      
      #logical for index which name to give
      this.index.logical<-
        sapply(names(pretty_name),function(y){
          stringr::str_detect(string = x,
                              pattern = y) 
        })
      
      index<-which(this.index.logical)
      
      #Replace the raw name with pretty name
      newname<-
        stringr::str_replace(string=x, pattern=names(pretty_name)[index], replacement=pretty_name[index])
      return(newname)
    }
    
  })

temp$this.rownames<-new_rownames


```


```{r tbl-secondary-dscriptive-both}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| tbl-cap: Summary of Patient Characteristics at Baseline.


# build gt table
gt(temp) |> 
  # First two columns stay as-is:
  cols_label(
    this.rownames = "Variable",
    level         = "Level",
    # now override the 6 numeric columns’ *display* labels:
    wait       = "Wait",
    no_wait    = "No wait",
    SMD        = "SMD",
    wait_sw    = "Wait",
    no_wait_sw = "No wait",
    SMD_sw     = "SMD"
  ) |> 
  # create the two spanners:
  tab_spanner(
    label   = "No IPW",
    columns = c(wait, no_wait, SMD)
  ) |> 
  tab_spanner(
    label   = "IPW",
    columns = c(wait_sw, no_wait_sw, SMD_sw)
  ) |> 
  # optional styling:
  opt_align_table_header("left") |> 
  tab_caption(caption = md("Table XX. Summary of Patient Characteristics at Baseline, without IPW weighting.")) |> 
  as_raw_html()  #this will display the table on

```


Without IPW, albumin and diagnosis year are are imbalanced. However, IPW balanced them out.


\


## KM curve



```{r fig.show="hold", out.width='49%',  fig.height=5}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-secondary-KMplot
#| fig-cap: Figure XX. Kaplan-Meier (KM curve demonstrating survival probability over time. A) original data, B) IPW applied population. 
# #| fig-subcap: ["48 patients used for original body compositions", "46 patients used for composite body compositions"]
# #| layout-ncol: 2

# #| fig-subcap: 
# #|     - 48 patients used for original body compositions
# #|     - 46 patients used for composite body compositions


#Kaplan meier curve
#display that works for HTML.



#generate time variable
ptData2[,time0_to_death_weeks:=as.numeric(interval(time0,DateOfDeath),"weeks")]
no_ipw<-return_km_plot(data = ptData2,xlab_name = "Time (week)", time="time0_to_death_weeks",covar = "cohort",status ="DeathInd" ) |> suppressWarnings() #Without suppressWarnings(), I still see warning printed out in html file, even with warning: false.

yes_ipw<-return_km_plot(data = ptData2,xlab_name = "Time (week)", time="time0_to_death_weeks",covar = "cohort",status ="DeathInd" ,weight = T,weight_var = "sw") |> suppressWarnings()


#Remove legend
# Assuming your plot is saved as 'x'
# and add title
no_ipw$plot <- no_ipw$plot + 
  # theme(legend.position = "none") + 
  ggtitle("A) Without IPW")
yes_ipw$plot <- yes_ipw$plot + 
  # theme(legend.position = "none")+ 
  ggtitle("B) IPW")


#subfigure a
no_ipw

#subfigure b
yes_ipw



```


```{r secondary-median-surv}
#| echo: false
#| eval: true


#Just calculate median survival 

median_summary_noIPW<-kmplot_median_CI(survfit(Surv(time0_to_death_weeks,DeathInd)~cohort, data = ptData2), digits=2)
median_summary_yesIPW<-kmplot_median_CI(survfit(Surv(time0_to_death_weeks,DeathInd)~cohort, data = ptData2, weights = ptData2$sw), digits=2)

```


Without IPW, the median survival of "wait" and "no wait" cohorts were `r median_summary_noIPW$"cohort=wait"`, and `r median_summary_noIPW$"cohort=no_wait"`, respectively. Patients who waited lived substantially longer.With IPW, however, the median survival decreased slightly in wait cohort (`r median_summary_yesIPW$"cohort=wait"`), and increased quite a bit in no wait cohort (`r median_summary_yesIPW$"cohort=no_wait"`). Therefore, the difference in the median survival between the two cohorts is attenuated with IPW.


## Effect of 1L before test result become available

```{r secondary-coxph}
#| echo: false
#| eval: true


#Crude fit 

fit2<-coxph(Surv(time0_to_death_weeks,DeathInd)~cohort, data = ptData2, weights=ptData2$sw, robust = T, x=TRUE)
summary_fit2<-coxph.ci.coef(fit1,x.name="cohortno_wait",digits=3,return_num_binary_x=FALSE,robust=TRUE)
summary_fit2<-summary_fit2["HR(95%CI)"]

```

Using the IPW, we fitted a Cox PH model. From this, we conclude that the hazard rate (95% confidence interval) of death by proceeding to 1L before receiving valid test result is `r summary_fit2`. Since the null value 1 is included in the 95% CI, we conclude that proceeding to 1L therapy right away did not produce much difference. 


\


## 1L therapy distribution

```{r secondary-1L-code}
#| echo: false
#| eval: true
#| include: false

#Get the most updated classification Wally did for us


#Make sure everything is categorized
table(ptData2$FirstLineTherapyGroup, useNA = "ifany") #1063 NAs
# Use my old data
#see if there are any that were not observed in the new grouping
my.dictionary<-readRDS("../../EDA_V9/1Lgroup_dictionary_new_all.rds")

#Let's switch
ptData2[,FirstLineTherapyGroup_old_and_new:=FirstLineTherapyGroup]
this_group<-my.dictionary[,final]
names(this_group)<-my.dictionary$FirstLineTherapy
ptData2[is.na(FirstLineTherapyGroup),FirstLineTherapyGroup_old_and_new:=this_group[LineName]]
#Make sure verything is categorized
table(ptData2$FirstLineTherapyGroup_old_and_new, useNA = "ifany") #Lots of NA


plot_out<-wait_trt_dist_plot_facet(
    dat=ptData2[,.(cohort,FirstLineTherapyGroup_old_and_new,sw)],
    cohort="cohort",
    geom_text_location_prop=0.7,
    this.fontsize=3,
    weight = "sw",
    trim.percent = 5, #must be greater than or equal to 1%. Any treatment with at least 5% of population will be plotted
    therapy_col = "FirstLineTherapyGroup_old_and_new"
  )

```


```{r fig.show="hold", out.width='100%'}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-secondary-1L
#| fig-cap: Figure XX Distribution of 1L therapy received by patients stratified by cohort with IPW applied. Only the treatments that compose more than 5% of either of the two cohorts is shown in the plot.



plot_out
```

For those who waited for the valid test result, the 1L therapy distribution is similar to primary analysis, except that more target therapy was observed than no therapy.

For those who proceeded to 1L therapy without waiting for valid test result, similar result was observed as in the primary analysis, but now we have a few patients who seem to have received target therapy. This is due to the fact that chemotherapy was the most common, followed by chemoimmunotherapy, no therapy.


```{r secondary-target-investigate}
#| eval: false
#| echo: false


#Investigate what's going on
ptData2[cohort=="no_wait" & therapy_group=="Target",.N] #44 people 
ptData2[,valid_test_date:=pmin(valid_ResultDate__on_after_time0_NoPDL1,earliest_valid_ResultDate__on_after_time0_PDL1,na.rm = T)]

tmp<-ptData2[cohort=="no_wait" & therapy_group=="Target",.(PatientID,AdvancedDiagnosisDate,valid_test_date, StartDate)]

investigate_pt<-tmp[,PatientID]
for(pt in investigate_pt){
  print(
    tmp[PatientID==pt,]
  )
  
  bio_supset<-bio[PatientID==pt,]
  setkeyv(bio_supset,cols=c("SpecimenCollectedDate","SpecimenReceivedDate","ResultDate"))
  
  #Just show the ones missing result date or result is <= 1L date
  therapy_date<-ptData1[PatientID==pt,StartDate]
  bio_supset<-bio_supset[ResultDate<=therapy_date | is.na(ResultDate),]
  
  
  print(
    bio_supset[,.(PatientID,BiomarkerName,CellType, SpecimenCollectedDate, SpecimenReceivedDate, ResultDate,                   BiomarkerStatus,PercentStaining)]
  )
  readline("[enter]:")
}



#F05CF759A3240
#F61A0D82CC540 <- this patient received ALK positive therapy. It's result came out 7 days after 1L initation date. So I think the result date is wrong lol
#All other people are not present in the biomarker dataset or missing result Date
pt<-"F05CF759A3240"

bio_supset<-bio[PatientID==pt,]
setkeyv(bio_supset,cols=c("SpecimenCollectedDate","SpecimenReceivedDate","ResultDate"))
therapy_date<-ptData1[PatientID==pt,StartDate]
bio_supset<-bio_supset[ResultDate<=therapy_date | is.na(ResultDate),]

ptData[PatientID==pt, .(observe_valid__before_time0_NoPDL1,observe_valid__before_time0_PDL1) ]
#   observe_valid__before_time0_NoPDL1 observe_valid__before_time0_PDL1
#                               <lgcl>                           <lgcl>
#1:                              FALSE                            FALSE

tmp[PatientID==pt,]
#       PatientID AdvancedDiagnosisDate valid_test_date  StartDate
#          <char>                <IDat>          <IDat>     <IDat>
#1: F05CF759A3240            2020-06-23      2020-07-03 2020-06-26

bio_supset[,.(PatientID,BiomarkerName,CellType, SpecimenCollectedDate, SpecimenReceivedDate, ResultDate,                   BiomarkerStatus,PercentStaining)]
#       PatientID BiomarkerName CellType SpecimenCollectedDate SpecimenReceivedDate ResultDate           BiomarkerStatus PercentStaining
#          <char>        <char>   <char>                <IDat>               <IDat>     <IDat>                    <char>          <char>
#1: F05CF759A3240          EGFR                     2018-04-25           2018-05-09 2018-05-14         Mutation negative                
#2: F05CF759A3240           ALK                     2018-04-25           2018-05-09 2018-05-15     Rearrangement present                
#3: F05CF759A3240          ROS1                     2018-04-25           2018-05-09 2018-05-15 Rearrangement not present                

```

\

# Subgroup analysis

Wally suggested that I do this for subgroups

- ECOG 0-2 
- ECOG 3-4 
- Albumin $\leq 35$ 
- Albumin $> 35$ g/L 
- Asian
- Female
- Male
- No history of smoking 
- History of smoking

```{r subgroup-primary-code}
#| eval: true
#| include: false

primary_subgroups<-list(
  "All"=ptData1,
  "ECOG (0-2)"=ptData1[ECOG<3,][,ECOG:=NULL],
  "ECOG (3-4)"=ptData1[ECOG>=3,][,ECOG:=NULL],
  "Albumin (low)"=ptData1[albumin_binary=="low", ][,albumin_binary:=NULL],
  "Albumin (normal)"=ptData1[albumin_binary=="normal", ][,albumin_binary:=NULL],
  "Asian"=ptData1[RaceEthnicity=="AsianNonHisp", ][,RaceEthnicity:=NULL],
  "Female"=ptData1[Gender=="F",][,Gender:=NULL],
  "Male"=ptData1[Gender=="M",][,Gender:=NULL],
  "Smoked"=ptData1[SmokingStatus=="History of smoking",][,SmokingStatus:=NULL],
  "Never Smoked"=ptData1[SmokingStatus=="No history of smoking",][,SmokingStatus:=NULL]
)



source("../whole_analysis_func.R")

subgroup_analyses_primary<-lapply(primary_subgroups,whole_analysis_func)
```




```{r subgroup-secondary-code}
#| eval: true
#| include: false

secondary_subgroups<-list(
  "All"=ptData2,
  "ECOG (0-2)"=ptData2[ECOG<3,][,ECOG:=NULL],
  "ECOG (3-4)"=ptData2[ECOG>=3,][,ECOG:=NULL],
  "Albumin (low)"=ptData2[albumin_binary=="low", ][,albumin_binary:=NULL],
  "Albumin (normal)"=ptData2[albumin_binary=="normal", ][,albumin_binary:=NULL],
  "Asian"=ptData2[RaceEthnicity=="AsianNonHisp", ][,RaceEthnicity:=NULL],
  "Female"=ptData2[Gender=="F",][,Gender:=NULL],
  "Male"=ptData2[Gender=="M",][,Gender:=NULL],
  "Smoked"=ptData2[SmokingStatus=="History of smoking",][,SmokingStatus:=NULL],
  "Never Smoked"=ptData2[SmokingStatus=="No history of smoking",][,SmokingStatus:=NULL]
)



#Check covariate overlap for positivity assumption

subgroup_analyses_secondary<-lapply(secondary_subgroups,whole_analysis_func)
```


```{r subgroup-tbl}
#| eval: true


data.table(
  "Patient Population"=names(secondary_subgroups),
  "Primary"=sapply(subgroup_analyses_primary,function(x)x$HR_95_CI["HR(95%CI)"]),
  "secondary"=sapply(subgroup_analyses_secondary,function(x)x$HR_95_CI["HR(95%CI)"])
) |> 
  kable(caption = "Table XX. Hazard ratio and 95% confidence interval of proceeding to 1L without waiting for both primary and secondary analyses.")


```


\

## Check assumptions

First, check the positivity assumption by looking at the love plot. I generated pdf files titled "primary_cov_plot.pdf" and "secondary_cov_plot.pdf"


```{r save-subgroup-love-plot}
#| eval: true
#| include: false


#Save the covariance balance plot

primary_loveplots<-lapply(subgroup_analyses_primary,function(x)x$cov_balance_plot)
secondary_loveplots<-lapply(subgroup_analyses_secondary,function(x)x$cov_balance_plot)

for(i in 1:length(primary_loveplots)){
  primary_loveplots[[i]]<- primary_loveplots[[i]]+ggtitle(names(subgroup_analyses_primary)[[i]])
  secondary_loveplots[[i]]<- secondary_loveplots[[i]]+ggtitle(names(subgroup_analyses_secondary)[[i]])

}

library(ggpubr)
#Plot 6 on each page 
n_per_page<-6
chunk_seq <- function(N, x) {
  v   <- seq_len(N)
  grp <- ceiling(seq_along(v) / x)
  split(v, grp)
}
loop_over_this<-chunk_seq(length(primary_loveplots),n_per_page)


pdf("primary_cov_plot.pdf",width=15, height=10)
for(i in 1:length(loop_over_this)){
  
  index<-loop_over_this[[i]]
  love_plots_out<-primary_loveplots[index]
  
  these_plots<-ggarrange(plotlist=love_plots_out,
                         nrow=3,
                         ncol=2,
                         common.legend = T, legend = "top")
  print(these_plots)

  
}

dev.off()



pdf("secondary_cov_plot.pdf",width=15, height=10)
for(i in 1:length(loop_over_this)){
  
  index<-loop_over_this[[i]]
  love_plots_out<-secondary_loveplots[index]
  
  these_plots<-ggarrange(plotlist=love_plots_out,
                         nrow=3,
                         ncol=2,
                         common.legend = T, legend = "top")
  print(these_plots)

  
}

dev.off()


```

Upon reviewing the love plot, we noticed that the standardized mean difference of 
Please note that the covariate balance was not achieved between the wait vs. no wait cohorts in ECOG 3-4 subgroup for the primary analysis (and barely for Asians), and Asian subgroups for secondary analysis.


We provide SMD table of ECOG 3-4 subgroup in primary analysis:


```{r tbl-subgroup-primary-ecog3-4}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| tbl-cap: Summary of Patient Characteristics at Baselien


# build gt table
gt(subgroup_analyses_primary$`ECOG (3-4)`$SMD_table) |> 
  # First two columns stay as-is:
  cols_label(
    this.rownames = "Variable",
    level         = "Level",
    # now override the 6 numeric columns’ *display* labels:
    wait       = "Wait",
    no_wait    = "No wait",
    SMD        = "SMD",
    wait_sw    = "Wait",
    no_wait_sw = "No wait",
    SMD_sw     = "SMD"
  ) |> 
  # create the two spanners:
  tab_spanner(
    label   = "No IPW",
    columns = c(wait, no_wait, SMD)
  ) |> 
  tab_spanner(
    label   = "IPW",
    columns = c(wait_sw, no_wait_sw, SMD_sw)
  ) |> 
  # optional styling:
  opt_align_table_header("left") |> 
  tab_caption(caption = md("Table XX. Summary of Patient Characteristics at Baseline, without IPW weighting.")) |> 
  as_raw_html()  #this will display the table on

```

As we can see we don't have enough sample size to make any meaningful comparison. So we should discard the result.



Below is SMD table of Asians subgroup in the secondary analysis:

```{r tbl-subgroup-secondary-Asian}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| tbl-cap: Summary of Patient Characteristics at Baselien


# build gt table
gt(subgroup_analyses_secondary$Asian$SMD_table) |> 
  # First two columns stay as-is:
  cols_label(
    this.rownames = "Variable",
    level         = "Level",
    # now override the 6 numeric columns’ *display* labels:
    wait       = "Wait",
    no_wait    = "No wait",
    SMD        = "SMD",
    wait_sw    = "Wait",
    no_wait_sw = "No wait",
    SMD_sw     = "SMD"
  ) |> 
  # create the two spanners:
  tab_spanner(
    label   = "No IPW",
    columns = c(wait, no_wait, SMD)
  ) |> 
  tab_spanner(
    label   = "IPW",
    columns = c(wait_sw, no_wait_sw, SMD_sw)
  ) |> 
  # optional styling:
  opt_align_table_header("left") |> 
  tab_caption(caption = md("Table XX. Summary of Patient Characteristics at Baseline, without IPW weighting.")) |> 
  as_raw_html()  #this will display the table on

```


For these guys, It seems like most of them didn't lost more than 10 lbs regardless of waiting or no waiting. So let's exclude this covariate. Also, we have very small sample size for NSCLC histology NOS for histology. We will group this with Squamous cell carcinoma. This grouping is based on clinical understanding that non-squamous cell carcinoma patients are observed to have targetable mutation than squamous cell carcinoma and NSCLC histology NOS.

```{r}
#| eval: false
#| include: false


tmp<-copy(secondary_subgroups$Asian)
tmp[,lost_10lbs:=NULL]
tmp[Histology=="NSCLC histology NOS",Histology:="Squamous cell carcinoma"]
rerun_second_asian<-whole_analysis_func(tmp)
rerun_second_asian$SMD_table

rerun_second_asian$HR_95_CI


```





```{r}
#| eval: false
#| include: false
subgroup_analyses_primary$`ECOG (3-4)`$SMD_table
#Did anyone lost weight in no_wait group?
ptData2[AdvancedDiagnosis_year_rescale==7, unique(AdvancedDiagnosis_year) ] #2018
#wait patients were more like early to middle 2018, 
#no wait patienst were more like late 2019. 
#Let's calculate for ECOG subgroup when I do subgroup analysis by diagnosis year.


subgroup_analyses_secondary$Asian$SMD_table #Weight loss and 
```



\


# Subgroup by year

Treatment availabilities greatly differ over time due to rapid development of treamtent for targetable mutation that happened over the time period during which the patients were collected. Thus, we desire to perform analysis over different year




```{r subgroup-diag-year}
#| eval: true
#| include: false


these_years<-unique(ptData1$AdvancedDiagnosis_year) |> sort()
subgroup_diag_year<-
lapply(these_years,function(this_year){
  ptData1[AdvancedDiagnosis_year==this_year,][,AdvancedDiagnosis_year_rescale:=NULL]
})

primary<-lapply(subgroup_diag_year,whole_analysis_func)

subgroup_diag_year<-
lapply(these_years,function(this_year){
  ptData2[AdvancedDiagnosis_year==this_year,][,AdvancedDiagnosis_year_rescale:=NULL]
})
secondary<-lapply(subgroup_diag_year,whole_analysis_func)


```





```{r fig.show="hold", out.width='49%',  fig.height=5}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-subgroup-by_year
#| fig-cap: Figure XX. HR(95%CI) of those who don't wait for test result prior to initiating 1L therapy. A) primary analysis, B) Isecondary analysis. 




tmptmp<-
data.table(
  "Advanced diagnosis year"=these_years,
  "Primary"=sapply(primary,function(x)x$HR_95_CI["HR(95%CI)"]),
  "secondary"=sapply(secondary,function(x)x$HR_95_CI["HR(95%CI)"])
) 



# tmptmp|> 
#   kable(caption = "Table XX. Hazard ratio and 95% confidence interval by advanced diagnosis year")


#Plot instead
primary_plot<-
sapply(tmptmp$Primary,function(x){
  all_numbers<-stringr::str_extract_all(x,"-?\\d*\\.?\\d+([eE][+-]?\\d+)?")[[1]]
  all_numbers<-as.numeric(all_numbers)
  names(all_numbers)<-c("est","lwr","upr")
  all_numbers
})
primary_plot<-t(primary_plot)

primary_plot<-
data.table(
  year=tmptmp$`Advanced diagnosis year`,
  primary_plot
)



secondary_plot<-
sapply(tmptmp$secondary,function(x){
  all_numbers<-stringr::str_extract_all(x,"-?\\d*\\.?\\d+([eE][+-]?\\d+)?")[[1]]
  all_numbers<-as.numeric(all_numbers)
  names(all_numbers)<-c("est","lwr","upr")
  all_numbers
})
secondary_plot<-t(secondary_plot)

secondary_plot<-
data.table(
  year=tmptmp$`Advanced diagnosis year`,
  secondary_plot
)



#Primary analysis
ggplot(primary_plot, aes(x=factor(year), y=est)) + 
  geom_errorbar(aes(ymin=lwr, ymax=upr), width=.1) +
  geom_line() +
  geom_point()+
  geom_hline(yintercept = 1,color="red")  +
  ylab("Survival rate (95% CI)")+
  xlab("Diagnosis year")+
  theme_minimal() + 
  ggtitle("A) Primary analysis")


#Secondary analysis
ggplot(secondary_plot, aes(x=factor(year), y=est)) + 
  geom_errorbar(aes(ymin=lwr, ymax=upr), width=.1) +
  geom_line() +
  geom_point()+
  geom_hline(yintercept = 1,color="red")  +
  ylab("Survival rate (95% CI)")+
  xlab("Diagnosis year")+
  theme_minimal() + 
  ggtitle("A) Secondary analysis")

```

I can't see much changes over the year.

